<html><body><script type='text/javascript'>function ControlBuilder(styles){this.styles=styles.addLookups("name");this.fontHeightInPixelsBase=10;this.sizeBase=new Coords(200,150,1);this.sizeMultiplier=new Coords();}{ControlBuilder.prototype.choice=function (universe,size,message,optionNames,optionFunctions){if(size==null){size=universe.display.sizeDefault;}var sizeMultiplier=this.sizeMultiplier.overwriteWith(size).divide(this.sizeBase);var fontHeight=this.fontHeightInPixelsBase*sizeMultiplier.y;var numberOfLinesInMessageMinusOne=message.split("\n").length-1;var labelSize=new Coords(200,fontHeight*numberOfLinesInMessageMinusOne).multiply(sizeMultiplier);var labelPos=new Coords(100,65 -fontHeight*(numberOfLinesInMessageMinusOne/4),).multiply(sizeMultiplier);var labelMessage=new ControlLabel("labelMessage",labelPos,labelSize,true,message,fontHeight);var childControls=[labelMessage];var numberOfOptions=optionNames.length;var buttonWidth=55;var buttonSize=new Coords(buttonWidth,fontHeight).multiply(sizeMultiplier);var spaceBetweenButtons=5;var buttonMarginLeftRight=(this.sizeBase.x-(buttonWidth*numberOfOptions)-(spaceBetweenButtons*(numberOfOptions-1)))/2;for(var i=0;i<numberOfOptions;i++){var button=new ControlButton("buttonOption"+i,new Coords(buttonMarginLeftRight+i*(buttonWidth+spaceBetweenButtons),100
).multiply(sizeMultiplier),buttonSize,optionNames[i],this.fontHeightInPixelsBase*sizeMultiplier.y,true,true,optionFunctions[i],universe);childControls.push(button);}var containerSizeScaled=size.clone().clearZ();var display=universe.display;var displaySize=display.sizeDefault.clone().clearZ();var containerPosScaled=displaySize.clone().subtract(containerSizeScaled).half();var returnValue=new ControlContainer("containerChoice",containerPosScaled,containerSizeScaled,childControls);return returnValue;};ControlBuilder.prototype.choiceList=function (universe,size,message,options,bindingForOptionText,buttonSelectText,select){var marginWidth=10;var marginSize=new Coords(1,1).multiplyScalar(marginWidth);var fontHeight=20;var labelSize=new Coords(size.x-marginSize.x*2,fontHeight);var buttonSize=new Coords(labelSize.x,fontHeight*2);var listSize=new Coords(labelSize.x,size.y-labelSize.y-buttonSize.y-marginSize.y*4
);var listOptions=new ControlList("listOptions",new Coords(marginSize.x,labelSize.y+marginSize.y*2),listSize,options,bindingForOptionText,fontHeight,null,null);var returnValue=new ControlContainer("containerChoice",Coords.Instances().Zeroes,size,[new ControlLabel("labelMessage",new Coords(size.x/2,marginSize.y+fontHeight/2),labelSize,true,message,fontHeight),listOptions,new ControlButton("buttonSelect",new Coords(marginSize.x,size.y-marginSize.y-buttonSize.y),buttonSize,buttonSelectText,fontHeight,true,true,function click(universe){var itemSelected=listOptions.itemSelected();if(itemSelected!=null){select(universe,itemSelected);}},universe,false),]);return returnValue;};ControlBuilder.prototype.configure=function (universe,size){if(size==null){size=universe.display.sizeDefault;}var sizeMultiplier=this.sizeMultiplier.overwriteWith(size).divide(this.sizeBase);var returnValue=new ControlContainer("containerConfigure",new Coords(0,0).multiply(sizeMultiplier),new Coords(200,150).multiply(sizeMultiplier),[new ControlButton("buttonSave",new Coords(30,15).multiply(sizeMultiplier),new Coords(65,25).multiply(sizeMultiplier),"Save",this.fontHeightInPixelsBase*sizeMultiplier.y,true,true,function click(universe){var venueNext=new VenueControls(universe.controlBuilder.worldSave(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},universe),new ControlButton("buttonLoad",new Coords(105,15).multiply(sizeMultiplier),new Coords(65,25).multiply(sizeMultiplier),"Load",this.fontHeightInPixelsBase*sizeMultiplier.y,true,true,function click(universe){var venueNext=new VenueControls(universe.controlBuilder.worldLoad(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},universe),new ControlLabel("labelMusicVolume",new Coords(30,50).multiply(sizeMultiplier),new Coords(75,25).multiply(sizeMultiplier),false,"Music:",this.fontHeightInPixelsBase*sizeMultiplier.y),new ControlSelect("selectMusicVolume",new Coords(65,45).multiply(sizeMultiplier),new Coords(30,25).multiply(sizeMultiplier),new DataBinding(universe.soundHelper,"musicVolume"),SoundHelper.controlSelectOptionsVolume(),new DataBinding(null,"value"),new DataBinding(null,"text"),this.fontHeightInPixelsBase*sizeMultiplier.y),new ControlLabel("labelSoundVolume",new Coords(105,50).multiply(sizeMultiplier),new Coords(75,25).multiply(sizeMultiplier),false,"Sound:",this.fontHeightInPixelsBase*sizeMultiplier.y),new ControlSelect("selectSoundVolume",new Coords(140,45).multiply(sizeMultiplier),new Coords(30,25).multiply(sizeMultiplier),new DataBinding(universe.soundHelper,"soundVolume"),SoundHelper.controlSelectOptionsVolume(),new DataBinding(null,"value"),new DataBinding(null,"text"),this.fontHeightInPixelsBase*sizeMultiplier.y),new ControlLabel("labelDisplaySize",new Coords(30,80).multiply(sizeMultiplier),new Coords(75,25).multiply(sizeMultiplier),false,"Display:",this.fontHeightInPixelsBase*sizeMultiplier.y),new ControlSelect("selectDisplaySize",new Coords(70,75).multiply(sizeMultiplier),new Coords(60,25).multiply(sizeMultiplier),universe.display.sizeInPixels,universe.display.sizesAvailable,new DataBinding(),new DataBinding(null,"toStringXY()"),this.fontHeightInPixelsBase*sizeMultiplier.y),new ControlButton("buttonDisplaySizeChange",new Coords(140,75).multiply(sizeMultiplier),new Coords(30,25).multiply(sizeMultiplier),"Change",this.fontHeightInPixelsBase*sizeMultiplier.y,true,true,function click(universe){var controlRoot=universe.venueCurrent.controlRoot;var selectDisplaySize=controlRoot.children["selectDisplaySize"];var displaySizeSpecified=selectDisplaySize.optionSelected().value;var display=universe.display;display.sizeInPixels=displaySizeSpecified;display.initialize(universe);var venueNext=new VenueControls(universe.controlBuilder.configure(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},universe),new ControlButton("buttonResume",new Coords(30,105).multiply(sizeMultiplier),new Coords(65,25).multiply(sizeMultiplier),"Resume",this.fontHeightInPixelsBase*sizeMultiplier.y,true,true,function click(universe){var world=universe.world;var venueNext=new VenueWorld(world);venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},universe),new ControlButton("buttonQuit",new Coords(105,105).multiply(sizeMultiplier),new Coords(65,25).multiply(sizeMultiplier),"Quit",this.fontHeightInPixelsBase*sizeMultiplier.y,true,true,function click(universe){var controlConfirm=universe.controlBuilder.confirm(universe,size,"Are you sure you want to quit?",function confirm(universe){universe.reset();var venueNext=new VenueControls(universe.controlBuilder.title(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},function cancel(universe){var venueNext=new VenueControls(universe.controlBuilder.configure(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;});var venueNext=new VenueControls(controlConfirm);venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},universe),]);return returnValue;};ControlBuilder.prototype.confirm=function (universe,size,message,confirm,cancel){return this.choice(universe,size,message,["Confirm","Cancel"],[confirm,cancel]);};ControlBuilder.prototype.message=function (universe,size,message,acknowledge){return this.choice(universe,size,message,["Acknowledge"],[acknowledge]);};ControlBuilder.prototype.profileDetail=function (universe,size){if(size==null){size=universe.display.sizeDefault;}var sizeMultiplier=this.sizeMultiplier.overwriteWith(size).divide(this.sizeBase);var returnValue=new ControlContainer("containerProfileDetail",new Coords(0,0).multiply(sizeMultiplier),new Coords(200,150).multiply(sizeMultiplier),[new ControlLabel("labelProfileName",new Coords(100,25).multiply(sizeMultiplier),new Coords(120,25).multiply(sizeMultiplier),true,"Profile: "+universe.profile.name,this.fontHeightInPixelsBase*sizeMultiplier.y),new ControlLabel("labelSelectAWorld",new Coords(100,40).multiply(sizeMultiplier),new Coords(100,25).multiply(sizeMultiplier),true,"Select a World:",this.fontHeightInPixelsBase*sizeMultiplier.y),new ControlList("listWorlds",new Coords(25,50).multiply(sizeMultiplier),new Coords(150,50).multiply(sizeMultiplier),new DataBinding(universe.profile.worlds,null),new DataBinding(null,"name"),this.fontHeightInPixelsBase*sizeMultiplier.y),new ControlButton("buttonNew",new Coords(50,110).multiply(sizeMultiplier),new Coords(45,25).multiply(sizeMultiplier),"New",this.fontHeightInPixelsBase*sizeMultiplier.y,true,true,function click(universe){var world=World.new (universe);var profile=universe.profile;profile.worlds.push(world);universe.profileHelper.profileSave(profile);universe.world=world;var venueNext=new VenueControls(universe.controlBuilder.worldDetail(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},universe),new ControlButton("buttonSelect",new Coords(105,110).multiply(sizeMultiplier),new Coords(45,25).multiply(sizeMultiplier),"Select",this.fontHeightInPixelsBase*sizeMultiplier.y,true,new DataBinding(function (){var controlRoot=universe.venueCurrent.controlRoot;if(controlRoot==null){return false;}else {return controlRoot.children["listWorlds"].itemSelected()!=null;}},"call()"),function click(universe){var listWorlds=this.parent.children["listWorlds"];var worldSelected=listWorlds.itemSelected();if(worldSelected!=null){universe.world=worldSelected;var venueNext=new VenueControls(universe.controlBuilder.worldDetail(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;}},universe),new ControlButton("buttonBack",new Coords(10,10).multiply(sizeMultiplier),new Coords(15,15).multiply(sizeMultiplier),"<",this.fontHeightInPixelsBase*sizeMultiplier.y,true,true,function click(universe){var venueNext=new VenueControls(universe.controlBuilder.profileSelect(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},universe),new ControlButton("buttonDelete",new Coords(180,10).multiply(sizeMultiplier),new Coords(15,15).multiply(sizeMultiplier),"x",this.fontHeightInPixelsBase*sizeMultiplier.y,true,true,function click(universe){var profile=universe.profile;var controlConfirm=universe.controlBuilder.confirm(universe,size,"Delete profile \""+profile.name+"\"?",function confirm(universe){var profile=universe.profile;universe.profileHelper.profileDelete(profile);var venueNext=new VenueControls(universe.controlBuilder.profileSelect(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},function cancel(universe){var venueNext=new VenueControls(universe.controlBuilder.profileDetail(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;});var venueNext=new VenueControls(controlConfirm);venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},universe),]);return returnValue;};ControlBuilder.prototype.profileNew=function (universe,size){if(size==null){size=universe.display.sizeDefault;}var sizeMultiplier=this.sizeMultiplier.overwriteWith(size).divide(this.sizeBase);return new ControlContainer("containerProfileNew",new Coords(0,0).multiply(sizeMultiplier),new Coords(200,150).multiply(sizeMultiplier),[new ControlLabel("labelName",new Coords(100,40).multiply(sizeMultiplier),new Coords(100,25).multiply(sizeMultiplier),true,"Profile Name:",this.fontHeightInPixelsBase*sizeMultiplier.y),new ControlTextBox("textBoxName",new Coords(50,50).multiply(sizeMultiplier),new Coords(100,25).multiply(sizeMultiplier),"",this.fontHeightInPixelsBase*sizeMultiplier.y),new ControlButton("buttonCreate",new Coords(50,80).multiply(sizeMultiplier),new Coords(45,25).multiply(sizeMultiplier),"Create",this.fontHeightInPixelsBase*sizeMultiplier.y,true,new DataBinding(function (){var controlRoot=universe.venueCurrent.controlRoot;if(controlRoot==null){return false;}else {return controlRoot.children["textBoxName"].text().length>0;}},"call()"),function click(universe){var textBoxName=this.parent.children["textBoxName"];var profileName=textBoxName.text();if(profileName==""){return ;}var profile=new Profile(profileName,[]);universe.profileHelper.profileAdd(profile);universe.profile=profile;var venueNext=new VenueControls(universe.controlBuilder.profileDetail(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},universe),new ControlButton("buttonCancel",new Coords(105,80).multiply(sizeMultiplier),new Coords(45,25).multiply(sizeMultiplier),"Cancel",this.fontHeightInPixelsBase*sizeMultiplier.y,true,true,function click(universe){var venueNext=new VenueControls(universe.controlBuilder.profileSelect(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},universe),]);};ControlBuilder.prototype.profileSelect=function (universe,size){if(size==null){size=universe.display.sizeDefault;}var sizeMultiplier=this.sizeMultiplier.overwriteWith(size).divide(this.sizeBase);var profiles=universe.profileHelper.profiles();var returnValue=new ControlContainer("containerProfileSelect",new Coords(0,0).multiply(sizeMultiplier),new Coords(200,150).multiply(sizeMultiplier),[new ControlLabel("labelSelectAProfile",new Coords(100,40).multiply(sizeMultiplier),new Coords(100,25).multiply(sizeMultiplier),true,"Select a Profile:",this.fontHeightInPixelsBase*sizeMultiplier.y),new ControlList("listProfiles",new Coords(50,50).multiply(sizeMultiplier),new Coords(100,40).multiply(sizeMultiplier),new DataBinding(profiles,null),"name",this.fontHeightInPixelsBase*sizeMultiplier.y),new ControlButton("buttonNew",new Coords(50,95).multiply(sizeMultiplier),new Coords(30,25).multiply(sizeMultiplier),"New",this.fontHeightInPixelsBase*sizeMultiplier.y,true,true,function click(universe){var venueNext=new VenueControls(universe.controlBuilder.profileNew(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},universe),new ControlButton("buttonSelect",new Coords(85,95).multiply(sizeMultiplier),new Coords(30,25).multiply(sizeMultiplier),"Select",this.fontHeightInPixelsBase*sizeMultiplier.y,true,new DataBinding(function (){var controlRoot=universe.venueCurrent.controlRoot;if(controlRoot==null){return false;}else {return controlRoot.children["listProfiles"].itemSelected()!=null;}},"call()"),function click(universe){var listProfiles=this.parent.children["listProfiles"];var profileSelected=listProfiles.itemSelected();universe.profile=profileSelected;var venueNext=new VenueControls(universe.controlBuilder.profileDetail(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},universe),new ControlButton("buttonSkip",new Coords(120,95).multiply(sizeMultiplier),new Coords(30,25).multiply(sizeMultiplier),"Skip",this.fontHeightInPixelsBase*sizeMultiplier.y,true,true,function click(universe){var world=World.new (universe);var now=DateTime.now();var nowAsString=now.toStringMMDD_HHMM_SS();var profileName="Anon-"+nowAsString;var profile=new Profile(profileName,[world]);universe.profile=profile;universe.world=world;var venueNext=new VenueWorld(universe.world);venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},universe),new ControlButton("buttonBack",new Coords(10,10).multiply(sizeMultiplier),new Coords(15,15).multiply(sizeMultiplier),"<",this.fontHeightInPixelsBase*sizeMultiplier.y,true,true,function click(universe){var venueNext=new VenueControls(universe.controlBuilder.title(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},universe),new ControlButton("buttonDelete",new Coords(180,10).multiply(sizeMultiplier),new Coords(15,15).multiply(sizeMultiplier),"x",this.fontHeightInPixelsBase*sizeMultiplier.y,true,true,function click(universe){var profile=universe.profile;var controlConfirm=universe.controlBuilder.confirm(universe,size,"Delete all profiles?",function confirm(universe){universe.profileHelper.profilesAllDelete();var venueNext=new VenueControls(universe.controlBuilder.profileSelect(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},function cancel(universe){var venueNext=new VenueControls(universe.controlBuilder.profileSelect(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;});var venueNext=new VenueControls(controlConfirm);venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},universe),]);return returnValue;};ControlBuilder.prototype.slideshow=function (universe,size,imageNamesAndMessagesForSlides,venueAfterSlideshow){if(size==null){size=universe.display.sizeDefault;}var sizeMultiplier=this.sizeMultiplier.overwriteWith(size).divide(this.sizeBase);var controlsForSlides=[];for(var i=0;i<imageNamesAndMessagesForSlides.length;i++){var imageNameAndMessage=imageNamesAndMessagesForSlides[i];var imageName=imageNameAndMessage[0];var message=imageNameAndMessage[1];var containerSlide=new ControlContainer("containerSlide_"+i,new Coords(0,0).multiply(sizeMultiplier),new Coords(200,150).multiply(sizeMultiplier),[new ControlVisual("imageSlide",new Coords(0,0).multiply(sizeMultiplier),new Coords(200,150).multiply(sizeMultiplier),new VisualImageFromLibrary(imageName,size),),new ControlLabel("labelSlideText",new Coords(100,this.fontHeightInPixelsBase*2).multiply(sizeMultiplier),new Coords(200,150).multiply(sizeMultiplier),true,message,this.fontHeightInPixelsBase*2
),new ControlButton("buttonNext",new Coords(75,120).multiply(sizeMultiplier),new Coords(50,40).multiply(sizeMultiplier),"Next",this.fontHeightInPixelsBase,false,true,function click(slideIndexNext,universe){var venueNext;if(slideIndexNext<controlsForSlides.length){var controlForSlideNext=controlsForSlides[slideIndexNext];venueNext=new VenueControls(controlForSlideNext);}else {venueNext=venueAfterSlideshow;}venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;}.bind(this,i+1),universe)]);controlsForSlides.push(containerSlide);}return controlsForSlides[0];};ControlBuilder.prototype.title=function (universe,size){if(size==null){size=universe.display.sizeDefault;}var sizeMultiplier=this.sizeMultiplier.overwriteWith(size).divide(this.sizeBase);var returnValue=new ControlContainer("containerTitle",new Coords(0,0).multiply(sizeMultiplier),new Coords(200,150).multiply(sizeMultiplier),[new ControlVisual("imageTitle",new Coords(0,0).multiply(sizeMultiplier),new Coords(200,150).multiply(sizeMultiplier),new VisualImageFromLibrary("Title",size),),new ControlButton("buttonStart",new Coords(75,100).multiply(sizeMultiplier),new Coords(50,40).multiply(sizeMultiplier),"Start",this.fontHeightInPixelsBase*sizeMultiplier.y*2,false,true,function click(universe){var venueNext=new VenueControls(universe.controlBuilder.profileSelect(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},universe)]);return returnValue;};ControlBuilder.prototype.worldDetail=function (universe,size){if(size==null){size=universe.display.sizeDefault;}var sizeMultiplier=this.sizeMultiplier.overwriteWith(size).divide(this.sizeBase);var world=universe.world;var dateCreated=world.dateCreated;var dateSaved=world.dateSaved;var returnValue=new ControlContainer("containerWorldDetail",new Coords(0,0).multiply(sizeMultiplier),new Coords(200,150).multiply(sizeMultiplier),[new ControlLabel("labelProfileName",new Coords(100,40).multiply(sizeMultiplier),new Coords(100,25).multiply(sizeMultiplier),true,"Profile: "+universe.profile.name,this.fontHeightInPixelsBase*sizeMultiplier.y),new ControlLabel("labelWorldName",new Coords(100,55).multiply(sizeMultiplier),new Coords(150,25).multiply(sizeMultiplier),true,"World: "+world.name,this.fontHeightInPixelsBase*sizeMultiplier.y),new ControlLabel("labelStartDate",new Coords(100,70).multiply(sizeMultiplier),new Coords(150,25).multiply(sizeMultiplier),true,"Started:"+dateCreated.toStringTimestamp(),this.fontHeightInPixelsBase*sizeMultiplier.y),new ControlLabel("labelSavedDate",new Coords(100,85).multiply(sizeMultiplier),new Coords(150,25).multiply(sizeMultiplier),true,"Saved:"+(dateSaved==null?"[never]":dateSaved.toStringTimestamp()),this.fontHeightInPixelsBase*sizeMultiplier.y),new ControlButton("buttonStart",new Coords(50,100).multiply(sizeMultiplier),new Coords(100,25).multiply(sizeMultiplier),"Start",this.fontHeightInPixelsBase*sizeMultiplier.y,true,true,function click(universe){var world=universe.world;var venueWorld=new VenueWorld(world);var venueNext;if(world.dateSaved!=null){venueNext=venueWorld;}else {var textInstructions=universe.mediaLibrary.textStringGetByName("Instructions");var instructions=textInstructions.value;var controlInstructions=universe.controlBuilder.message(universe,size,instructions,function acknowledge(universe){universe.venueNext=new VenueFader(venueWorld,universe.venueCurrent);});var venueInstructions=new VenueControls(controlInstructions);var venueMovie=new VenueVideo("Movie",venueInstructions);venueNext=venueMovie;}venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},universe),new ControlButton("buttonBack",new Coords(10,10).multiply(sizeMultiplier),new Coords(15,15).multiply(sizeMultiplier),"<",this.fontHeightInPixelsBase*sizeMultiplier.y,true,true,function click(universe){var venueNext=new VenueControls(universe.controlBuilder.profileDetail(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},universe),new ControlButton("buttonDelete",new Coords(180,10).multiply(sizeMultiplier),new Coords(15,15).multiply(sizeMultiplier),"x",this.fontHeightInPixelsBase*sizeMultiplier.y,true,true,function click(universe){var profile=universe.profile;var world=universe.world;var controlConfirm=universe.controlBuilder.confirm(universe,size,"Delete world \""+world.name+"\"?",function confirm(universe){var profile=universe.profile;var world=universe.world;var worlds=profile.worlds;worlds.remove(world);universe.world=null;universe.profileHelper.profileSave(profile);var venueNext=new VenueControls(universe.controlBuilder.profileDetail(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},function cancel(universe){var venueNext=new VenueControls(universe.controlBuilder.worldDetail(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;});var venueNext=new VenueControls(controlConfirm);venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},universe),]);return returnValue;};ControlBuilder.prototype.worldLoad=function (universe,size){if(size==null){size=universe.display.sizeDefault;}var sizeMultiplier=this.sizeMultiplier.overwriteWith(size).divide(this.sizeBase);var returnValue=new ControlContainer("containerWorldLoad",new Coords(0,0).multiply(sizeMultiplier),new Coords(200,150).multiply(sizeMultiplier),[new ControlButton("buttonLoadFromServer",new Coords(30,15).multiply(sizeMultiplier),new Coords(140,25).multiply(sizeMultiplier),"Reload from Local Storage",this.fontHeightInPixelsBase*sizeMultiplier.y,true,true,function click(universe){var controlConfirm=universe.controlBuilder.confirm(universe,size,"Abandon the current game?",function confirm(universe){var profileOld=universe.profile;var profilesReloaded=universe.profileHelper.profiles();for(var i=0;i<profilesReloaded.length;i++){var profileReloaded=profilesReloaded[i];if(profileReloaded.name==profileOld.name){universe.profile=profileReloaded;break;}}var worldOld=universe.world;var worldsReloaded=universe.profile.worlds;var worldToReload=null;for(var i=0;i<worldsReloaded.length;i++){var worldReloaded=worldsReloaded[i];if(worldReloaded.name==worldOld.name){worldToReload=worldReloaded;break;}}var venueNext=new VenueControls(universe.controlBuilder.worldLoad(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;if(worldToReload==null){venueNext=new VenueControls(universe.controlBuilder.message(universe,size,"No save exists to reload!",function acknowledge(universe){var venueNext=new VenueControls(universe.controlBuilder.worldLoad(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;}));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;}else {universe.world=worldReloaded;}},function cancel(universe){var venueNext=new VenueControls(universe.controlBuilder.worldLoad(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;});var venueNext=new VenueControls(controlConfirm);venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},universe),new ControlButton("buttonLoadFromFile",new Coords(30,50).multiply(sizeMultiplier),new Coords(140,25).multiply(sizeMultiplier),"Load from File",this.fontHeightInPixelsBase*sizeMultiplier.y,true,true,function click(universe){var profile=universe.profile;var world=universe.world;var venueFileUpload=new VenueFileUpload(null);var venueMessageReadyToLoad=new VenueControls(universe.controlBuilder.message(universe,size,"Ready to load from file...",function acknowledge(universe){function callback(fileContentsAsString){var worldAsJSON=fileContentsAsString;var worldDeserialized=universe.serializer.deserialize(worldAsJSON);universe.world=worldDeserialized;var venueNext=new VenueControls(universe.controlBuilder.configure(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;}var inputFile=venueFileUpload.domElement.getElementsByTagName("input")[0];var fileToLoad=inputFile.files[0];new FileHelper().loadFileAsText(fileToLoad,callback,null);}));var venueMessageCancelled=new VenueControls(universe.controlBuilder.message(universe,size,"No file specified.",function acknowledge(universe){var venueNext=new VenueControls(universe.controlBuilder.configure(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;}));venueFileUpload.venueNextIfFileSpecified=venueMessageReadyToLoad;venueFileUpload.venueNextIfCancelled=venueMessageCancelled;universe.venueNext=venueFileUpload;},universe),new ControlButton("buttonReturn",new Coords(30,105).multiply(sizeMultiplier),new Coords(140,25).multiply(sizeMultiplier),"Return",this.fontHeightInPixelsBase*sizeMultiplier.y,true,true,function click(universe){var venueNext=new VenueControls(universe.controlBuilder.configure(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},universe),]);return returnValue;};ControlBuilder.prototype.worldSave=function (universe,size){if(size==null){size=universe.display.sizeDefault;}var sizeMultiplier=this.sizeMultiplier.overwriteWith(size).divide(this.sizeBase);var returnValue=new ControlContainer("containerSave",new Coords(0,0).multiply(sizeMultiplier),new Coords(200,150).multiply(sizeMultiplier),[new ControlButton("buttonSaveToLocalStorage",new Coords(30,15).multiply(sizeMultiplier),new Coords(140,25).multiply(sizeMultiplier),"Save to Local Storage",this.fontHeightInPixelsBase*sizeMultiplier.y,true,true,function click(universe){var profile=universe.profile;var world=universe.world;world.dateSaved=DateTime.now();universe.profileHelper.profileSave(profile);var venueNext=new VenueControls(universe.controlBuilder.message(universe,size,"Profile saved to local storage.",function acknowledge(universe){var venueNext=new VenueControls(universe.controlBuilder.configure(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;}));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},universe),new ControlButton("buttonSaveToFile",new Coords(30,50).multiply(sizeMultiplier),new Coords(140,25).multiply(sizeMultiplier),"Save to File",this.fontHeightInPixelsBase*sizeMultiplier.y,true,true,function click(universe){var profile=universe.profile;var world=universe.world;world.dateSaved=DateTime.now();var worldSerialized=universe.serializer.serialize(world);new FileHelper().saveTextStringToFileWithName(worldSerialized,world.name+".json");var venueNext=new VenueControls(universe.controlBuilder.message(universe,size,"Save must be completed manually.",function acknowledge(universe){var venueNext=new VenueControls(universe.controlBuilder.configure(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;}));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},universe),new ControlButton("buttonReturn",new Coords(30,105).multiply(sizeMultiplier),new Coords(140,25).multiply(sizeMultiplier),"Return",this.fontHeightInPixelsBase*sizeMultiplier.y,true,true,function click(universe){var venueNext=new VenueControls(universe.controlBuilder.configure(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},universe),]);return returnValue;};}function ControlButton(name,pos,size,text,fontHeightInPixels,hasBorder,isEnabled,click,context,canBeHeldDown){this.name=name;this.pos=pos;this.size=size;this.text=text;this.fontHeightInPixels=fontHeightInPixels;this.hasBorder=hasBorder;this._isEnabled=isEnabled;this.click=click;this.context=context;this.canBeHeldDown=(canBeHeldDown==null?false:canBeHeldDown);this.isHighlighted=false;this._drawLoc=new Location(new Coords());this._sizeHalf=this.size.clone().half();}{ControlButton.prototype.actionHandle=function (actionNameToHandle){if(actionNameToHandle=="ControlConfirm"){this.click(this.context);}return (this.canBeHeldDown==false);};ControlButton.prototype.isEnabled=function (){return (this._isEnabled.get==null?this._isEnabled:this._isEnabled.get());};ControlButton.prototype.focusGain=function (){this.isHighlighted=true;};ControlButton.prototype.focusLose=function (){this.isHighlighted=false;};ControlButton.prototype.mouseClick=function (clickPos){if(this.isEnabled()==true){this.click(this.context);}return (this.canBeHeldDown==false);};ControlButton.prototype.mouseEnter=function (){this.isHighlighted=true;};ControlButton.prototype.mouseExit=function (){this.isHighlighted=false;};ControlButton.prototype.style=function (universe){return universe.controlBuilder.styles[this.styleName==null?"Default":this.styleName];};ControlButton.prototype.draw=function (universe,display,drawLoc){var drawPos=this._drawLoc.overwriteWith(drawLoc).pos;drawPos.add(this.pos);var isEnabled=this.isEnabled();var isHighlighted=this.isHighlighted&&isEnabled;var style=this.style(universe);var colorFill=style.colorFill;var colorBorder=style.colorBorder;if(this.hasBorder==true){display.drawRectangle(drawPos,this.size,colorFill,colorBorder,isHighlighted);}drawPos.add(this._sizeHalf);var colorText=(isEnabled==true?colorBorder:style.colorDisabled);display.drawText(this.text,this.fontHeightInPixels,drawPos,colorText,colorFill,isHighlighted,true,this.size.x);};}function ControlContainer(name,pos,size,children){this.name=name;this.pos=pos;this.size=size;this.children=children;this.children.addLookups("name");for(var i=0;i<this.children.length;i++){var child=this.children[i];child.parent=this;}this.indexOfChildWithFocus=null;this.childrenContainingPos=[];this.childrenContainingPosPrev=[];this._childMax=new Coords();this._drawPos=new Coords();this._drawLoc=new Location(this._drawPos);this._mouseClickPos=new Coords();this._mouseMovePos=new Coords();this._posToCheck=new Coords();}{ControlContainer.prototype.isEnabled=function (){return true;};ControlContainer.prototype.style=function (universe){return universe.controlBuilder.styles[this.styleName==null?"Default":this.styleName];};ControlContainer.prototype.actionHandle=function (actionNameToHandle){var wasActionHandled=false;var childWithFocus=this.childWithFocus();if(actionNameToHandle=="ControlPrev"||actionNameToHandle=="ControlNext"){wasActionHandled=true;var direction=(actionNameToHandle=="ControlPrev"?-1 :1);if(childWithFocus==null){childWithFocus=this.childWithFocusNextInDirection(direction);if(childWithFocus!=null){childWithFocus.focusGain();}}else if(childWithFocus.childWithFocus!=null){childWithFocus.actionHandle(actionNameToHandle);if(childWithFocus.childWithFocus()==null){childWithFocus=this.childWithFocusNextInDirection(direction);if(childWithFocus!=null){childWithFocus.focusGain();}}}else {childWithFocus.focusLose();childWithFocus=this.childWithFocusNextInDirection(direction);if(childWithFocus!=null){childWithFocus.focusGain();}}}else if(childWithFocus!=null){if(childWithFocus.actionHandle!=null){wasActionHandled=childWithFocus.actionHandle(actionNameToHandle);}}return wasActionHandled;};ControlContainer.prototype.childWithFocus=function (){return (this.indexOfChildWithFocus==null?null:this.children[this.indexOfChildWithFocus]);};ControlContainer.prototype.childWithFocusNextInDirection=function (direction){if(this.indexOfChildWithFocus==null){var iStart=(direction==1 ?0 :this.children.length-1);var iEnd=(direction==1 ?this.children.length:-1);for(var i=iStart;i!=iEnd;i+=direction){var child=this.children[i];if(child.focusGain!=null&&(child.isEnabled==null||child.isEnabled())){this.indexOfChildWithFocus=i;break;}}}else {var childIndexOriginal=this.indexOfChildWithFocus;while(true){this.indexOfChildWithFocus+=direction;var isChildNextInRange=this.indexOfChildWithFocus.isInRangeMinMax(0,this.children.length-1
);if(isChildNextInRange==false){this.indexOfChildWithFocus=null;break;}else {var child=this.children[this.indexOfChildWithFocus];if(child.focusGain!=null&&(child.isEnabled==null||child.isEnabled())){break;}}}}var returnValue=this.childWithFocus();return returnValue;};ControlContainer.prototype.childrenAtPosAddToList=function (posToCheck,listToAddTo,addFirstChildOnly){posToCheck=this._posToCheck.overwriteWith(posToCheck).clearZ();for(var i=this.children.length-1;i>=0;i--){var child=this.children[i];var doesChildContainPos=posToCheck.isInRangeMinMax(child.pos,this._childMax.overwriteWith(child.pos).add(child.size));if(doesChildContainPos==true){listToAddTo.push(child);if(addFirstChildOnly==true){break;}}}return listToAddTo;};ControlContainer.prototype.focusGain=function (){this.indexOfChildWithFocus=null;var childWithFocus=this.childWithFocusNextInDirection(1);if(childWithFocus!=null){childWithFocus.focusGain();}};ControlContainer.prototype.focusLose=function (){var childWithFocus=this.childWithFocus();if(childWithFocus!=null){childWithFocus.focusLose();this.indexOfChildWithFocus=null;}};ControlContainer.prototype.mouseClick=function (mouseClickPos){mouseClickPos=this._mouseClickPos.overwriteWith(mouseClickPos).subtract(this.pos);var childrenContainingPos=this.childrenAtPosAddToList(mouseClickPos,this.childrenContainingPos.clear(),true);var wasClickHandled=false;if(childrenContainingPos.length>0){var child=childrenContainingPos[0];if(child.mouseClick!=null){var wasClickHandledByChild=child.mouseClick(mouseClickPos);if(wasClickHandledByChild==true){wasClickHandled=true;}}}return wasClickHandled;};ControlContainer.prototype.mouseMove=function (mouseMovePos){var temp=this.childrenContainingPosPrev;this.childrenContainingPosPrev=this.childrenContainingPos;this.childrenContainingPos=temp;mouseMovePos=this._mouseMovePos.overwriteWith(mouseMovePos).subtract(this.pos);var childrenContainingPos=this.childrenAtPosAddToList(mouseMovePos,this.childrenContainingPos.clear(),true);for(var i=0;i<childrenContainingPos.length;i++){var child=childrenContainingPos[i];if(child.mouseMove!=null){child.mouseMove(mouseMovePos);}if(this.childrenContainingPosPrev.indexOf (child)==-1){if(child.mouseEnter!=null){child.mouseEnter();}}}for(var i=0;i<this.childrenContainingPosPrev.length;i++){var child=this.childrenContainingPosPrev[i];if(childrenContainingPos.indexOf (child)==-1){if(child.mouseExit!=null){child.mouseExit();}}}};ControlContainer.prototype.draw=function (universe,display,drawLoc){drawLoc=this._drawLoc.overwriteWith(drawLoc);var drawPos=this._drawPos.overwriteWith(drawLoc.pos).add(this.pos);var style=this.style(universe);display.drawRectangle(drawPos,this.size,style.colorBackground,style.colorBorder);var children=this.children;for(var i=0;i<children.length;i++){var child=children[i];child.draw(universe,display,drawLoc);}};}function ControlContainerTransparent(containerInner){this.containerInner=containerInner;}{ControlContainerTransparent.prototype.childWithFocus=function (){return this.containerInner.childWithFocus();};ControlContainerTransparent.prototype.childWithFocusNextInDirection=function (direction){return this.containerInner.childWithFocusNextInDirection(direction);};ControlContainerTransparent.prototype.childrenAtPosAddToList=function (posToCheck,listToAddTo,addFirstChildOnly){return this.containerInner.childrenAtPosAddToList(posToCheck,listToAddTo,addFirstChildOnly);};ControlContainerTransparent.prototype.actionHandle=function (actionNameToHandle){return this.containerInner.actionHandle(actionNameToHandle);};ControlContainerTransparent.prototype.mouseClick=function (mouseClickPos){var childrenContainingPos=this.containerInner.childrenAtPosAddToList(mouseClickPos,this.containerInner.childrenContainingPos.clear(),true);var wasClickHandled=false;if(childrenContainingPos.length>0){var child=childrenContainingPos[0];if(child.mouseClick!=null){var wasClickHandledByChild=child.mouseClick(mouseClickPos);if(wasClickHandledByChild==true){wasClickHandled=true;}}}return wasClickHandled;};ControlContainerTransparent.prototype.mouseMove=function (mouseMovePos){this.containerInner.mouseMove(mouseMovePos);};ControlContainerTransparent.prototype.draw=function (universe,display,drawLoc){drawLoc=this.containerInner._drawLoc.overwriteWith(drawLoc);var drawPos=this.containerInner._drawPos.overwriteWith(drawLoc.pos).add(this.containerInner.pos);display.drawRectangle(drawPos,this.containerInner.size,null,display.colorFore);var children=this.containerInner.children;for(var i=0;i<children.length;i++){var child=children[i];child.draw(universe,display,drawLoc);}};}function ControlDynamic(name,pos,size,binding){this.name=name;this.pos=pos;this.size=size;this.binding=binding;this.boundValuePrev=null;this.child=null;this.drawPos=new Coords();this.drawLoc=new Location(this.drawPos);this.mouseClickPos=new Coords();this.mouseMovePos=new Coords();}{ControlDynamic.prototype.actionHandle=function (actionNameToHandle){var wasActionHandled=false;if(this.child!=null){wasActionHandled=this.child.actionHandle(actionNameToHandle);}return wasActionHandled;};ControlDynamic.prototype.childWithFocus=function (){return (this.child==null?null:this.child.childWithFocus());};ControlDynamic.prototype.focusGain=function (){if(this.child!=null&&this.child.focusGain!=null){this.child.focusGain();}};ControlDynamic.prototype.focusLose=function (){if(this.child!=null&&this.child.focusLose!=null){this.child.focusLose();}};ControlDynamic.prototype.isEnabled=function (){return true;};ControlDynamic.prototype.mouseClick=function (mouseClickPos){var wasHandledByChild=false;if(this.child!=null&&this.child.mouseClick!=null){mouseClickPos=this.mouseClickPos.overwriteWith(mouseClickPos).subtract(this.pos);wasHandledByChild=this.child.mouseClick(mouseClickPos);}return wasHandledByChild;};ControlDynamic.prototype.mouseEnter=function (){if(this.child!=null&&this.child.mouseEnter!=null){return this.child.mouseEnter();}};ControlDynamic.prototype.mouseExit=function (){if(this.child!=null&&this.child.mouseExit!=null){return this.child.mouseExit();}};ControlDynamic.prototype.mouseMove=function (mouseMovePos){if(this.child!=null&&this.child.mouseMove!=null){mouseMovePos=this.mouseMovePos.overwriteWith(mouseMovePos).subtract(this.pos);return this.child.mouseMove(mouseMovePos);}};ControlDynamic.prototype.draw=function (universe,display,drawLoc){var boundValue=this.binding.get();if(boundValue!=this.boundValuePrev){this.boundValuePrev=boundValue;if(boundValue==null){this.child=null;}else if(boundValue.controlBuild!=null){this.child=boundValue.controlBuild(universe,this.size);}}if(this.child!=null){var drawLoc=this.drawLoc.overwriteWith(drawLoc);drawLoc.pos.add(this.pos);this.child.draw(universe,display,drawLoc);}};}function ControlLabel(name,pos,size,isTextCentered,text,fontHeightInPixels){this.name=name;this.pos=pos;this.size=size;this.isTextCentered=isTextCentered;this._text=text;this.fontHeightInPixels=fontHeightInPixels;this._drawPos=new Coords();}{ControlLabel.prototype.style=function (universe){return universe.controlBuilder.styles[this.styleName==null?"Default":this.styleName];};ControlLabel.prototype.text=function (){return (this._text.get==null?this._text:this._text.get());};ControlLabel.prototype.draw=function (universe,display,drawLoc){var drawPos=this._drawPos.overwriteWith(drawLoc.pos).add(this.pos);var style=this.style(universe);var text=this.text();if(text!=null){var textAsLines=(""+text).split("\n");for(var i=0;i<textAsLines.length;i++){var textLine=textAsLines[i];display.drawText(textLine,this.fontHeightInPixels,drawPos,style.colorBorder,style.colorFill,null,this.isTextCentered,this.size.x);drawPos.y+=this.fontHeightInPixels;}}};}function ControlList(name,pos,size,items,bindingForItemText,fontHeightInPixels,bindingForItemSelected,bindingForItemValue,bindingForIsEnabled){this.name=name;this.pos=pos;this.size=size;this._items=items;this.bindingForItemText=bindingForItemText;this.fontHeightInPixels=fontHeightInPixels;this.bindingForItemSelected=bindingForItemSelected;this.bindingForItemValue=bindingForItemValue;this.bindingForIsEnabled=bindingForIsEnabled;this.itemSpacing=1.2 *this.fontHeightInPixels;this.isHighlighted=false;var scrollbarWidth=this.itemSpacing;this.scrollbar=new ControlScrollbar(new Coords(this.size.x-scrollbarWidth,0),new Coords(scrollbarWidth,this.size.y),this.fontHeightInPixels,this.itemSpacing,this._items,0 );this._drawPos=new Coords();this._drawLoc=new Location(this._drawPos);this._mouseClickPos=new Coords();}{ControlList.prototype.actionHandle=function (actionNameToHandle){var wasActionHandled=false;if(actionNameToHandle=="ControlIncrement"){this.itemSelectedNextInDirection(1);wasActionHandled=true;}else if(actionNameToHandle=="ControlDecrement"){this.itemSelectedNextInDirection(-1);wasActionHandled=true;}return wasActionHandled;};ControlList.prototype.focusGain=function (){this.isHighlighted=true;};ControlList.prototype.focusLose=function (){this.isHighlighted=false;};ControlList.prototype.indexOfFirstItemVisible=function (){return this.scrollbar.sliderPosInItems();};ControlList.prototype.indexOfItemSelected=function (valueToSet){var returnValue=valueToSet;var items=this.items();if(valueToSet==null){returnValue=items.indexOf (this.itemSelected());if(returnValue==-1){returnValue=null;}}else {var itemToSelect=items[valueToSet];this.itemSelected(itemToSelect);}return returnValue;};ControlList.prototype.indexOfLastItemVisible=function (){return this.indexOfFirstItemVisible()+Math.floor(this.scrollbar.windowSizeInItems)-1;};ControlList.prototype.isEnabled=function (){return (this.bindingForIsEnabled==null?true:this.bindingForIsEnabled.get());};ControlList.prototype.itemSelected=function (itemToSet){var returnValue=itemToSet;if(itemToSet==null){if(this._bindingForItemSelected==null){returnValue=this._itemSelected;}else {returnValue=(this.bindingForItemSelected.get==null?this._itemSelected:this.bindingForItemSelected.get());}}else {this._itemSelected=itemToSet;if(this.bindingForItemSelected!=null){var valueToSet=this.bindingForItemValue.contextSet(this._itemSelected).get();this.bindingForItemSelected.set(valueToSet);}}return returnValue;};ControlList.prototype.itemSelectedNextInDirection=function (direction){var items=this.items();var numberOfItems=items.length;var itemSelected=this.itemSelected();var indexOfItemSelected=this.indexOfItemSelected();if(indexOfItemSelected==null){if(numberOfItems>0){if(direction==1){indexOfItemSelected=0;}else {indexOfItemSelected=numberOfItems-1;}}}else {indexOfItemSelected=(indexOfItemSelected+direction).trimToRangeMinMax(0,numberOfItems-1);}var itemToSelect=(indexOfItemSelected==null?null:items[indexOfItemSelected]);this.itemSelected(itemToSelect);var indexOfFirstItemVisible=this.indexOfFirstItemVisible();var indexOfLastItemVisible=this.indexOfLastItemVisible();var indexOfItemSelected=this.indexOfItemSelected();if(indexOfItemSelected<indexOfFirstItemVisible){this.scrollbar.scrollUp();}else if(indexOfItemSelected>indexOfLastItemVisible){this.scrollbar.scrollDown();}var returnValue=this.itemSelected();return returnValue;};ControlList.prototype.items=function (){return (this._items.get==null?this._items:this._items.get());};ControlList.prototype.mouseClick=function (clickPos){clickPos=this._mouseClickPos.overwriteWith(clickPos);if(clickPos.x-this.pos.x>this.size.x-this.scrollbar.handleSize.x){if(clickPos.y-this.pos.y<=this.scrollbar.handleSize.y){this.scrollbar.scrollUp();}else if(clickPos.y-this.pos.y>=this.scrollbar.size.y-this.scrollbar.handleSize.y){this.scrollbar.scrollDown();}else {var clickPosRelativeToSlideInPixels=clickPos.subtract(this.scrollbar.pos).subtract(new Coords(0,this.scrollbar.handleSize.y));}}else {var offsetOfItemClicked=clickPos.y-this.pos.y;var indexOfItemClicked=this.indexOfFirstItemVisible()+Math.floor(offsetOfItemClicked/this.itemSpacing);var items=this.items();if(indexOfItemClicked<items.length){this.indexOfItemSelected(indexOfItemClicked);}}return true;};ControlList.prototype.style=function (universe){return universe.controlBuilder.styles[this.styleName==null?"Default":this.styleName];};ControlList.prototype.draw=function (universe,display,drawLoc){drawLoc=this._drawLoc.overwriteWith(drawLoc);var drawPos=this._drawPos.overwriteWith(drawLoc.pos).add(this.pos);var style=this.style(universe);var colorFore=(this.isHighlighted==true?style.colorFill:style.colorBorder);var colorBack=(this.isHighlighted==true?style.colorBorder:style.colorFill);display.drawRectangle(drawPos,this.size,colorBack,style.colorBorder,false);var itemSizeY=this.itemSpacing;var textMarginLeft=2;var itemPosY=drawPos.y;var items=this.items();if(items==null){return ;}var numberOfItemsVisible=Math.floor(this.size.y/itemSizeY);var indexStart=this.indexOfFirstItemVisible();var indexEnd=indexStart+numberOfItemsVisible-1;if(indexEnd>=items.length){indexEnd=items.length-1;}var itemSelected=this.itemSelected();for(var i=indexStart;i<=indexEnd;i++){var item=items[i];if(item==itemSelected){display.drawRectangle(new Coords(drawPos.x,itemPosY),new Coords(this.size.x,itemSizeY),colorFore);}var text=this.bindingForItemText.contextSet(item).get();var drawPos2=new Coords(drawPos.x+textMarginLeft,itemPosY);display.drawText(text,this.fontHeightInPixels,drawPos2,colorFore,colorBack,(i==this.indexOfItemSelected()),false,this.size.x);itemPosY+=itemSizeY;}this.scrollbar.draw(universe,display,drawLoc);};}function ControlScrollbar(pos,size,fontHeightInPixels,itemHeight,items,sliderPosInItems){this.pos=pos;this.size=size;this.fontHeightInPixels=fontHeightInPixels;this.itemHeight=itemHeight;this._items=items;this._sliderPosInItems=sliderPosInItems;this.windowSizeInItems=Math.floor(this.size.y/itemHeight);this.handleSize=new Coords(this.size.x,this.size.x);this.buttonScrollUp=new ControlButton(null,new Coords(0,0),this.handleSize,"-",this.fontHeightInPixels,true,true,this.scrollUp);this.buttonScrollDown=new ControlButton(null,new Coords(0,this.size.y-this.handleSize.y),this.handleSize,"+",this.fontHeightInPixels,true,true,this.scrollDown);this._drawPos=new Coords();}{ControlScrollbar.prototype.actionHandle=function (actionNameToHandle){return true;};ControlScrollbar.prototype.items=function (){return (this._items.get==null?this._items:this._items.get());};ControlScrollbar.prototype.mouseClick=function (universe,clickPos){};ControlScrollbar.prototype.scrollDown=function (){var sliderPosInItems=(this.sliderPosInItems()+1
).trimToRangeMinMax(0,this.sliderMaxInItems());this._sliderPosInItems=sliderPosInItems;};ControlScrollbar.prototype.scrollUp=function (){var sliderPosInItems=(this.sliderPosInItems()-1
).trimToRangeMinMax(0,this.sliderMaxInItems());this._sliderPosInItems=sliderPosInItems;};ControlScrollbar.prototype.slideSizeInPixels=function (){var slideSizeInPixels=new Coords(this.handleSize.x,this.size.y-2 *this.handleSize.y);return slideSizeInPixels;};ControlScrollbar.prototype.sliderPosInItems=function (){return this._sliderPosInItems;};ControlScrollbar.prototype.sliderMaxInItems=function (){return this.items().length-Math.floor(this.windowSizeInItems);};ControlScrollbar.prototype.sliderPosInPixels=function (){var sliderPosInPixels=new Coords(this.size.x-this.handleSize.x,this.handleSize.y+this.sliderPosInItems()*this.slideSizeInPixels().y/this.items().length);return sliderPosInPixels;};ControlScrollbar.prototype.sliderSizeInPixels=function (){var sliderSizeInPixels=this.slideSizeInPixels().multiply(new Coords(1,this.windowSizeInItems/this.items().length));return sliderSizeInPixels;};ControlScrollbar.prototype.style=function (universe){return universe.controlBuilder.styles[this.styleName==null?"Default":this.styleName];};ControlScrollbar.prototype.draw=function (universe,display,drawLoc){var numberOfItems=this.items().length;if(this.windowSizeInItems<numberOfItems){var style=this.style(universe);var colorFore=(this.isHighlighted==true?style.colorFill:style.colorBorder);var colorBack=(this.isHighlighted==true?style.colorBorder:style.colorFill);var drawPos=this._drawPos.overwriteWith(drawLoc.pos).add(this.pos);display.drawRectangle(drawPos,this.size,colorFore,null);drawLoc.pos.add(this.pos);this.buttonScrollDown.draw(universe,display,drawLoc);this.buttonScrollUp.draw(universe,display,drawLoc);var sliderPosInPixels=this.sliderPosInPixels().add(drawPos);var sliderSizeInPixels=this.sliderSizeInPixels();display.drawRectangle(sliderPosInPixels,sliderSizeInPixels,colorBack,colorFore);}};}function ControlSelect(name,pos,size,valueSelected,options,bindingForOptionValues,bindingForOptionText,fontHeightInPixels){this.name=name;this.pos=pos;this.size=size;this._valueSelected=valueSelected;this._options=options;this.bindingForOptionValues=bindingForOptionValues;this.bindingForOptionText=bindingForOptionText;this.fontHeightInPixels=fontHeightInPixels;this.indexOfOptionSelected=null;var valueSelected=this.valueSelected();var options=this.options();for(var i=0;i<options.length;i++){var option=options[i];var optionValue=this.bindingForOptionValues.contextSet(option).get();if(optionValue==valueSelected){this.indexOfOptionSelected=i;break;}}this.isHighlighted=false;this.drawPos=new Coords();this.drawLoc=new Location(this.drawPos);this.sizeHalf=this.size.clone().half();}{ControlSelect.prototype.actionHandle=function (actionNameToHandle){if(actionNameToHandle=="ControlDecrement"){this.optionSelectedNextInDirection(1);}else if(actionNameToHandle=="ControlIncrement"||actionNameToHandle=="ControlConfirm"){this.optionSelectedNextInDirection(-1);}};ControlSelect.prototype.focusGain=function (){this.isHighlighted=true;};ControlSelect.prototype.focusLose=function (){this.isHighlighted=false;};ControlSelect.prototype.isEnabled=function (){return true;};ControlSelect.prototype.optionSelected=function (){var returnValue=null;if(this.indexOfOptionSelected!=null){var optionAsObject=this.options()[this.indexOfOptionSelected];var optionValue=this.bindingForOptionValues.contextSet(optionAsObject).get();var optionText=this.bindingForOptionText.contextSet(optionAsObject).get();returnValue=new ControlSelectOption(optionValue,optionText);};return returnValue;};ControlSelect.prototype.optionSelectedNextInDirection=function (direction){var options=this.options();this.indexOfOptionSelected=(this.indexOfOptionSelected+direction).wrapToRangeMinMax(0,options.length);var optionSelected=this.optionSelected();if(this._valueSelected!=null&&this._valueSelected.constructor.name=="DataBinding"){this._valueSelected.set(optionSelected.value);}else {this._valueSelected=optionSelected.value;}};ControlSelect.prototype.options=function (){return (this._options.get==null?this._options:this._options.get());};ControlSelect.prototype.mouseClick=function (clickPos){this.optionSelectedNextInDirection(1);return true;};ControlSelect.prototype.style=function (universe){return universe.controlBuilder.styles[this.styleName==null?"Default":this.styleName];};ControlSelect.prototype.valueSelected=function (){return (this._valueSelected==null?null:(this._valueSelected.get==null?this._valueSelected:this._valueSelected.get()));};ControlSelect.prototype.draw=function (universe,display,drawLoc){var drawPos=this.drawPos.overwriteWith(drawLoc.pos).add(this.pos);var style=this.style(universe);display.drawRectangle(drawPos,this.size,style.colorFill,style.colorBorder,this.isHighlighted);drawPos.add(this.sizeHalf);var optionSelected=this.optionSelected();var text=(optionSelected==null?"-":optionSelected.text);display.drawText(text,this.fontHeightInPixels,drawPos,style.colorBorder,style.colorFill,this.isHighlighted,true,this.size.x);};}function ControlSelectOption(value,text){this.value=value;this.text=text;}function ControlStyle(name,colorBackground,colorFill,colorBorder,colorDisabled){this.name=name;this.colorBackground=colorBackground;this.colorFill=colorFill;this.colorBorder=colorBorder;this.colorDisabled=colorDisabled;}{ControlStyle.Instances=function (){if(ControlStyle._Instances==null){ControlStyle._Instances=new ControlStyle_Instances();}return ControlStyle._Instances;};function ControlStyle_Instances(){this.Default=new ControlStyle("Default","rgb(240, 240, 240)","White","Gray","LightGray");}}function ControlTextBox(name,pos,size,text,fontHeightInPixels,numberOfCharsMax){this.name=name;this.pos=pos;this.size=size;this._text=text;this.fontHeightInPixels=fontHeightInPixels;this.numberOfCharsMax=numberOfCharsMax;this.isHighlighted=false;this.cursorPos=this.text().length;this._drawPos=new Coords();this._drawPosText=new Coords();this._drawLoc=new Location(this._drawPos);this._textMargin=new Coords();this._textSize=new Coords();}{ControlTextBox.prototype.style=function (universe){return universe.controlBuilder.styles[this.styleName==null?"Default":this.styleName];};ControlTextBox.prototype.text=function (value,universe){if(value!=null){if(this._text.set==null){this._text=value;}else {this._text.set(value);}}return (this._text.get==null?this._text:this._text.get(universe));};ControlTextBox.prototype.actionHandle=function (actionNameToHandle){var text=this.text();if(actionNameToHandle=="ControlCancel"){this.text(text.substr(0,text.length-1));this.cursorPos=(this.cursorPos-1
).wrapToRangeMinMax(0,text.length+1
);}else if(actionNameToHandle=="ControlConfirm"){this.cursorPos=(this.cursorPos+1
).wrapToRangeMinMax(0,text.length+1);}else if(actionNameToHandle=="ControlIncrement"||actionNameToHandle=="ControlDecrement"){var direction=(actionNameToHandle=="ControlIncrement"?-1 :1);var charCodeAtCursor=(this.cursorPos<text.length?text.charCodeAt(this.cursorPos):"A".charCodeAt(0)-1
);charCodeAtCursor=(charCodeAtCursor+direction).wrapToRangeMinMax("A".charCodeAt(0),"Z".charCodeAt(0)+1
);var charAtCursor=String.fromCharCode(charCodeAtCursor);this.text(text.substr(0,this.cursorPos)+charAtCursor+text.substr(this.cursorPos+1));}else if(actionNameToHandle.length==1 ||actionNameToHandle.startsWith("_")){if(actionNameToHandle.startsWith("_")){if(actionNameToHandle=="_"){actionNameToHandle=" ";}else {actionNameToHandle=actionNameToHandle.substr(1);}}if(this.numberOfCharsMax==null||text.length<this.numberOfCharsMax){text=this.text(text.substr(0,this.cursorPos)+actionNameToHandle+text.substr(this.cursorPos));this.cursorPos=(this.cursorPos+1
).wrapToRangeMinMax(0,text.length+1
);}}return true;};ControlTextBox.prototype.focusGain=function (){this.isHighlighted=true;};ControlTextBox.prototype.focusLose=function (){this.isHighlighted=false;};ControlTextBox.prototype.mouseClick=function (mouseClickPos){var parent=this.parent;parent.indexOfChildWithFocus=parent.children.indexOf (this);this.isHighlighted=true;};ControlTextBox.prototype.draw=function (universe,display,drawLoc){var drawPos=this._drawPos.overwriteWith(drawLoc.pos).add(this.pos);var style=this.style(universe);var text=this.text();display.drawRectangle(drawPos,this.size,style.colorFill,style.colorBorder,this.isHighlighted);var textWidth=display.textWidthForFontHeight(text,this.fontHeightInPixels);var textSize=this._textSize.overwriteWithDimensions(textWidth,this.fontHeightInPixels,0);var textMargin=this._textMargin.overwriteWith(this.size).subtract(textSize).half();var drawPosText=this._drawPosText.overwriteWith(drawPos).add(textMargin);display.drawText(text,this.fontHeightInPixels,drawPosText,style.colorBorder,style.colorFill,this.isHighlighted,false,this.size.x);if(this.isHighlighted==true){var textBeforeCursor=text.substr(0,this.cursorPos);var textAtCursor=text.substr(this.cursorPos,1);var cursorX=display.textWidthForFontHeight(textBeforeCursor,this.fontHeightInPixels);var cursorWidth=display.textWidthForFontHeight(textAtCursor,this.fontHeightInPixels);drawPosText.x+=cursorX;display.drawRectangle(drawPosText,new Coords(cursorWidth,this.fontHeightInPixels),style.colorFill,style.colorFill);display.drawText(textAtCursor,this.fontHeightInPixels,drawPosText,style.colorBorder,null,null,this.size.x);}};}function ControlVisual(name,pos,size,visual){this.name=name;this.pos=pos;this.size=size;this.visual=visual;this._drawPos=new Coords();this._drawable=new Locatable(new Location(this._drawPos));this._sizeHalf=this.size.clone().half();}{ControlVisual.prototype.style=function (universe){return universe.controlBuilder.styles[this.styleName==null?"Default":this.styleName];};ControlVisual.prototype.draw=function (universe,display,drawLoc){var drawPos=this._drawPos.overwriteWith(drawLoc.pos).add(this.pos);var style=this.style(universe);display.drawRectangle(drawPos,this.size,style.colorFill,style.colorBorder);var drawable=this._drawable;drawable.loc.pos.overwriteWith(drawPos);drawPos.add(this._sizeHalf);this.visual.draw(universe,universe.world,display,drawable);};}function DataBinding(context,bindingExpression,argumentLookup){this.context=context;this.bindingExpression=bindingExpression;this.argumentLookup=argumentLookup;}{DataBinding.prototype.contextSet=function (value){this.context=value;return this;};DataBinding.prototype.get=function (){var returnValue=this.context;if(this.bindingExpression!=null){var bindingExpressionParts=this.bindingExpression.split(".");for(var i=0;i<bindingExpressionParts.length;i++){if(returnValue==null){break;}var bindingExpressionPart=bindingExpressionParts[i];var indexOfOpenParenthesis=bindingExpressionPart.indexOf ("(");if(indexOfOpenParenthesis!=-1){var functionName=bindingExpressionPart.substr(0,indexOfOpenParenthesis);if(returnValue[functionName]==null){returnValue=null;}else {var indexOfCloseParenthesis=bindingExpressionPart.indexOf (")");var argumentNamesAsString=bindingExpressionPart.substring(indexOfOpenParenthesis+1,indexOfCloseParenthesis);var argumentNames=argumentNamesAsString.split(" ").join("").split(",");var argumentValues=[];for(var a=0;a<argumentNames.length;a++){var argumentName=argumentNames[a];if(argumentName.length>0){var argumentValue=this.argumentLookup[argumentName];argumentValues.push(argumentValue);}}returnValue=returnValue[functionName].apply(returnValue,argumentValues);}}else {returnValue=returnValue[bindingExpressionPart];}}}return returnValue;};DataBinding.prototype.set=function (valueToSet){var returnValue=this.context;if(this.bindingExpression!=null){var bindingExpressionParts=this.bindingExpression.split(".");for(var i=0;i<bindingExpressionParts.length-1;i++){if(returnValue==null){break;}var bindingExpressionPart=bindingExpressionParts[i];var indexOfOpenParenthesis=bindingExpressionPart.indexOf ("(");if(indexOfOpenParenthesis!=-1){var functionName=bindingExpressionPart.substr(0,indexOfOpenParenthesis);if(returnValue[functionName]==null){returnValue=null;}else {var indexOfCloseParenthesis=bindingExpressionPart.indexOf (")");var argumentNamesAsString=bindingExpressionPart.substring(indexOfOpenParenthesis+1,indexOfCloseParenthesis);var argumentNames=argumentNamesAsString.split(" ").join("").split(",");var argumentValues=[];for(var a=0;a<argumentNames.length;a++){var argumentName=argumentNames[a];if(argumentName.length>0){var argumentValue=this.argumentLookup[argumentName];argumentValues.push(argumentValue);}}returnValue=returnValue[functionName].apply(returnValue,argumentValues);}}else {returnValue=returnValue[bindingExpressionPart];}}var bindingExpressionPartFinal=bindingExpressionParts[bindingExpressionParts.length-1];returnValue[bindingExpressionPartFinal]=valueToSet;}return valueToSet;};}function VenueControls(controlRoot){this.controlRoot=controlRoot;this.inputToActionMappings=[new InputToActionMapping("ArrowDown","ControlIncrement",true),new InputToActionMapping("ArrowLeft","ControlPrev",true),new InputToActionMapping("ArrowRight","ControlNext",true),new InputToActionMapping("ArrowUp","ControlDecrement",true),new InputToActionMapping("Backspace","ControlCancel",true),new InputToActionMapping("Enter","ControlConfirm",true),new InputToActionMapping("Escape","ControlCancel",true),new InputToActionMapping("Tab","ControlNext",true),];var numberOfGamepadsPossible=4;for(var i=0;i<numberOfGamepadsPossible;i++){var gamepadID="Gamepad"+i;this.inputToActionMappings.append([new InputToActionMapping(gamepadID+"MoveDown","ControlIncrement",true),new InputToActionMapping(gamepadID+"MoveLeft","ControlPrev",true),new InputToActionMapping(gamepadID+"MoveRight","ControlNext",true),new InputToActionMapping(gamepadID+"ArrowUp","ControlDecrement",true),new InputToActionMapping(gamepadID+"Button0","ControlCancel",true),new InputToActionMapping(gamepadID+"Button1","ControlConfirm",true),]);}this.inputToActionMappings.addLookups("inputName");this._drawLoc=new Location(new Coords());this._mouseClickPos=new Coords();this._mouseMovePos=new Coords();this._mouseMovePosPrev=new Coords();}{VenueControls.prototype.draw=function (universe){var display=universe.display;var drawLoc=this._drawLoc;drawLoc.pos.clear();this.controlRoot.draw(universe,display,drawLoc);};VenueControls.prototype.updateForTimerTick=function (universe){this.draw(universe);var inputHelper=universe.inputHelper;var inputsPressed=inputHelper.inputsPressed;for(var i=0;i<inputsPressed.length;i++){var inputPressed=inputsPressed[i];if(inputPressed.isActive==true){var inputPressedName=inputPressed.name;var mapping=this.inputToActionMappings[inputPressedName];if(inputPressedName.startsWith("Mouse")==false){if(mapping==null){var wasActionHandled=this.controlRoot.actionHandle(inputPressedName);if(wasActionHandled==true){inputPressed.isActive=false;}}else {var actionName=mapping.actionName;this.controlRoot.actionHandle(actionName);if(mapping.inactivateInputWhenActionPerformed==true){inputPressed.isActive=false;}}}else if(inputPressedName=="MouseClick"){this._mouseClickPos.overwriteWith(inputHelper.mouseClickPos).divide(universe.display.scaleFactor);var wasClickHandled=this.controlRoot.mouseClick(this._mouseClickPos);if(wasClickHandled==true){inputHelper.inputRemove(inputPressed);}}else if(inputPressedName=="MouseMove"){this._mouseMovePos.overwriteWith(inputHelper.mouseMovePos).divide(universe.display.scaleFactor);this._mouseMovePosPrev.overwriteWith(inputHelper.mouseMovePosPrev).divide(universe.display.scaleFactor);this.controlRoot.mouseMove(this._mouseMovePos,this._mouseMovePosPrev);}}}};}function VenueMessage(messageToShow,venueNext,venuePrev,sizeInPixels){this.messageToShow=messageToShow;this.venueNext=venueNext;this.venuePrev=venuePrev;this._sizeInPixels=sizeInPixels;}{VenueMessage.prototype.acknowledge=function (universe){universe.venueNext=new VenueFader(this.venueNext,this.venueInner());};VenueMessage.prototype.draw=function (universe){this.venueInner(universe).draw(universe);};VenueMessage.prototype.sizeInPixels=function (universe){return (this._sizeInPixels==null?universe.display.sizeInPixels:this._sizeInPixels);};VenueMessage.prototype.updateForTimerTick=function (universe){this.venueInner(universe).updateForTimerTick(universe);};VenueMessage.prototype.venueInner=function (universe){if(this._venueInner==null){this._venueInner=new VenueLayered([this.venuePrev,new VenueControls(universe.controlBuilder.message(universe,this.sizeInPixels(universe),this.messageToShow,this.acknowledge.bind(this,universe)))]);}return this._venueInner;};}function ConversationDefn(name,imageName,contentTextStringName,talkNodeDefns,talkNodes){this.name=name;this.imageName=imageName;this.contentTextStringName=contentTextStringName;this.talkNodeDefns=talkNodeDefns.addLookups("name");this.talkNodes=talkNodes.addLookups("name");}{ConversationDefn.prototype.talkNodeByName=function (nameOfTalkNodeToGet){return this.talkNodes[nameOfTalkNodeToGet];};ConversationDefn.prototype.talkNodesByNames=function (namesOfTalkNodesToGet){var returnNodes=[];for(var i=0;i<namesOfTalkNodesToGet.length;i++){var nameOfTalkNodeToGet=namesOfTalkNodesToGet[i];var talkNode=this.talkNodeByName(nameOfTalkNodeToGet);returnNodes.push(talkNode);}return returnNodes;};ConversationDefn.prototype.expandFromContentTextString=function (contentTextString){var contentText=contentTextString.value;var contentTextAsLines=contentText.split("\n");var tagToTextLinesLookup={};var tagCurrent=null;var linesForTagCurrent;for(var i=0;i<contentTextAsLines.length;i++){var contentLine=contentTextAsLines[i];if(contentLine.startsWith("#")){if(tagCurrent!=null){tagToTextLinesLookup[tagCurrent]=linesForTagCurrent;}tagCurrent=contentLine.split("\t")[0];linesForTagCurrent=[];}else {if(contentLine.length>0){linesForTagCurrent.push(contentLine);}}}tagToTextLinesLookup[tagCurrent]=linesForTagCurrent;var talkNodeDefns=TalkNodeDefn.Instances();var talkNodeDefnNamesToExpand=[talkNodeDefns["Display"].name,talkNodeDefns["Option"].name,];var talkNodesExpanded=[];for(var i=0;i<this.talkNodes.length;i++){var talkNodeToExpand=this.talkNodes[i];var talkNodeToExpandDefnName=talkNodeToExpand.defnName;var shouldTalkNodeBeExpanded=talkNodeDefnNamesToExpand.contains(talkNodeToExpandDefnName);if(shouldTalkNodeBeExpanded==false){talkNodesExpanded.push(talkNodeToExpand);}else {var tag=talkNodeToExpand.text;var textLinesForTag=tagToTextLinesLookup[tag];for(var j=0;j<textLinesForTag.length;j++){var textLine=textLinesForTag[j];var talkNodeExpanded=new TalkNode(talkNodeToExpand.name+"_"+j,talkNodeToExpandDefnName,textLine,talkNodeToExpand.next,talkNodeToExpand.isActive);talkNodesExpanded.push(talkNodeExpanded);}}}this.talkNodes=talkNodesExpanded.addLookups("name");};ConversationDefn.deserialize=function (conversationDefnAsJSON){var conversationDefn=JSON.parse(conversationDefnAsJSON);conversationDefn.name=conversationDefn["name"];conversationDefn.imageName=conversationDefn["imageName"];conversationDefn.contentTextStringName=conversationDefn["contentTextStringName"];var talkNodes=conversationDefn["talkNodes"];for(var i=0;i<talkNodes.length;i++){var talkNode=talkNodes[i];talkNode.name=talkNode["name"];talkNode.defnName=talkNode["defnName"];talkNode.text=talkNode["text"];talkNode.next=talkNode["next"];talkNode.isActive=talkNode["isActive"];}conversationDefn.__proto__=ConversationDefn.prototype;var talkNodes=conversationDefn.talkNodes;for(var i=0;i<talkNodes.length;i++){var talkNode=talkNodes[i];talkNode.__proto__=TalkNode.prototype;if(talkNode.name==null){talkNode.name=TalkNode.idNext();}if(talkNode.isActive==null){talkNode.isActive=true;}}talkNodes.addLookups("name");conversationDefn.talkNodeDefns=TalkNodeDefn.Instances()._All;return conversationDefn;};ConversationDefn.prototype.serialize=function (){var talkNodeDefnsToRestore=this.talkNodeDefns;delete this.talkNodeDefns;var returnValue=JSON.stringify(this,null,4);this.talkNodeDefns=talkNodeDefnsToRestore;return returnValue;};}function ConversationRun(defn,quit,universe){this.defn=defn;this.quit=quit;this.universe=universe;var talkNodeStart=this.defn.talkNodes[0];this.scopeCurrent=new ConversationScope(null,talkNodeStart,[]);this.talkNodesForTranscript=[];this.variableLookup={};this.vars=this.variableLookup;this.uni=this.universe;}{ConversationRun.prototype.next=function (){var responseSelected=this.scopeCurrent.talkNodeForOptionSelected;if(responseSelected!=null){var talkNodePrompt=this.scopeCurrent.talkNodeCurrent;talkNodePrompt.activate(this,this.scopeCurrent);responseSelected.activate(this,this.scopeCurrent);this.scopeCurrent.talkNodeForOptionSelected=null;}this.update();};ConversationRun.prototype.update=function (){this.scopeCurrent.update(this);};ConversationRun.prototype.toControl=function (size,universe){var conversationRun=this;var conversationDefn=conversationRun.defn;var venueToReturnTo=universe.venueCurrent;var fontHeight=20;var fontHeightShort=fontHeight*.6;var marginWidth=25;var labelHeight=fontHeight;var buttonHeight=25;var marginSize=new Coords(1,1).multiplyScalar(marginWidth);var listSize=new Coords(size.x/2,size.y-labelHeight-buttonHeight-marginSize.y*6 );var buttonSize=new Coords(listSize.x,buttonHeight);var buttonTranscriptSize=new Coords(2,1).multiplyScalar(buttonHeight);var returnValue=new ControlContainer("containerConversation",new Coords(0,0),size,[new ControlButton("buttonBack",marginSize,new Coords(1,1).multiplyScalar(buttonHeight),"<",fontHeight,true,true,function click(universe){var venueNext=venueToReturnTo;venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},universe),new ControlButton("buttonTranscript",new Coords(size.x-marginSize.x-buttonTranscriptSize.x,marginSize.y),buttonTranscriptSize,"Log",fontHeight,true,true,function click(universe){var venueCurrent=universe.venueCurrent;var transcriptAsControl=conversationRun.toControlTranscript(size,universe,venueCurrent);var venueNext=new VenueControls(transcriptAsControl);venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},universe),new ControlLabel("labelSpeaker",new Coords(size.x/2,size.y-marginSize.y*3 -buttonSize.y-listSize.y-labelHeight),size,true,new DataBinding(conversationRun,"scopeCurrent.displayTextCurrent"),fontHeight),new ControlList("listResponses",new Coords((size.x-listSize.x)/2,size.y-marginSize.y*2 -buttonSize.y-listSize.y),listSize,new DataBinding(conversationRun,"scopeCurrent.talkNodesForOptionsActive()"),new DataBinding(null,"text"),fontHeightShort,new DataBinding(conversationRun,"scopeCurrent.talkNodeForOptionSelected"),new DataBinding()),new ControlButton("buttonNext",new Coords((size.x-listSize.x)/2,size.y-marginSize.y-buttonSize.y),buttonSize,"Next",fontHeight,true,true,function click(universe){conversationRun.next();},universe),]);return returnValue;};ConversationRun.prototype.toControlTranscript=function (size,universe,venueToReturnTo){var conversationRun=this;var conversationDefn=conversationRun.defn;var venueToReturnTo=universe.venueCurrent;var fontHeight=20;var fontHeightShort=fontHeight*.6;var marginWidth=25;var labelHeight=fontHeight;var buttonHeight=25;var marginSize=new Coords(1,1).multiplyScalar(marginWidth);var listSize=new Coords(size.x*.75,size.y-labelHeight-marginSize.y*3
);var returnValue=new ControlContainer("containerConversation",new Coords(0,0),size,[new ControlButton("buttonBack",marginSize,new Coords(1,1).multiplyScalar(buttonHeight),"<",fontHeight,true,true,function click(universe){var venueNext=venueToReturnTo;venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;},universe),new ControlLabel("labelTranscript",new Coords(size.x/2,marginSize.y),size,true,"Transcript",fontHeight),new ControlList("listEntries",new Coords((size.x-listSize.x)/2,marginSize.y*2 +labelHeight),listSize,new DataBinding(conversationRun,"talkNodesForTranscript"),new DataBinding(null,"textForTranscript(conversationDefn)",{"conversationDefn":conversationDefn}),fontHeightShort),]);return returnValue;};}function ConversationScope(parent,talkNodeCurrent,talkNodesForOptions){this.parent=parent;this.talkNodeCurrent=talkNodeCurrent;this.isPromptingForResponse=false;this.talkNodesForOptions=talkNodesForOptions;this.displayTextCurrent="[conversation begins]";this.talkNodeForOptionSelected=null;this._talkNodesForOptionsActive=[];this._emptyArray=[];this.haveOptionsBeenUpdated=true;}{ConversationScope.prototype.talkNodeAdvance=function (conversationRun){var conversationDefn=conversationRun.defn;var defnTalkNodes=conversationDefn.talkNodes;var talkNodeIndex=defnTalkNodes.indexOf (this.talkNodeCurrent);var talkNodeNext=defnTalkNodes[talkNodeIndex+1];this.talkNodeCurrent=talkNodeNext;};ConversationScope.prototype.talkNodesForOptionsActive=function (){if(this.isPromptingForResponse==false){return this._emptyArray;}else {if(this.haveOptionsBeenUpdated==true){this.haveOptionsBeenUpdated=false;this._talkNodesForOptionsActive.length=0;for(var i=0;i<this.talkNodesForOptions.length;i++){var talkNode=this.talkNodesForOptions[i];if(talkNode.isActive==true){this._talkNodesForOptionsActive.push(talkNode);}}}returnValues=this._talkNodesForOptionsActive;}return returnValues;};ConversationScope.prototype.update=function (conversationRun){this.haveOptionsBeenUpdated=true;this.talkNodeCurrent.execute(conversationRun,this);};}function TalkNode(name,defnName,text,next,isActive){this.name=(name==null?TalkNode.idNext():name);this.defnName=defnName;this.text=text;this.next=next;this.isActive=(isActive==null?true:isActive);}{TalkNode._idNext=0;TalkNode.idNext=function (){var returnValue="_"+TalkNode._idNext;TalkNode._idNext++;return returnValue;};TalkNode.prototype.activate=function (conversationRun,scope){var defn=this.defn(conversationRun.defn);if(defn.activate!=null){defn.activate(conversationRun,scope,this);}};TalkNode.prototype.defn=function (conversationDefn){return conversationDefn.talkNodeDefns[this.defnName];};TalkNode.prototype.execute=function (conversationRun,scope){var defn=this.defn(conversationRun.defn);defn.execute(conversationRun,scope,this);};TalkNode.prototype.textForTranscript=function (conversationDefn){var speakerName=(this.defnName=="Option"?"YOU":"THEY");var returnValue=speakerName+": "+this.text;return returnValue;};}function TalkNodeDefn(name,execute,activate){this.name=name;this.execute=execute;this.activate=activate;}{TalkNodeDefn.Instances=function (){if(this._instances==null){this._instances=new TalkNodeDefn_Instances();}return this._instances;};function TalkNodeDefn_Instances(){this.Activate=new TalkNodeDefn("Activate",function execute(conversationRun,scope,talkNode){var talkNodeToActivateName=talkNode.next;var isActiveValueToSet=talkNode.text;var conversationDefn=conversationRun.defn;var talkNodeToActivate=conversationDefn.talkNodes[talkNodeToActivateName];talkNodeToActivate.isActive=isActiveValueToSet;scope.talkNodeAdvance(conversationRun);conversationRun.update();});this.Display=new TalkNodeDefn("Display",function (conversationRun,scope,talkNode){scope.displayTextCurrent=talkNode.text;scope.talkNodeAdvance(conversationRun);conversationRun.talkNodesForTranscript.push(talkNode);});this.Goto=new TalkNodeDefn("Goto",function (conversationRun,scope,talkNode){var talkNodeNameNext=talkNode.next;scope.talkNodeCurrent=conversationRun.defn.talkNodeByName(talkNodeNameNext);conversationRun.update();});this.JumpIfFalse=new TalkNodeDefn("JumpIfFalse",function (conversationRun,scope,talkNode){var variableName=talkNode.text;var talkNodeNameToJumpTo=talkNode.next;var variableValue=conversationRun.variableLookup[variableName];if(variableValue==true){scope.talkNodeAdvance(conversationRun);}else {scope.talkNodeCurrent=conversationRun.defn.talkNodeByName(talkNodeNameToJumpTo);}conversationRun.update();});this.JumpIfTrue=new TalkNodeDefn("JumpIfTrue",function (conversationRun,scope,talkNode){var variableName=talkNode.text;var talkNodeNameToJumpTo=talkNode.next;var variableValue=conversationRun.variableLookup[variableName];if(variableValue==true){scope.talkNodeCurrent=conversationRun.defn.talkNodeByName(talkNodeNameToJumpTo);}else {scope.talkNodeAdvance(conversationRun);}conversationRun.update();});this.Option=new TalkNodeDefn("Option",function execute(conversationRun,scope,talkNode){var talkNodesForOptions=scope.talkNodesForOptions;if(talkNodesForOptions.contains(talkNode)==false){talkNodesForOptions.push(talkNode);talkNodesForOptions[talkNode.name]=talkNode;}scope.talkNodeAdvance(conversationRun);conversationRun.update();},function activate(conversationRun,scope,talkNode){scope.isPromptingForResponse=false;var nameOfTalkNodeNext=talkNode.next;var talkNodeNext=conversationRun.defn.talkNodeByName(nameOfTalkNodeNext);scope.talkNodeCurrent=talkNodeNext;conversationRun.talkNodesForTranscript.push(talkNode);});this.Pop=new TalkNodeDefn("Pop",function execute(conversationRun,scope,talkNode){var scope=scope.parent;conversationRun.scopeCurrent=scope;scope.talkNodeCurrent=conversationRun.defn.talkNodeByName(talkNode.text);conversationRun.update();});this.Prompt=new TalkNodeDefn("Prompt",function execute(conversationRun,scope,talkNode){scope.isPromptingForResponse=true;},function activate(conversationRun,scope,talkNode){var shouldClearOptions=talkNode.text;if(shouldClearOptions==true){scope.talkNodesForOptions.length=0;}});this.Push=new TalkNodeDefn("Push",function execute(conversationRun,scope,talkNode){var runDefn=conversationRun.defn;var talkNodeIndex=runDefn.talkNodes.indexOf (talkNode);var talkNodeNext=runDefn.talkNodes[talkNodeIndex+1];conversationRun.scopeCurrent=new ConversationScope(scope,talkNodeNext,[]);conversationRun.update();});this.Quit=new TalkNodeDefn("Quit",function execute(conversationRun,scope,talkNode){conversationRun.quit();});this.Script=new TalkNodeDefn("Script",function execute(conversationRun,scope,talkNode){var scriptToRunAsString="("+talkNode.text+")";var scriptToRun=eval(scriptToRunAsString);scriptToRun(conversationRun);scope.talkNodeAdvance(conversationRun);conversationRun.update();});this.VariableLoad=new TalkNodeDefn("VariableLoad",function execute(conversationRun,scope,talkNode){var variableName=talkNode.text;var scriptExpression=talkNode.next;var scriptToRunAsString="( function(cr) { return "+scriptExpression+"; } )";var scriptToRun=eval(scriptToRunAsString);var scriptResult=scriptToRun(conversationRun);conversationRun.variableLookup[variableName]=scriptResult;scope.talkNodeAdvance(conversationRun);conversationRun.update();});this.VariableSet=new TalkNodeDefn("VariableSet",function execute(conversationRun,scope,talkNode){var variableName=talkNode.text;var variableValue=talkNode.next;conversationRun.variableLookup[variableName]=variableValue;scope.talkNodeAdvance(conversationRun);conversationRun.update();});this.VariableStore=new TalkNodeDefn("VariableStore",function execute(conversationRun,scope,talkNode){var variableName=talkNode.text;var variableValue=conversationRun.variableLookup[variableName];var scriptExpression=talkNode.next;var scriptToRunAsString="( function(cr) { "+scriptExpression+" = "+variableValue+"; } )";var scriptToRun=eval(scriptToRunAsString);scriptToRun(conversationRun);scope.talkNodeAdvance(conversationRun);conversationRun.update();});this._All=[this.Activate,this.Display,this.Goto,this.JumpIfFalse,this.JumpIfTrue,this.Option,this.Pop,this.Prompt,this.Push,this.Quit,this.Script,this.VariableLoad,this.VariableSet,this.VariableStore,].addLookups("name");}}function Color(name,code,componentsRGBA){this.name=name;this.code=code;this.componentsRGBA=componentsRGBA;}{Color.NumberOfComponentsRGBA=4;Color.Instances=function (){if(Color._Instances==null){Color._Instances=this;this._Transparent=new Color("Transparent",".",[0,0,0,0]);this.Black=new Color("Black","k",[0,0,0,1]);this.Blue=new Color("Blue","b",[0,0,1,1]);this.BlueDark=new Color("BlueDark","B",[0,0,.5,1]);this.Brown=new Color("Brown","O",[0.5,0.25,0,1]);this.Cyan=new Color("Cyan","c",[0,1,1,1]);this.Gray=new Color("Gray","a",[0.5,0.5,0.5,1]);this.GrayDark=new Color("GrayDark","A",[0.25,0.25,0.25,1]);this.GrayLight=new Color("GrayLight","@",[0.75,0.75,0.75,1]);this.Green=new Color("Green","g",[0,1,0,1]);this.GreenDark=new Color("GreenDark","G",[0,.5,0,1]);this.Orange=new Color("Orange","o",[1,0.5,0,1]);this.Red=new Color("Red","r",[1,0,0,1]);this.RedDark=new Color("RedDark","R",[.5,0,0,1]);this.Violet=new Color("Violet","v",[1,0,1,1]);this.White=new Color("White","w",[1,1,1,1]);this.Yellow=new Color("Yellow","y",[1,1,0,1]);this.YellowDark=new Color("Yellow","Y",[.5,.5,0,1]);this._All=[this._Transparent,this.Black,this.Blue,this.BlueDark,this.Brown,this.Cyan,this.Gray,this.GrayDark,this.GrayLight,this.Green,this.GreenDark,this.Orange,this.Red,this.RedDark,this.Violet,this.White,this.Yellow,this.YellowDark,];this._All.addLookups("code");}return Color._Instances;};Color.prototype.alpha=function (){return this.componentsRGBA[3];};Color.prototype.alphaSet=function (valueToSet){if(valueToSet!=null){this.componentsRGBA[3]=valueToSet;this._systemColor=null;}return this;};Color.prototype.clone=function (){return new Color(this.name,this.code,this.componentsRGBA.slice());};Color.prototype.systemColor=function (){if(this._systemColor==null){this._systemColor="rgba("+Math.floor(255 *this.componentsRGBA[0])+", "+Math.floor(255 *this.componentsRGBA[1])+", "+Math.floor(255 *this.componentsRGBA[2])+", "+this.componentsRGBA[3]+")";}return this._systemColor;};}function Display(sizesAvailable,fontName,fontHeightInPixels,colorFore,colorBack){this.sizesAvailable=sizesAvailable;this.sizeDefault=this.sizesAvailable[0];this.sizeInPixels=this.sizeDefault;this.fontName=fontName;this.fontHeightInPixels=fontHeightInPixels;this.colorFore=colorFore;this.colorBack=colorBack;this.fontNameFallthrough="serif";this.testString="ABCDEFGHIJKMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz 1234567890";this.drawPos=new Coords();this.drawLoc=new Location(this.drawPos);this.drawPos2=new Coords();this.drawPos3=new Coords();this.sizeHalf=new Coords();}{Display.RadiansPerTurn=Math.PI*2.0;Display.prototype.clear=function (){this.graphics.clearRect(0,0,this.sizeInPixels.x,this.sizeInPixels.y);};Display.prototype.drawArc=function (center,radiusInner,radiusOuter,angleStartInTurns,angleStopInTurns,colorFill,colorBorder){var drawPos=this.drawPos.overwriteWith(center);var angleStartInRadians=angleStartInTurns*Display.RadiansPerTurn;var angleStopInRadians=angleStopInTurns*Display.RadiansPerTurn;if(colorFill!=null){this.graphics.fillStyle=colorFill;this.graphics.beginPath();this.graphics.arc(center.x,center.y,radiusInner,angleStartInRadians,angleStopInRadians);drawPos.overwriteWith(center).add(new Polar(angleStopInTurns,radiusOuter).toCoords(new Coords()));this.graphics.lineTo(drawPos.x,drawPos.y);this.graphics.arc(center.x,center.y,radiusOuter,angleStopInRadians,angleStartInRadians,true);this.graphics.closePath();this.graphics.fill();}if(colorBorder!=null){this.graphics.strokeStyle=colorBorder;this.graphics.beginPath();this.graphics.arc(center.x,center.y,radiusInner,angleStartInRadians,angleStopInRadians);drawPos.overwriteWith(center).add(new Polar(angleStopInTurns,radiusOuter).toCoords(new Coords()));this.graphics.lineTo(drawPos.x,drawPos.y);this.graphics.arc(center.x,center.y,radiusOuter,angleStopInRadians,angleStartInRadians,true);this.graphics.closePath();this.graphics.stroke();}};Display.prototype.drawBackground=function (colorBorder,colorBack){this.drawRectangle(new Coords(0,0),this.sizeDefault,(colorBack==null?this.colorBack:colorBack),(colorBorder==null?this.colorFore:colorBorder));};Display.prototype.drawCircle=function (center,radius,colorFill,colorBorder){var drawPos=this.drawPos.overwriteWith(center);this.graphics.beginPath();this.graphics.arc(drawPos.x,drawPos.y,radius,0,Display.RadiansPerTurn);if(colorFill!=null){this.graphics.fillStyle=colorFill;this.graphics.fill();}if(colorBorder!=null){this.graphics.strokeStyle=colorBorder;this.graphics.stroke();}};Display.prototype.drawCircleWithGradient=function (center,radius,gradientFill,colorBorder){this.graphics.beginPath();this.graphics.arc(center.x,center.y,radius,0,Display.RadiansPerTurn);var systemGradient=this.graphics.createRadialGradient(center.x,center.y,0,center.x,center.y,radius);var gradientStops=gradientFill.stops;for(var i=0;i<gradientStops.length;i++){var stop=gradientStops[i];systemGradient.addColorStop(stop.position,stop.color);}this.graphics.fillStyle=systemGradient;this.graphics.fill();if(colorBorder!=null){this.graphics.strokeStyle=colorBorder;this.graphics.stroke();}};Display.prototype.drawCrosshairs=function (center,radius,color){var drawPos=this.drawPos.overwriteWith(center);this.graphics.beginPath();this.graphics.strokeStyle=color;this.graphics.moveTo(drawPos.x-radius,drawPos.y);this.graphics.lineTo(drawPos.x+radius,drawPos.y);this.graphics.moveTo(drawPos.x,drawPos.y-radius);this.graphics.lineTo(drawPos.x,drawPos.y+radius);this.graphics.stroke();};Display.prototype.drawEllipse=function (center,semimajorAxis,semiminorAxis,rotationInTurns,colorFill,colorBorder){var drawPos=this.drawPos.overwriteWith(center);this.graphics.save();this.graphics.translate(center.x,center.y);var rotationInRadians=rotationInTurns*Polar.RadiansPerTurn;this.graphics.rotate(rotationInRadians);var ratioOfHeightToWidth=semiminorAxis/semimajorAxis;this.graphics.scale(1,ratioOfHeightToWidth);this.graphics.beginPath();this.graphics.arc(0,0,semimajorAxis,0,Math.PI*2.0 );if(colorFill!=null){this.graphics.fillStyle=colorFill;this.graphics.fill();}if(colorBorder!=null){this.graphics.strokeStyle=colorBorder;this.graphics.stroke();}this.graphics.restore();};Display.prototype.drawImage=function (imageToDraw,pos,size){var systemImage=imageToDraw.systemImage;if(size==null){this.graphics.drawImage(systemImage,pos.x,pos.y);}else {try{this.graphics.drawImage(systemImage,pos.x,pos.y,size.x,size.y);}catch (ex){}}};Display.prototype.drawLine=function (fromPos,toPos,color){var drawPos=this.drawPos;this.graphics.strokeStyle=color;this.graphics.beginPath();drawPos.overwriteWith(fromPos);this.graphics.moveTo(drawPos.x,drawPos.y);drawPos.overwriteWith(toPos);this.graphics.lineTo(drawPos.x,drawPos.y);this.graphics.stroke();};Display.prototype.drawPixel=function (pos,color){this.graphics.fillStyle=color;this.graphics.fillRect(pos.x,pos.y,1,1
);};Display.prototype.drawPolygon=function (vertices,colorFill,colorBorder){this.graphics.beginPath();var drawPos=this.drawPos;for(var i=0;i<vertices.length;i++){var vertex=vertices[i];drawPos.overwriteWith(vertex);if(i==0){this.graphics.moveTo(drawPos.x,drawPos.y);}else {this.graphics.lineTo(drawPos.x,drawPos.y);}}this.graphics.closePath();if(colorFill!=null){this.graphics.fillStyle=colorFill;this.graphics.fill();}if(colorBorder!=null){this.graphics.strokeStyle=colorBorder;this.graphics.stroke();}};Display.prototype.drawRectangle=function (pos,size,colorFill,colorBorder,areColorsReversed){if(areColorsReversed==true){var temp=colorFill;colorFill=colorBorder;colorBorder=temp;}if(colorFill!=null){this.graphics.fillStyle=colorFill;this.graphics.fillRect(pos.x,pos.y,size.x,size.y);}if(colorBorder!=null){this.graphics.strokeStyle=colorBorder;this.graphics.strokeRect(pos.x,pos.y,size.x,size.y);}};Display.prototype.drawRectangleCentered=function (pos,size,colorFill,colorBorder){var sizeHalf=this.sizeHalf.overwriteWith(size).half();var posAdjusted=this.drawPos.overwriteWith(pos).subtract(sizeHalf);this.drawRectangle(posAdjusted,size,colorFill,colorBorder);};Display.prototype.drawText=function (text,fontHeightInPixels,pos,colorFill,colorOutline,areColorsReversed,isCentered,widthMaxInPixels){var fontToRestore=this.graphics.font;if(fontHeightInPixels==null){fontHeightInPixels=this.fontHeightInPixels;}this.fontSizeSet(fontHeightInPixels);if(areColorsReversed==true){var temp=colorFill;colorFill=colorOutline;colorOutline=temp;}var textTrimmed=text;if(widthMaxInPixels!=null){while(this.textWidthForFontHeight(textTrimmed,fontHeightInPixels)>widthMaxInPixels){textTrimmed=textTrimmed.substr(0,textTrimmed.length-1);}}var textWidthInPixels=this.textWidthForFontHeight(textTrimmed,fontHeightInPixels);var drawPos=new Coords(pos.x,pos.y+fontHeightInPixels);if(isCentered==true){drawPos.addDimensions(0 -textWidthInPixels/2,0 -fontHeightInPixels/2,0);}if(colorOutline!=null){this.graphics.strokeStyle=colorOutline;this.graphics.strokeText(textTrimmed,drawPos.x,drawPos.y);}if(colorFill!=null){this.graphics.fillStyle=colorFill;this.graphics.fillText(textTrimmed,drawPos.x,drawPos.y);}this.graphics.font=fontToRestore;};Display.prototype.fontSizeSet=function (fontHeightInPixels){var isFontValid=this.fontValidate(this.fontName);var fontNameToUse=(isFontValid==true?this.fontName:"sans-serif");this.graphics.font=fontHeightInPixels+"px "+fontNameToUse;};Display.prototype.fontValidate=function (fontName){this.graphics.font=""+this.fontHeightInPixels+"px "+fontName;var widthWithFontSpecified=this.graphics.measureText(this.testString).width;var returnValue=(widthWithFontSpecified!=this.widthWithFontFallthrough);return returnValue;};Display.prototype.hide=function (universe){universe.platformHelper.domElementRemove(this.canvas);};Display.prototype.initialize=function (universe){var platformHelper=universe.platformHelper;platformHelper.initialize(universe);if(this.canvas!=null){platformHelper.domElementRemove(this.canvas);}this.initializeCanvasAndGraphicsContext();platformHelper.domElementAdd(this.canvas);};Display.prototype.initializeCanvasAndGraphicsContext=function (){this.canvas=document.createElement("canvas");this.canvas.width=this.sizeInPixels.x;this.canvas.height=this.sizeInPixels.y;this.graphics=this.canvas.getContext("2d");this.graphics.font=""+this.fontHeightInPixels+"px "+this.fontNameFallthrough;this.widthWithFontFallthrough=this.graphics.measureText(this.testString).width;var sizeBase=this.sizesAvailable[0];this.scaleFactor=this.sizeInPixels.clone().divide(sizeBase);this.graphics.scale(this.scaleFactor.x,this.scaleFactor.y);return this;};Display.prototype.show=function (universe){universe.platformHelper.domElementAdd(this.canvas);};Display.prototype.textWidthForFontHeight=function (textToMeasure,fontHeightInPixels){var fontToRestore=this.graphics.font;this.fontSizeSet(fontHeightInPixels);var returnValue=this.graphics.measureText(textToMeasure).width;this.graphics.font=fontToRestore;return returnValue;};Display.prototype.toImage=function (){return Image.fromSystemImage("[fromDisplay]",this.canvas);};}function Display3D(sizeInPixels,fontName,fontHeightInPixels,colorFore,colorBack){this.sizeInPixels=sizeInPixels;this.sizeDefault=sizeInPixels;this.scaleFactor=new Coords(1,1,1);this._display2DOverlay=new Display([sizeInPixels],fontName,fontHeightInPixels,colorFore,colorBack);}{Display3D.VerticesPerTriangle=3;Display3D.prototype.cameraSet=function (camera){var cameraLoc=camera.loc;var matrixCamera=this.matrixCamera.overwriteWithTranslate(cameraLoc.pos.clone().multiplyScalar(-1)).multiply(this.matrixOrient.overwriteWithOrientationCamera(cameraLoc.orientation)).multiply(this.matrixPerspective.overwriteWithPerspectiveForCamera(camera));var webGLContext=this.webGLContext;var gl=webGLContext.gl;var shaderProgram=webGLContext.shaderProgram;gl.uniformMatrix4fv(shaderProgram.cameraMatrix,false,matrixCamera.toWebGLArray());};Display3D.prototype.clear=function (){var webGLContext=this.webGLContext;var gl=webGLContext.gl;var shaderProgram=webGLContext.shaderProgram;gl.viewport(0,0,gl.viewportWidth,gl.viewportHeight);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);};Display3D.prototype.drawMesh=function (mesh){var webGLContext=this.webGLContext;var gl=webGLContext.gl;var shaderProgram=webGLContext.shaderProgram;var vertexPositionsAsFloatArray=[];var vertexColorsAsFloatArray=[];var vertexNormalsAsFloatArray=[];var vertexTextureUVsAsFloatArray=[];var numberOfTrianglesSoFar=0;var materials=mesh.materials;var faces=mesh.faces();var faceTextures=mesh.faceTextures;var faceIndicesByMaterial=mesh.faceIndicesByMaterial();for(var m=0;m<materials.length;m++){var material=materials[m];var materialName=material.name;var faceIndices=faceIndicesByMaterial[materialName];for(var fi=0;fi<faceIndices.length;fi++){var f=faceIndices[fi];var face=faces[f];var faceMaterial=face.material;var faceGeometry=face.geometry;var faceNormal=faceGeometry.plane().normal;var vertexNormalsForFaceVertices=mesh.vertexNormalsForFaceVertices;var vertexIndicesForTriangles=[[0,1,2]];var faceVertices=faceGeometry.vertices;var numberOfVerticesInFace=faceVertices.length;if(numberOfVerticesInFace==4){vertexIndicesForTriangles.push([0,2,3]);}for(var t=0;t<vertexIndicesForTriangles.length;t++){var vertexIndicesForTriangle=vertexIndicesForTriangles[t];for(var vi=0;vi<vertexIndicesForTriangle.length;vi++){var vertexIndex=vertexIndicesForTriangle[vi];var vertex=faceVertices[vertexIndex];vertexPositionsAsFloatArray=vertexPositionsAsFloatArray.concat(vertex.dimensions());var vertexColor=faceMaterial.colorFill;vertexColorsAsFloatArray=vertexColorsAsFloatArray.concat(vertexColor.componentsRGBA);var vertexNormal=(vertexNormalsForFaceVertices==null?faceNormal:vertexNormalsForFaceVertices[f][vertexIndex]);vertexNormalsAsFloatArray=vertexNormalsAsFloatArray.concat(vertexNormal.dimensions());var vertexTextureUV=(faceTextures==null?new Coords(-1,-1):faceTextures[f]==null?new Coords(-1,-1):faceTextures[f].textureUVs[vertexIndex]);vertexTextureUVsAsFloatArray=vertexTextureUVsAsFloatArray.concat([vertexTextureUV.x,vertexTextureUV.y]);}}numberOfTrianglesSoFar+=vertexIndicesForTriangles.length;}var colorBuffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,colorBuffer);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(vertexColorsAsFloatArray),gl.STATIC_DRAW);gl.vertexAttribPointer(shaderProgram.vertexColorAttribute,Color.NumberOfComponentsRGBA,gl.FLOAT,false,0,0
);var normalBuffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,normalBuffer);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(vertexNormalsAsFloatArray),gl.STATIC_DRAW);gl.vertexAttribPointer(shaderProgram.vertexNormalAttribute,Coords.NumberOfDimensions,gl.FLOAT,false,0,0
);var positionBuffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,positionBuffer);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(vertexPositionsAsFloatArray),gl.STATIC_DRAW);gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute,Coords.NumberOfDimensions,gl.FLOAT,false,0,0
);var texture=material.texture;if(texture!=null){var textureName=texture.name;var textureRegistered=this.texturesRegistered[textureName];if(textureRegistered==null){texture.initializeForWebGLContext(this.webGLContext);this.texturesRegistered[textureName]=texture;}gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,texture.systemTexture);}gl.uniform1i(shaderProgram.samplerUniform,0);var textureBuffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,textureBuffer);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(vertexTextureUVsAsFloatArray),gl.STATIC_DRAW);gl.vertexAttribPointer(shaderProgram.vertexTextureUVAttribute,2,gl.FLOAT,false,0,0
);gl.drawArrays(gl.TRIANGLES,0,numberOfTrianglesSoFar*Display3D.VerticesPerTriangle);}};Display3D.prototype.drawMeshWithOrientation=function (mesh,meshOrientation){var matrixOrient=this.matrixOrient;var matrixEntity=this.matrixEntity.overwriteWithOrientationMover(meshOrientation).multiply(matrixOrient.overwriteWithOrientationEntity(meshOrientation));var webGLContext=this.webGLContext;var gl=webGLContext.gl;var shaderProgram=webGLContext.shaderProgram;gl.uniformMatrix4fv(shaderProgram.normalMatrix,false,matrixOrient.toWebGLArray());gl.uniformMatrix4fv(shaderProgram.entityMatrix,false,matrixEntity.toWebGLArray());this.drawMesh(mesh);};Display3D.prototype.initialize=function (universe){var platformHelper=universe.platformHelper;platformHelper.initialize(universe);if(this.canvas!=null){platformHelper.domElementRemove(this.canvas);}this.canvas=document.createElement("canvas");this.canvas.style.position="absolute";this.canvas.width=this.sizeInPixels.x;this.canvas.height=this.sizeInPixels.y;divMain.appendChild(this.canvas);this.webGLContext=new WebGLContext(this.canvas);this.texturesRegistered=[];this.lighting=new Lighting(.5,new Coords(-1,-1,-1),.3 );this._display2DOverlay.initialize(universe);this.matrixEntity=Matrix.buildZeroes();this.matrixCamera=Matrix.buildZeroes();this.matrixOrient=Matrix.buildZeroes();this.matrixPerspective=Matrix.buildZeroes();this.matrixTranslate=Matrix.buildZeroes();this.tempCoords=new Coords(0,0,0);this.tempMatrix0=Matrix.buildZeroes();this.tempMatrix1=Matrix.buildZeroes();};Display3D.prototype.lightingSet=function (todo){var webGLContext=this.webGLContext;var gl=webGLContext.gl;var shaderProgram=webGLContext.shaderProgram;var lighting=this.lighting;gl.uniform1f(shaderProgram.lightAmbientIntensity,lighting.ambientIntensity);gl.uniform3fv(shaderProgram.lightDirection,WebGLContext.coordsToWebGLArray(lighting.direction));gl.uniform1f(shaderProgram.lightDirectionalIntensity,lighting.directionalIntensity);};Display3D.prototype.clear=function (){this._display2DOverlay.clear();};Display3D.prototype.drawArc=function (center,radiusInner,radiusOuter,angleStartInTurns,angleStopInTurns,colorFill,colorBorder){this._display2DOverlay.drawArc(center,radiusInner,radiusOuter,angleStartInTurns,angleStopInTurns,colorFill,colorBorder);};Display3D.prototype.drawBackground=function (){this._display2DOverlay.drawBackground();};Display3D.prototype.drawCircle=function (center,radius,colorFill,colorBorder){this._display2DOverlay.drawCircle(center,radius,colorFill,colorBorder);};Display3D.prototype.drawCircleWithGradient=function (center,radius,gradientFill,colorBorder){this._display2DOverlay.drawCircleWithGradient(center,radius,gradientFill,colorBorder);};Display3D.prototype.drawImage=function (imageToDraw,pos,size){this._display2DOverlay.drawImage(imageToDraw,pos,size);};Display3D.prototype.drawLine=function (fromPos,toPos,color){this._display2DOverlay.drawLine(fromPos,toPos,color);};Display3D.prototype.drawPolygon=function (vertices,colorFill,colorBorder){this._display2DOverlay.drawPolygon(vertices,colorFill,colorBorder);};Display3D.prototype.drawRectangle=function (pos,size,colorFill,colorBorder,areColorsReversed){this._display2DOverlay.drawRectangle(pos,size,colorFill,colorBorder,areColorsReversed);};Display3D.prototype.drawText=function (text,fontHeightInPixels,pos,colorFill,colorOutline,areColorsReversed,isCentered,widthMaxInPixels){this._display2DOverlay.drawText(text,fontHeightInPixels,pos,colorFill,colorOutline,areColorsReversed,isCentered,widthMaxInPixels);};Display3D.prototype.fontSizeSet=function (fontHeightInPixels){this._display2DOverlay.fontSizeSet(fontHeightInPixels);};Display3D.prototype.fontValidate=function (fontName){this._display2DOverlay.fontValidate(fontName);};Display3D.prototype.hide=function (universe){this._display2DOverlay.hide(universe);};Display3D.prototype.show=function (universe){this._display2DOverlay.show(universe);};Display3D.prototype.textWidthForFontHeight=function (textToMeasure,fontHeightInPixels){return this._display2DOverlay.textWidthForFontHeight(textToMeasure,fontHeightInPixels);};}function FaceTextured(geometry,material){this.geometry=geometry;this.material=material;}function Gradient(stops){this.stops=stops;}function GradientStop(position,color){this.position=position;this.color=color;}function Lighting(ambientIntensity,direction,directionalIntensity){this.ambientIntensity=ambientIntensity;this.direction=direction.clone().normalize();this.directionalIntensity=directionalIntensity;}function Material(name,colorStroke,colorFill,texture){this.name=name;this.colorStroke=colorStroke;this.colorFill=colorFill;this.texture=texture;}{Material.Instances=function (){if(Material._Instances==null){Material._Instances=this;this.Default=new Material("Default",Color.Instances().Blue,Color.Instances().Yellow,null);}return Material._Instances;};}function Matrix(values){this.values=values;}{Matrix.buildZeroes=function (){var returnValue=new Matrix([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,]);return returnValue;};Matrix.prototype.clone=function (){var valuesCloned=[];for(var i=0;i<this.values.length;i++){valuesCloned[i]=this.values[i];}var returnValue=new Matrix(valuesCloned);return returnValue;};Matrix.prototype.divideScalar=function (scalar){for(var i=0;i<this.values.length;i++){this.values[i]/=scalar;}return this;};Matrix.prototype.multiply=function (other){var valuesMultiplied=[];for(var y=0;y<4;y++){for(var x=0;x<4;x++){var valueSoFar=0;for(var i=0;i<4;i++){valueSoFar+=other.values[y*4 +i]*this.values[i*4 +x];}valuesMultiplied[y*4 +x]=valueSoFar;}}this.overwriteWithValues(valuesMultiplied);return this;};Matrix.prototype.multiplyScalar=function (scalar){for(var i=0;i<this.values.length;i++){this.values[i]*=scalar;}return this;};Matrix.prototype.overwriteWith=function (other){for(var i=0;i<this.values.length;i++){this.values[i]=other.values[i];}return this;};Matrix.prototype.overwriteWithOrientationEntity=function (orientation){var forward=orientation.forward.clone().multiplyScalar(1);var right=orientation.right.clone().multiplyScalar(1);var down=orientation.down.clone().multiplyScalar(1);/*this.overwriteWithValues([right.x,down.x,forward.x,0,right.y,down.y,forward.y,0,right.z,down.z,forward.z,0,0,0,0,1,]);*/this.overwriteWithValues([forward.x,right.x,down.x,0,forward.y,right.y,down.y,0,forward.z,right.z,down.z,0,0,0,0,1,]);return this;};Matrix.prototype.overwriteWithOrientationCamera=function (orientation){var forward=orientation.forward.clone().multiplyScalar(1);var right=orientation.right.clone().multiplyScalar(1);var down=orientation.down.clone().multiplyScalar(1);this.overwriteWithValues([right.x,right.y,right.z,0,0-down.x,0-down.y,0-down.z,0,0-forward.x,0-forward.y,0-forward.z,0,0,0,0,1,]);return this;};Matrix.prototype.overwriteWithOrientationMover=function (orientation){var forward=orientation.forward.clone();var right=orientation.right.clone();var down=orientation.down.clone();this.overwriteWithValues([forward.x,forward.y,forward.z,0,right.x,right.y,right.z,0,down.x,down.y,down.z,0,0,0,0,1,]);return this;};Matrix.prototype.overwriteWithPerspectiveForCamera=function (camera){var viewSize=camera.viewSize;var clipDistanceNear=.001;var clipDistanceFar=camera.viewSize.z;var scaleFactorY=1.0 /Math.tan(viewSize.y/2);var scaleFactorX=scaleFactorY*viewSize.y/viewSize.x;var scaleFactorMultiplier=.7;scaleFactorX*=scaleFactorMultiplier;scaleFactorY*=scaleFactorMultiplier;var clipRange=clipDistanceNear-clipDistanceFar;var distanceFromFocusToClipPlaneFar=clipDistanceFar+clipDistanceNear;var clipDistanceSumOverDifference=distanceFromFocusToClipPlaneFar/clipRange;var clipDistanceProductOverDifference=(clipDistanceFar*clipDistanceNear)/clipRange;this.overwriteWithValues([scaleFactorX,0,0,0,0,scaleFactorY,0,0,0,0,clipDistanceSumOverDifference,2 *clipDistanceProductOverDifference,0,0,-1,0,]);return this;};Matrix.prototype.overwriteWithTranslate=function (displacement){this.overwriteWithValues([1,0,0,displacement.x,0,1,0,displacement.y,0,0,1,displacement.z,0,0,0,1,]);return this;};Matrix.prototype.overwriteWithValues=function (otherValues){for(var i=0;i<this.values.length;i++){this.values[i]=otherValues[i];}return this;};Matrix.prototype.toWebGLArray=function (){var returnValues=[];for(var x=0;x<4;x++){for(var y=0;y<4;y++){returnValues.push(this.values[(y*4 +x)]);}}var returnValues=new Float32Array(returnValues);return returnValues;};}function MeshTextured(geometry,materials,faceTextures,vertexGroups){this.geometry=geometry;this.materials=materials.addLookups("name");this.faceTextures=faceTextures;this.vertexGroups=vertexGroups;}{MeshTextured.prototype.faces=function (){if(this._faces==null){this._faces=[];var geometryFaces=this.geometry.faces();for(var i=0;i<geometryFaces.length;i++){var geometryFace=geometryFaces[i];var faceTexture=this.faceTextures[i];var faceMaterialName=faceTexture.materialName;var faceMaterial=this.materials[faceMaterialName];var face=new FaceTextured(geometryFace,faceMaterial);this._faces.push(face);}}return this._faces;};MeshTextured.prototype.faceTexturesBuild=function (){var materialName=this.materials[0].name;var faceTextures=[];var numberOfFaces=this.geometry.faceBuilders.length;for(var f=0;f<numberOfFaces;f++){var faceTexture=new MeshTexturedFaceTexture(materialName,[new Coords(0,0),new Coords(1,0),new Coords(1,1),new Coords(1,0)]);faceTextures.push(faceTexture);}this.faceTextures=faceTextures;return this;};MeshTextured.prototype.faceIndicesByMaterial=function (){if(this._faceIndicesByMaterial==null){this._faceIndicesByMaterial=[];for(var f=0;f<this.faceTextures.length;f++){var faceTexture=this.faceTextures[f];var faceMaterialName=faceTexture.materialName;var faceIndicesForMaterial=this._faceIndicesByMaterial[faceMaterialName];if(faceIndicesForMaterial==null){faceIndicesForMaterial=[];this._faceIndicesByMaterial[faceMaterialName]=faceIndicesForMaterial;}faceIndicesForMaterial.push(f);}}return this._faceIndicesByMaterial;};MeshTextured.prototype.transform=function (transformToApply){this.geometry.transform(transformToApply);return this;};MeshTextured.prototype.transformFaceTextures=function (transformToApply){for(var i=0;i<this.faceTextures.length;i++){var faceTexture=this.faceTextures[i];Transform.applyTransformToCoordsMany(transformToApply,faceTexture.textureUVs);}return this;};MeshTextured.prototype.clone=function (){return new MeshTextured(this.geometry.clone(),this.materials,(this.faceTextures==null?null:this.faceTextures.clone()),(this.vertexGroups==null?null:this.vertexGroups.clone()));};MeshTextured.prototype.overwriteWith=function (other){this.geometry.overwriteWith(other.geometry);return this;};}function MeshTexturedFaceTexture(materialName,textureUVs){this.materialName=materialName;this.textureUVs=textureUVs;}{MeshTexturedFaceTexture.prototype.clone=function (){return new MeshTexturedFaceTexture(this.materialName,this.textureUVs.clone());};}function Texture(name,image){this.name=name;this.image=image;}{Texture.prototype.initializeForWebGLContext=function (webGLContext){var gl=webGLContext.gl;this.systemTexture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,this.systemTexture);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,this.image.systemImage);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.REPEAT);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.REPEAT);gl.bindTexture(gl.TEXTURE_2D,null);};}function VenueFader(venueToFadeTo,venueToFadeFrom,backgroundColor,millisecondsPerFade){this.venuesToFadeFromAndTo=[venueToFadeFrom,venueToFadeTo];this.millisecondsPerFade=(millisecondsPerFade==null?250 :millisecondsPerFade);if(venueToFadeFrom==venueToFadeTo){this.venueIndexCurrent=1;this.millisecondsPerFade*=2;}else {this.venueIndexCurrent=0;}this.backgroundColor=(backgroundColor==null?Color.Instances().Black:backgroundColor);}{VenueFader.prototype.initialize=function (universe){var venueToFadeTo=this.venueToFadeTo();if(venueToFadeTo.initialize!=null){venueToFadeTo.initialize(universe);}};VenueFader.prototype.updateForTimerTick=function (universe){this.draw(universe);var now=new Date();if(this.timeFadeStarted==null){this.timeFadeStarted=now;}var millisecondsSinceFadeStarted=now-this.timeFadeStarted;var fractionOfFadeCompleted=millisecondsSinceFadeStarted/this.millisecondsPerFade;var alphaOfFadeColor;if(this.venueIndexCurrent==0){if(fractionOfFadeCompleted>1){fractionOfFadeCompleted=1;this.venueIndexCurrent++;this.timeFadeStarted=null;var venueToFadeTo=this.venuesToFadeFromAndTo[1];if(venueToFadeTo.draw==null){universe.venueNext=venueToFadeTo;}}alphaOfFadeColor=fractionOfFadeCompleted;}else {if(fractionOfFadeCompleted>1){fractionOfFadeCompleted=1;universe.venueNext=this.venueCurrent();}alphaOfFadeColor=1 -fractionOfFadeCompleted;}alphaOfFadeColor*=alphaOfFadeColor;var fadeColor=this.backgroundColor.clone().alphaSet(alphaOfFadeColor*this.backgroundColor.alpha());var display=universe.display;display.drawRectangle(new Coords(0,0),display.sizeDefault,fadeColor.systemColor());};VenueFader.prototype.venueToFadeTo=function (){return this.venuesToFadeFromAndTo[1];};VenueFader.prototype.venueCurrent=function (){return this.venuesToFadeFromAndTo[this.venueIndexCurrent];};VenueFader.prototype.draw=function (universe){var venueCurrent=this.venueCurrent();if(venueCurrent!=null){venueCurrent.draw(universe);}};}function VenueLayered(children,colorToOverlayBetweenChildren){this.children=children;this.colorToOverlayBetweenChildren=colorToOverlayBetweenChildren;}{VenueLayered.prototype.initialize=function (universe){for(var i=0;i<this.children.length;i++){var child=this.children[i];if(child.initialize!=null){child.initialize(universe);}}};VenueLayered.prototype.updateForTimerTick=function (universe){this.children[this.children.length-1].updateForTimerTick(universe);};VenueLayered.prototype.draw=function (universe){for(var i=0;i<this.children.length;i++){var child=this.children[i];child.draw(universe);if(this.colorToOverlayBetweenChildren!=null){var display=universe.display;display.drawRectangle(Coords.Instances().Zeroes,display.size,this.colorToOverlayBetweenChildren);}}};}function VertexGroup(name,vertexIndices){this.name=name;this.vertexIndices=vertexIndices;}{VertexGroup.prototype.clone=function (){return new VertexGroup(this.name,this.vertexIndices.slice());};}function VisualAnchor(child,posToAnchorAt){this.child=child;this.posToAnchorAt=posToAnchorAt;this.posSaved=new Coords();}{VisualAnchor.prototype.draw=function (universe,world,display,drawable,entity){var drawablePos=drawable.loc.pos;this.posSaved.overwriteWith(drawablePos);drawablePos.overwriteWith(this.posToAnchorAt);this.child.draw(universe,world,display,drawable,entity);drawablePos.overwriteWith(this.posSaved);};}function VisualAnimation(name,ticksPerFrame,frames,isRepeating){this.name=name;this.ticksPerFrame=ticksPerFrame;this.frames=frames;this.isRepeating=(isRepeating==null?true:isRepeating);this.ticksToComplete=this.frames.length*this.ticksPerFrame;}{VisualAnimation.prototype.draw=function (universe,world,display,drawable,entity){if(drawable.animationRuns==null){drawable.animationRuns={};}var animationRun=drawable.animationRuns[this.name];if(animationRun==null){animationRun=new AnimationRun(this);drawable.animationRuns[this.name]=animationRun;}animationRun.update(universe,world,display,drawable);};}function AnimationRun(defn){this.defn=defn;this.ticksSinceStarted=0;}{AnimationRun.prototype.frameCurrent=function (){var frameIndexCurrent=this.frameIndexCurrent();var frameCurrent=this.defn.frames[frameIndexCurrent];return frameCurrent;};AnimationRun.prototype.frameIndexCurrent=function (){return Math.floor(this.ticksSinceStarted/this.defn.ticksPerFrame);};AnimationRun.prototype.isComplete=function (){var returnValue=(this.ticksSinceStarted>=this.defn.ticksToComplete);return returnValue;};AnimationRun.prototype.update=function (universe,world,display,drawable){var frameCurrent=this.frameCurrent();frameCurrent.draw(universe,world,display,drawable);this.ticksSinceStarted++;if(this.isComplete()==true){if(this.defn.isRepeating==true){this.ticksSinceStarted=this.ticksSinceStarted.wrapToRangeMinMax(0,this.defn.ticksToComplete);}else {this.ticksSinceStarted=this.ticksSinceStarted.trimToRangeMax(this.defn.ticksToComplete-1);}}};}function VisualArc(arc,colorFill,colorBorder){this.arc=arc;this.colorFill=colorFill;this.colorBorder=colorBorder;this.drawPos=new Coords();}{VisualArc.prototype.draw=function (universe,world,display,drawable,entity){var arc=this.arc;var shell=arc.shell;var wedge=arc.wedge;var wedgeAngleMin=wedge.angleInTurnsMin();var wedgeAngleMax=wedge.angleInTurnsMax();var drawPos=this.drawPos.overwriteWith(drawable.loc.pos);display.drawArc(drawPos,shell.sphereInner.radius,shell.sphereOuter.radius,wedgeAngleMin,wedgeAngleMax,this.colorFill,this.colorBorder);};}function VisualCamera(child,camera){this.child=child;this.camera=camera;this.posSaved=new Coords();}{VisualCamera.prototype.draw=function (universe,world,display,drawable,entity){var drawablePos=drawable.loc.pos;this.posSaved.overwriteWith(drawablePos);this.camera.coordsTransformWorldToView(drawablePos);this.child.draw(universe,world,display,drawable,entity);drawablePos.overwriteWith(this.posSaved);};}function VisualCircle(radius,colorFill,colorBorder){this.radius=radius;this.colorFill=colorFill;this.colorBorder=colorBorder;}{VisualCircle.prototype.draw=function (universe,world,display,drawable,entity){display.drawCircle(drawable.loc.pos,this.radius,this.colorFill,this.colorBorder);};}function VisualCircleGradient(radius,gradientFill,colorBorder){this.radius=radius;this.gradientFill=gradientFill;this.colorBorder=colorBorder;}{VisualCircleGradient.prototype.draw=function (universe,world,display,drawable,entity){display.drawCircleWithGradient(drawable.loc.pos,this.radius,this.gradientFill,this.colorBorder);};}function VisualDirectional(visualForNoDirection,visualsForDirections){this.visualForNoDirection=visualForNoDirection;this.visualsForDirections=visualsForDirections;this.numberOfDirections=this.visualsForDirections.length;}{VisualDirectional.prototype.draw=function (universe,world,display,drawable,entity){var loc=drawable.loc;var headingInTurns=loc.orientation.headingInTurns();var visualForHeading;if(headingInTurns==null){visualForHeading=this.visualForNoDirection;}else {var direction=Math.round(headingInTurns*this.numberOfDirections).wrapToRangeMinMax(0,this.numberOfDirections);visualForHeading=this.visualsForDirections[direction];}visualForHeading.draw(universe,world,display,drawable);};}function VisualDynamic(methodForVisual){this.methodForVisual=methodForVisual;}{VisualDynamic.prototype.draw=function (universe,world,display,drawable,entity){var visual=this.methodForVisual.call(this,universe,world,drawable,entity);visual.draw(universe,world,display,drawable);};}function VisualEllipse(semimajorAxis,semiminorAxis,rotationInTurns,colorFill,colorBorder){this.semimajorAxis=semimajorAxis;this.semiminorAxis=semiminorAxis;this.rotationInTurns=rotationInTurns;this.colorFill=colorFill;this.colorBorder=colorBorder;}{VisualEllipse.prototype.draw=function (universe,world,display,drawable,entity){var drawableLoc=drawable.loc;display.drawEllipse(drawableLoc.pos,this.semimajorAxis,this.semiminorAxis,this.rotationInTurns,this.colorFill,this.colorBorder);};}function VisualGroup(children){this.children=children;}{VisualGroup.prototype.draw=function (universe,world,display,drawable,entity){for(var i=0;i<this.children.length;i++){var child=this.children[i];child.draw(universe,world,display,drawable,entity);}};}function VisualImageFromLibrary(imageName,sizeScaled){this.imageName=imageName;this._sizeScaled=sizeScaled;this.drawPos=new Coords();}{VisualImageFromLibrary.manyFromImages=function (images,imageSizeScaled){var returnValues=[];for(var i=0;i<images.length;i++){var image=images[i];var visual=new VisualImageFromLibrary(image.name,imageSizeScaled);returnValues.push(visual);}return returnValues;};VisualImageFromLibrary.prototype.image=function (universe){return universe.mediaLibrary.imageGetByName(this.imageName);};VisualImageFromLibrary.prototype.imageSizeScaled=function (universe){return (this._sizeScaled==null?this.image(universe).sizeInPixels:this._sizeScaled);};VisualImageFromLibrary.prototype.draw=function (universe,world,display,drawable,entity){var image=this.image(universe);var imageSize=this.imageSizeScaled(universe);var drawPos=this.drawPos.clear().subtract(imageSize).half().add(drawable.loc.pos);display.drawImage(image,drawPos,imageSize);};}function VisualImageImmediate(image,sizeScaled){this.image=image;this._drawPos=new Coords();}{VisualImageImmediate.manyFromImages=function (images,imageSizeScaled){var returnValues=[];for(var i=0;i<images.length;i++){var image=images[i];var visual=new VisualImageImmediate(image,imageSizeScaled);returnValues.push(visual);}return returnValues;};VisualImageImmediate.prototype.imageSizeScaled=function (universe){return (this._sizeScaled==null?this.image.sizeInPixels:this._sizeScaled);};VisualImageImmediate.prototype.draw=function (universe,world,display,drawable,entity){var image=this.image;var imageSize=this.imageSizeScaled(universe);var drawPos=this._drawPos.clear().subtract(imageSize).half().add(drawable.loc.pos);display.drawImage(image,drawPos,imageSize);};}function VisualLine(fromPos,toPos,color){this.fromPos=fromPos;this.toPos=toPos;this.color=color;this.drawPosFrom=new Coords();this.drawPosTo=new Coords();}{VisualLine.prototype.draw=function (universe,world,display,drawable){var pos=drawable.loc.pos;var drawPosFrom=this.drawPosFrom.overwriteWith(pos).add(this.fromPos);var drawPosTo=this.drawPosTo.overwriteWith(pos).add(this.toPos);display.drawLine(drawPosFrom,drawPosTo,this.color);};}function VisualMap(map,visualLookup){this.map=map;this.visualLookup=visualLookup;this.cell=this.map.cellPrototype.clone();this.cellPosInCells=new Coords();this.drawPos=new Coords();this.posSaved=new Coords();}{VisualMap.prototype.draw=function (universe,world,display,drawable,entity){var mapSizeInCells=this.map.sizeInCells;var mapSizeHalf=this.map.sizeHalf;var cellPosInCells=this.cellPosInCells;var cellSizeInPixels=this.map.cellSize;var drawablePos=drawable.loc.pos;for(var y=0;y<mapSizeInCells.y;y++){cellPosInCells.y=y;for(var x=0;x<mapSizeInCells.x;x++){cellPosInCells.x=x;var cell=this.map.cellAtPosInCells(this.map,cellPosInCells,this.cell);var cellVisualName=cell.visualName;var cellVisual=this.visualLookup[cellVisualName];var drawPos=this.drawPos.overwriteWith(cellPosInCells).multiply(cellSizeInPixels).subtract(mapSizeHalf).add(drawablePos);this.posSaved.overwriteWith(drawablePos);drawablePos.overwriteWith(drawPos);cellVisual.draw(universe,world,display,drawable,entity);drawablePos.overwriteWith(this.posSaved);}}};}function VisualNone(){}{VisualNone.prototype.draw=function (universe,world,display,drawable,entity){};}function VisualOffset(child,offset){this.child=child;this.offset=offset;this.posSaved=new Coords();}{VisualOffset.prototype.draw=function (universe,world,display,drawable,entity){var drawablePos=drawable.loc.pos;this.posSaved.overwriteWith(drawablePos);drawablePos.add(this.offset);this.child.draw(universe,world,display,drawable,entity);drawablePos.overwriteWith(this.posSaved);};}function VisualPolygon(verticesAsPath,colorFill,colorBorder){this.verticesAsPath=verticesAsPath;this.colorFill=colorFill;this.colorBorder=colorBorder;this.verticesAsPathTransformed=this.verticesAsPath.clone();this.transformTranslate=new Transform_Translate(new Coords());}{VisualPolygon.prototype.draw=function (universe,world,display,drawable,entity){var pos=drawable.loc.pos;this.transformTranslate.displacement.overwriteWith(drawable.loc.pos);this.verticesAsPathTransformed.overwriteWith(this.verticesAsPath);Transform.applyTransformToCoordsMany(this.transformTranslate,this.verticesAsPathTransformed.points);display.drawPolygon(this.verticesAsPathTransformed.points,this.colorFill,this.colorBorder);};}function VisualRay(length,color){this.length=length;this.color=color;this.polar=new Polar(0,this.length);this.toPos=new Coords();}{VisualRay.prototype.draw=function (universe,world,display,drawable,entity){var drawableLoc=drawable.loc;var drawablePos=drawableLoc.pos;this.polar.azimuthInTurns=drawableLoc.orientation.headingInTurns();this.polar.toCoords(this.toPos).add(drawablePos);display.drawLine(drawablePos,this.toPos,this.color);};}function VisualRectangle(size,colorFill,colorBorder){this.size=size;this.colorFill=colorFill;this.colorBorder=colorBorder;this.sizeHalf=this.size.clone().half();this._drawPos=new Coords();}{VisualRectangle.prototype.draw=function (universe,world,display,drawable,entity){var drawPos=this._drawPos.overwriteWith(drawable.loc.pos).subtract(this.sizeHalf);display.drawRectangle(drawPos,this.size,this.colorFill,this.colorBorder);};}function VisualRepeating(cellSize,viewSize,child){this.cellSize=cellSize;this.viewSize=viewSize;this.child=child;if(this.cellSize.z==0){throw "Invalid argument: cellSize.z must not be 0.";}this.viewSizeInCells=this.viewSize.clone().divide(this.cellSize);this._cellPos=new Coords();this._drawOffset=new Coords();this._drawPosWrapped=new Coords();this._drawablePosToRestore=new Coords();}{VisualRepeating.prototype.draw=function (universe,world,display,drawable,entity){var drawPos=drawable.loc.pos;this._drawablePosToRestore.overwriteWith(drawPos);var drawPosWrapped=this._drawPosWrapped.overwriteWith(drawPos).wrapToRangeMax(this.cellSize);var cellPos=this._cellPos;var viewSizeInCells=this.viewSizeInCells;for(var y=-1;y<viewSizeInCells.y+1;y++){cellPos.y=y;for(var x=-1;x<viewSizeInCells.x+1;x++){cellPos.x=x;drawPos.overwriteWith(this._drawOffset.overwriteWith(cellPos).multiply(this.cellSize)).add(drawPosWrapped);this.child.draw(universe,world,display,drawable,entity);}}drawPos.overwriteWith(this._drawablePosToRestore);};}function VisualSelect(name,childNames,children){this.name=name;this.childNames=childNames;this.children=children;for(var i=0;i<this.children.length;i++){var childName=this.childNames[i];var child=this.children[i];this.children[childName]=child;}}{VisualSelect.prototype.childSelected=function (drawable){var childNameSelected=drawable["visualNameSelected_"+this.name];if(childNameSelected==null){childNameSelected=this.childNames[0];drawable.visualNameSelected=childNameSelected;}return this.children[childNameSelected];};VisualSelect.prototype.draw=function (universe,world,display,drawable,entity){var childSelected=this.childSelected(drawable);childSelected.draw(universe,world,display,drawable,entity);};}function VisualText(text,colorFill,colorBorder){this._text=text;this.colorFill=colorFill;this.colorBorder=colorBorder;}{VisualText.prototype.draw=function (universe,world,display,drawable,entity){var text=this.text(universe,world,display,drawable);display.drawText(text,display.fontHeightInPixels,drawable.loc.pos,this.colorFill,this.colorBorder,false,true,null);};VisualText.prototype.text=function (universe,world,display,drawable){return (this._text.get==null?this._text:this._text.get(universe,world,display,drawable));};}function WebGLContext(canvas){this.gl=this.initGL(canvas);this.shaderProgram=this.buildShaderProgram(this.gl);}{WebGLContext.coordsToWebGLArray=function (coordsToConvert){var returnValues=new Float32Array(coordsToConvert.dimensions());return returnValues;};WebGLContext.prototype.initGL=function (canvas){var gl=canvas.getContext("experimental-webgl");gl.viewportWidth=canvas.width;gl.viewportHeight=canvas.height;var colorBackground=Color.Instances().Black;var colorBackgroundComponentsRGBA=colorBackground.componentsRGBA;gl.clearColor(colorBackgroundComponentsRGBA[0],colorBackgroundComponentsRGBA[1],colorBackgroundComponentsRGBA[2],colorBackgroundComponentsRGBA[3]);gl.enable(gl.CULL_FACE);gl.enable(gl.DEPTH_TEST);return gl;};WebGLContext.prototype.buildShaderProgram=function (gl){var shaderProgram=this.buildShaderProgram_Compile(gl,this.buildShaderProgram_FragmentShader(gl),this.buildShaderProgram_VertexShader(gl));this.buildShaderProgram_SetUpInputVariables(gl,shaderProgram);return shaderProgram;};WebGLContext.prototype.buildShaderProgram_FragmentShader=function (gl){var fragmentShader=gl.createShader(gl.FRAGMENT_SHADER);var fragmentShaderCode="precision mediump float;"+"uniform sampler2D uSampler;"+"varying vec4 vColor;"+"varying vec3 vLight;"+"varying vec2 vTextureUV;"+"void main(void) {"+"    if (vTextureUV.x < 0.0) {"+"        gl_FragColor = vColor;"+"    } else {"+"        vec4 textureColor = "+"            texture2D(uSampler, vec2(vTextureUV.s, vTextureUV.t));"+"        gl_FragColor = vec4(vLight * textureColor.rgb, textureColor.a);"+"    }"+"}";gl.shaderSource(fragmentShader,fragmentShaderCode);gl.compileShader(fragmentShader);return fragmentShader;};WebGLContext.prototype.buildShaderProgram_VertexShader=function (gl){var vertexShader=gl.createShader(gl.VERTEX_SHADER);var vertexShaderCode="attribute vec4 aVertexColor;"+"attribute vec3 aVertexNormal;"+"attribute vec3 aVertexPosition;"+"attribute vec2 aVertexTextureUV;"+"uniform mat4 uEntityMatrix;"+"uniform mat4 uCameraMatrix;"+"uniform float uLightAmbientIntensity;"+"uniform vec3 uLightDirection;"+"uniform float uLightDirectionalIntensity;"+"uniform mat4 uNormalMatrix;"+"varying vec4 vColor;"+"varying vec3 vLight;"+"varying vec2 vTextureUV;"+"void main(void) {"+"    vColor = aVertexColor;"+"    vec4 vertexNormal4 = vec4(aVertexNormal, 0.0);"+"    vec4 transformedNormal4 = uNormalMatrix * vertexNormal4;"+"    vec3 transformedNormal = vec3(transformedNormal4.xyz) * -1.0;"+"    float lightMagnitude = uLightAmbientIntensity;"+"    lightMagnitude += "+"        uLightDirectionalIntensity "+"        * max(dot(transformedNormal, uLightDirection), 0.0);"+"    vLight = vec3(1.0, 1.0, 1.0) * lightMagnitude;"+"    vTextureUV = aVertexTextureUV;"+"    vec4 vertexPos = vec4(aVertexPosition, 1.0);"+"    gl_Position = uCameraMatrix * uEntityMatrix * vertexPos;"+"}";gl.shaderSource(vertexShader,vertexShaderCode);gl.compileShader(vertexShader);return vertexShader;};WebGLContext.prototype.buildShaderProgram_Compile=function (gl,fragmentShader,vertexShader){var shaderProgram=gl.createProgram();gl.attachShader(shaderProgram,vertexShader);gl.attachShader(shaderProgram,fragmentShader);gl.linkProgram(shaderProgram);gl.useProgram(shaderProgram);return shaderProgram;};WebGLContext.prototype.buildShaderProgram_SetUpInputVariables=function (gl,shaderProgram){shaderProgram.vertexColorAttribute=gl.getAttribLocation(shaderProgram,"aVertexColor");gl.enableVertexAttribArray(shaderProgram.vertexColorAttribute);shaderProgram.vertexNormalAttribute=gl.getAttribLocation(shaderProgram,"aVertexNormal");gl.enableVertexAttribArray(shaderProgram.vertexNormalAttribute);shaderProgram.vertexPositionAttribute=gl.getAttribLocation(shaderProgram,"aVertexPosition");gl.enableVertexAttribArray(shaderProgram.vertexPositionAttribute);shaderProgram.vertexTextureUVAttribute=gl.getAttribLocation(shaderProgram,"aVertexTextureUV");gl.enableVertexAttribArray(shaderProgram.vertexTextureUVAttribute);shaderProgram.entityMatrix=gl.getUniformLocation(shaderProgram,"uEntityMatrix");shaderProgram.cameraMatrix=gl.getUniformLocation(shaderProgram,"uCameraMatrix");shaderProgram.lightAmbientIntensity=gl.getUniformLocation(shaderProgram,"uLightAmbientIntensity");shaderProgram.lightDirection=gl.getUniformLocation(shaderProgram,"uLightDirection");shaderProgram.lightDirectionalIntensity=gl.getUniformLocation(shaderProgram,"uLightDirectionalIntensity");shaderProgram.normalMatrix=gl.getUniformLocation(shaderProgram,"uNormalMatrix");};}function ArrayExtensions(){}{Array.prototype.add=function (element){this.push(element);return this;};Array.prototype.addMany=function (elements){for(var i=0;i<elements.length;i++){var element=elements[i];this.push(element);}return this;};Array.prototype.addLookups=function (keyName){for(var i=0;i<this.length;i++){var element=this[i];var key=element[keyName];this[key]=element;}return this;};Array.prototype.append=function (other){for(var i=0;i<other.length;i++){var element=other[i];this.push(element);}return this;};Array.prototype.clear=function (){this.length=0;return this;};Array.prototype.clone=function (){var returnValue=[];for(var i=0;i<this.length;i++){var element=this[i];var elementCloned=element.clone();returnValue.push(elementCloned);}return returnValue;};Array.prototype.contains=function (elementToFind){return (this.indexOf (elementToFind)>=0);};Array.prototype.elementProperties=function (propertyName){var returnValues=[];for(var i=0;i<this.length;i++){var element=this[i];var elementProperty=element[propertyName];returnValues.push(elementProperty);}return returnValues;};Array.prototype.insertElementAt=function (element,index){this.splice (index,0,element);return this;};Array.prototype.overwriteWith=function (other){for(var i=0;i<this.length;i++){var elementThis=this[i];var elementOther=other[i];if(elementThis.overwriteWith==null){this[i]=elementOther;}else {elementThis.overwriteWith(elementOther);}}return this;};Array.prototype.prepend=function (other){for(var i=0;i<other.length;i++){var element=other[i];this.splice (0,0,element);}return this;};Array.prototype.random=function (){return this[Math.floor(Math.random()*this.length)];};Array.prototype.remove=function (elementToRemove){var indexToRemoveAt=this.indexOf (elementToRemove);if(indexToRemoveAt>=0){this.splice (indexToRemoveAt,1);}return this;};Array.prototype.removeAt=function (index){this.splice (index,1);return this;};Array.prototype.sortByProperty=function (propertyName){return this.sort(function (a,b){return a[propertyName]-b[propertyName];});};}function NumberExtensions(){}{Number.prototype.isInRangeMinMax=function (min,max){return (this>=min&&this<=max);};Number.prototype.roundToDecimalPlaces=function (numberOfPlaces){var multiplier=Math.pow(10,numberOfPlaces);return Math.round(this*multiplier)/multiplier;};Number.prototype.subtractWrappedToRangeMax=function (subtrahend,max){var differenceUnwrapped=this-subtrahend;var differenceAbsolute=Math.abs(differenceUnwrapped);var differenceAbsoluteLeastSoFar=differenceAbsolute;var returnValue=differenceUnwrapped;for(var i=-1;i<=1;i+=2){var differenceWrapped=differenceUnwrapped+max*i;differenceAbsolute=Math.abs(differenceWrapped);if(differenceAbsolute<differenceAbsoluteLeastSoFar){differenceAbsoluteLeastSoFar=differenceAbsolute;returnValue=differenceWrapped;}}return returnValue;};Number.prototype.trimToRangeMax=function (max){return this.trimToRangeMinMax(0,max);};Number.prototype.trimToRangeMinMax=function (min,max){var value=this;if(value<min){value=min;}else if(value>max){value=max;}return value;};Number.prototype.wrapToRangeMinMax=function (min,max){var value=this;var rangeSize=max-min;if(rangeSize==0){value=min;}else {while(value<min){value+=rangeSize;}while(value>=max){value-=rangeSize;}}return value;};}function StringExtensions(){}{String.prototype.padLeft=function (lengthAfterPadding,characterToPadWith){var stringToPad=this;while(stringToPad.length<lengthAfterPadding){stringToPad=characterToPadWith+stringToPad;}return stringToPad;};String.prototype.replaceAll=function (stringToBeReplaced,stringToReplaceWith){return this.split(stringToBeReplaced).join(stringToReplaceWith);};String.prototype.toTitleCase=function (){return this.substr(0,1).toUpperCase()+this.substr(1).toLowerCase();};}function Camera(viewSize,focalLength,loc){this.viewSize=viewSize;this.focalLength=focalLength;this.loc=loc;this.viewSizeHalf=this.viewSize.clone().clearZ().half();}{Camera.prototype.clipPlanes=function (){if(this._clipPlanes==null){this._clipPlanes=[new Plane(new Coords(0,0,0),0),new Plane(new Coords(0,0,0),0),new Plane(new Coords(0,0,0),0),new Plane(new Coords(0,0,0),0),];}var cameraLoc=this.loc;var cameraOrientation=cameraLoc.orientation;var cameraPos=cameraLoc.pos;var centerOfViewPlane=cameraPos.clone().add(cameraOrientation.forward.clone().multiplyScalar(this.focalLength));var cornerOffsetRight=cameraOrientation.right.clone().multiplyScalar(this.viewSizeHalf.x);var cornerOffsetDown=cameraOrientation.down.clone().multiplyScalar(this.viewSizeHalf.y);var cameraViewCorners=[centerOfViewPlane.clone().add(cornerOffsetRight).add(cornerOffsetDown),centerOfViewPlane.clone().subtract(cornerOffsetRight).add(cornerOffsetDown),centerOfViewPlane.clone().subtract(cornerOffsetRight).subtract(cornerOffsetDown),centerOfViewPlane.clone().add(cornerOffsetRight).subtract(cornerOffsetDown),];var numberOfCorners=cameraViewCorners.length;for(var i=0;i<numberOfCorners;i++){var iNext=i+1;if(iNext>=numberOfCorners){iNext=0;}var clipPlane=this._clipPlanes[i];var cameraViewCorner=cameraViewCorners[i];var cameraViewCornerNext=cameraViewCorners[iNext];clipPlane.fromPoints(cameraPos,cameraViewCorner,cameraViewCornerNext);}return this._clipPlanes;};Camera.prototype.coordsTransformViewToWorld=function (viewCoords,ignoreZ){var cameraLoc=this.loc;if(ignoreZ==true){viewCoords.z=this.focalLength;}var worldCoords=viewCoords.subtract(this.viewSizeHalf);cameraLoc.orientation.unprojectCoordsRDF(worldCoords);worldCoords.add(cameraLoc.pos);return worldCoords;};Camera.prototype.coordsTransformWorldToView=function (worldCoords){var cameraPos=this.loc.pos;var cameraOrientation=this.loc.orientation;var viewCoords=worldCoords.subtract(cameraPos);cameraOrientation.projectCoordsRDF(viewCoords);if(this.focalLength!=null){var viewCoordsZ=viewCoords.z;if(viewCoordsZ!=0){viewCoords.multiplyScalar(this.focalLength).divideScalar(viewCoordsZ);viewCoords.z=viewCoordsZ;}}viewCoords.add(this.viewSizeHalf);return viewCoords;};}function Collision(pos,distanceToCollision){this.pos=pos;this.distanceToCollision=distanceToCollision;this.collidables=[];this.colliders=[];this.isActive=false;}{Collision.new =function (){return new Collision(new Coords());};Collision.prototype.clear=function (){this.isActive=false;this.collidables.clear();this.colliders.clear();return this;};}function CollisionHelper(){this.throwErrorIfCollidersCannotBeCollided=true;this.colliderTypeNamesToDoCollideLookup=this.doCollideLookupBuild();this.colliderTypeNamesToDoesContainLookup=this.doesContainLookupBuild();this.colliderTypeNamesToCollideLookup=this.collisionResponseLookupBuild();this._bounds=new Bounds(new Coords(),new Coords());this._collision=new Collision(new Coords());this._displacement=new Coords();this._pos=new Coords();this._range=new Range();this._range2=new Range();this._size=new Coords();}{CollisionHelper.prototype.collisionResponseLookupBuild=function (){var lookupOfLookups={};var lookup;lookup={};lookup[Sphere.name]=this.collideCollidablesBoundsAndSphere;lookupOfLookups[Bounds.name]=lookup;lookup={};lookup[Sphere.name]=this.collideCollidablesReverseVelocities;lookupOfLookups[MapLocated.name]=lookup;lookup={};lookup[MapLocated.name]=this.collideCollidablesReverseVelocities;lookup[Mesh.name]=this.collideCollidablesReverseVelocities;lookup[ShapeGroupAll.name]=this.collideCollidablesReverseVelocities;lookup[Sphere.name]=this.collideCollidablesReverseVelocities;lookup={};lookup[Sphere.name]=this.collideCollidablesSphereAndShapeGroupAll;lookupOfLookups[ShapeGroupAll.name]=lookup;lookup={};lookup[Bounds.name]=this.collideCollidablesSphereAndBounds;lookup[MapLocated.name]=this.collideCollidablesReverseVelocities;lookup[Mesh.name]=this.collideCollidablesReverseVelocities;lookup[ShapeGroupAll.name]=this.collideCollidablesReverseVelocities;lookup[Sphere.name]=this.collideCollidablesSphereAndSphere;lookupOfLookups[Sphere.name]=lookup;return lookupOfLookups;};CollisionHelper.prototype.doCollideLookupBuild=function (){var lookupOfLookups={};var lookup;lookup={};lookup[Bounds.name]=this.doBoundsAndBoundsCollide;lookup[Cylinder.name]=this.doBoundsAndCylinderCollide;lookup[Sphere.name]=this.doBoundsAndSphereCollide;lookupOfLookups[Bounds.name]=lookup;lookup={};lookup[Cylinder.name]=this.doCylinderAndCylinderCollide;lookupOfLookups[Cylinder.name]=lookup;lookup={};lookup[Face.name]=this.doEdgeAndFaceCollide;lookup[Hemispace.name]=this.doEdgeAndHemispaceCollide;lookup[Mesh.name]=this.doEdgeAndMeshCollide;lookup[Plane.name]=this.doEdgeAndPlaneCollide;lookupOfLookups[Edge.name]=lookup;lookup={};lookup[Sphere.name]=this.doHemispaceAndSphereCollide;lookupOfLookups[Hemispace.name]=lookup;lookup={};lookup[MapLocated.name]=this.doMapLocatedAndMapLocatedCollide;lookup[Sphere.name]=this.doMapLocatedAndSphereCollide;lookupOfLookups[MapLocated.name]=lookup;lookup={};lookup[Mesh.name]=this.doMeshAndMeshCollide;lookup[Sphere.name]=this.doMeshAndSphereCollide;lookupOfLookups[Mesh.name]=lookup;lookup={};lookup[ShapeContainer.name]=this.doShapeContainerAndShapeCollide;lookup[ShapeGroupAll.name]=this.doShapeContainerAndShapeCollide;lookup[ShapeGroupAny.name]=this.doShapeContainerAndShapeCollide;lookup[ShapeInverse.name]=this.doShapeContainerAndShapeCollide;lookup[Sphere.name]=this.doShapeContainerAndShapeCollide;lookupOfLookups[ShapeContainer.name]=lookup;lookup={};lookup[ShapeContainer.name]=this.doShapeGroupAllAndShapeCollide;lookup[ShapeGroupAll.name]=this.doShapeGroupAllAndShapeCollide;lookup[ShapeGroupAny.name]=this.doShapeGroupAllAndShapeCollide;lookup[ShapeInverse.name]=this.doShapeGroupAllAndShapeCollide;lookup[Sphere.name]=this.doShapeGroupAllAndShapeCollide;lookupOfLookups[ShapeGroupAll.name]=lookup;lookup={};lookup[ShapeContainer.name]=this.doShapeGroupAnyAndShapeCollide;lookup[ShapeGroupAll.name]=this.doShapeGroupAnyAndShapeCollide;lookup[ShapeGroupAny.name]=this.doShapeGroupAnyAndShapeCollide;lookup[ShapeInverse.name]=this.doShapeGroupAnyAndShapeCollide;lookup[Sphere.name]=this.doShapeGroupAnyAndShapeCollide;lookupOfLookups[ShapeGroupAny.name]=lookup;lookup={};lookup[ShapeContainer.name]=this.doShapeInverseAndShapeCollide;lookup[ShapeGroupAll.name]=this.doShapeInverseAndShapeCollide;lookup[ShapeGroupAny.name]=this.doShapeInverseAndShapeCollide;lookup[ShapeInverse.name]=this.doShapeInverseAndShapeCollide;lookup[Sphere.name]=this.doShapeInverseAndShapeCollide;lookupOfLookups[ShapeInverse.name]=lookup;lookup={};lookup[Bounds.name]=this.doSphereAndBoundsCollide;lookup[MapLocated.name]=this.doSphereAndMapLocatedCollide;lookup[Mesh.name]=this.doSphereAndMeshCollide;lookup[ShapeContainer.name]=this.doSphereAndShapeContainerCollide;lookup[ShapeGroupAll.name]=this.doSphereAndShapeGroupAllCollide;lookup[ShapeGroupAny.name]=this.doSphereAndShapeGroupAnyCollide;lookup[ShapeInverse.name]=this.doSphereAndShapeInverseCollide;lookup[Sphere.name]=this.doSphereAndSphereCollide;lookupOfLookups[Sphere.name]=lookup;return lookupOfLookups;};CollisionHelper.prototype.doesContainLookupBuild=function (){var lookupOfLookups={};var lookup;lookup={};lookup[Bounds.name]=this.doesBoundsContainBounds;lookup[Sphere.name]=this.doesBoundsContainSphere;lookupOfLookups[Bounds.name]=lookup;lookup={};lookup[Bounds.name]=this.doesHemispaceContainBounds;lookup[Sphere.name]=this.doesHemispaceContainSphere;lookupOfLookups[Hemispace.name]=lookup;lookup={};lookup[Bounds.name]=this.doesSphereContainBounds;lookup[Sphere.name]=this.doesSphereContainSphere;lookupOfLookups[Sphere.name]=lookup;return lookupOfLookups;};CollisionHelper.prototype.collideCollidables=function (entityColliding,entityCollidedWith){var collider0=entityColliding.Collidable.collider;var collider1=entityCollidedWith.Collidable.collider;while(collider0.collider!=null){collider0=collider0.collider();}while(collider1.collider!=null){collider1=collider1.collider();}var collider0TypeName=collider0.constructor.name;var collider1TypeName=collider1.constructor.name;var collideLookup=this.colliderTypeNamesToCollideLookup[collider0TypeName];if(collideLookup==null){if(this.throwErrorIfCollidersCannotBeCollided){throw "Error!  Colliders of types cannot be collided: "+collider0TypeName+","+collider1TypeName;}}else {var collisionMethod=collideLookup[collider1TypeName];if(collisionMethod==null){if(this.throwErrorIfCollidersCannotBeCollided){throw "Error!  Colliders of types cannot be collided: "+collider0TypeName+","+collider1TypeName;}}else {returnValue=collisionMethod.call(this,entityColliding,entityCollidedWith);}}};CollisionHelper.prototype.collisionsOfCollidablesInSets=function (collidableSet0,collidableSet1){var returnValues=[];var numberOfCollidablesInSet0=collidableSet0.length;var numberOfCollidablesInSet1=collidableSet1.length;for(var i=0;i<numberOfCollidablesInSet0;i++){var collidableFromSet0=collidableSet0[i];for(var j=0;j<numberOfCollidablesInSet1;j++){var collidableFromSet1=collidableSet1[j];if(this.doCollidablesCollide(collidableFromSet0,collidableFromSet1)==true){var collision=Collision.new ();collision.collidables.push(collidableFromSet0);collision.collidables.push(collidableFromSet1);returnValues.push(collision);}}}return returnValues;};CollisionHelper.prototype.doCollidablesCollide=function (collidable0,collidable1){var collider0=collidable0.collider();var collider1=collidable1.collider();var doCollidersCollide=this.doCollidersCollide(collider0,collider1);return doCollidersCollide;};CollisionHelper.prototype.doCollidersCollide=function (collider0,collider1){var returnValue=false;while(collider0.collider!=null){collider0=collider0.collider();}while(collider1.collider!=null){collider1=collider1.collider();}var collider0TypeName=collider0.constructor.name;var collider1TypeName=collider1.constructor.name;var doCollideLookup=this.colliderTypeNamesToDoCollideLookup[collider0TypeName];if(doCollideLookup==null){if(this.throwErrorIfCollidersCannotBeCollided){throw "Error!";}}else {var collisionMethod=doCollideLookup[collider1TypeName];if(collisionMethod==null){if(this.throwErrorIfCollidersCannotBeCollided){throw "Error!";}}else {returnValue=collisionMethod.call(this,collider0,collider1);}}return returnValue;};CollisionHelper.prototype.doesColliderContainOther=function (collider0,collider1){var returnValue=false;while(collider0.collider!=null){collider0=collider0.collider();}while(collider1.collider!=null){collider1=collider1.collider();}var collider0TypeName=collider0.constructor.name;var collider1TypeName=collider1.constructor.name;var doesContainLookup=this.colliderTypeNamesToDoesContainLookup[collider0TypeName];if(doesContainLookup==null){if(this.throwErrorIfCollidersCannotBeCollided){throw "Error!";}}else {var doesColliderContainOther=doesContainLookup[collider1TypeName];if(doesColliderContainOther==null){if(this.throwErrorIfCollidersCannotBeCollided){throw "Error!";}}else {returnValue=doesColliderContainOther.call(this,collider0,collider1);}}return returnValue;};CollisionHelper.prototype.collideCollidablesReverseVelocities=function (collidable0,collidable1){collidable0.Locatable.loc.vel.invert();collidable1.Locatable.loc.vel.invert();};CollisionHelper.prototype.collideCollidablesSphereAndShapeGroupAll=function (entitySphere,entityShapeGroupAll){this.collideCollidablesReverseVelocities(entitySphere,entityShapeGroupAll);};CollisionHelper.prototype.collideCollidablesBoundsAndSphere=function (entityBounds,entitySphere){var sphereLoc=entitySphere.Locatable.loc;var boundsLoc=entityBounds.Locatable.loc;var bounds=entityBounds.Collidable.collider;var sphere=entitySphere.Collidable.collider;var collision=this.collisionOfBoundsAndSphere(bounds,sphere,this._collision);var collisionRelativeToBounds=this._pos.overwriteWith(collision.pos).subtract(bounds.center).divide(bounds.sizeHalf);if(Math.abs(collisionRelativeToBounds.x)>=Math.abs(collisionRelativeToBounds.y)){sphereLoc.vel.x*=-1;}else {sphereLoc.vel.y*=-1;}};CollisionHelper.prototype.collideCollidablesSphereAndBounds=function (entitySphere,entityBounds){this.collideCollidablesBoundsAndSphere(entityBounds,entitySphere);};CollisionHelper.prototype.collideCollidablesSphereAndSphere=function (entityColliding,entityCollidedWith){var entityCollidingLoc=entityColliding.Locatable.loc;var entityCollidedWithLoc=entityCollidedWith.Locatable.loc;var entityCollidingPos=entityCollidingLoc.pos;var entityCollidedWithPos=entityCollidedWithLoc.pos;var displacement=this._displacement.overwriteWith(entityCollidedWithPos).subtract(entityCollidingPos);var distance=displacement.magnitude();var direction=displacement.divideScalar(distance);var sumOfRadii=entityColliding.Collidable.collider.radius+entityCollidedWith.Collidable.collider.radius;entityCollidedWithPos.overwriteWith(direction).multiplyScalar(sumOfRadii).add(entityCollidingPos);var speedAlongRadius=entityCollidedWithLoc.vel.dotProduct(direction);var accelOfReflection=direction.multiplyScalar(speedAlongRadius*2);entityCollidedWithLoc.accel.subtract(accelOfReflection);};CollisionHelper.prototype.collisionOfBoundsAndSphere=function (bounds,sphere,collision){if(collision==null){collision=Collision.new ();}collision.isActive=true;var sphereCenter=sphere.center;var sphereRadius=sphere.radius;var boundsCenter=bounds.center;var boundsSizeHalf=bounds.sizeHalf;var sphereProjectedOntoAxis=this._range;var boundsProjectedOntoAxis=this._range2;for(var d=0;d<2;d++){var boundsCenterD=boundsCenter.dimension(d);var boundsSizeHalfD=boundsSizeHalf.dimension(d);boundsProjectedOntoAxis.min=boundsCenterD-boundsSizeHalfD;boundsProjectedOntoAxis.max=boundsCenterD+boundsSizeHalfD;var sphereCenterD=sphereCenter.dimension(d);sphereProjectedOntoAxis.min=sphereCenterD-sphereRadius;sphereProjectedOntoAxis.max=sphereCenterD+sphereRadius;var doProjectionsOverlap=boundsProjectedOntoAxis.overlapsWith(sphereProjectedOntoAxis);if(doProjectionsOverlap==false){collision.isActive=false;break;}else {var intersectionOfProjections=boundsProjectedOntoAxis.intersectWith(sphereProjectedOntoAxis);collision.pos.dimension(d,intersectionOfProjections.midpoint());}}return collision;};CollisionHelper.prototype.collisionOfHemispaceAndSphere=function (hemispace,sphere,collision){if(collision==null){collision=Collision.new ();}var plane=hemispace.plane;var distanceOfSphereCenterFromOriginAlongNormal=sphere.center.dotProduct(plane.normal);var distanceOfSphereCenterAbovePlane=distanceOfSphereCenterFromOriginAlongNormal-plane.distanceFromOrigin;if(distanceOfSphereCenterAbovePlane<sphere.radius){collision.isActive=true;plane.pointClosestToOrigin(collision.pos);collision.colliders.length=0;collision.colliders.push(hemispace);}return collision;};CollisionHelper.prototype.collisionOfEdgeAndFace=function (edge,face){var facePlane=face.plane();var returnValue=this.collisionOfEdgeAndPlane(edge,facePlane);if(returnValue!=null){var faceVertices=face.vertices;var faceEdgeAsPlane=new Plane(new Coords());var faceNormal=facePlane.normal;var faceVertexPlusFaceNormal=new Coords();var faceVertexPrev=faceVertices[faceVertices.length-1];for(var i=0;i<faceVertices.length;i++){var faceVertex=faceVertices[i];faceVertexPlusFaceNormal.overwriteWith(faceVertex).add(faceNormal);faceEdgeAsPlane.fromPoints(faceVertex,faceVertexPrev,faceVertexPlusFaceNormal);var hemispace=new Hemispace(faceEdgeAsPlane);var doEdgeAndHemispaceCollide=this.doEdgeAndHemispaceCollide(edge,hemispace);if(doEdgeAndHemispaceCollide==false){returnValue=null;break;}faceVertexPrev=faceVertex;}}if(returnValue!=null){returnValue.collider=face;}return returnValue;};CollisionHelper.prototype.collisionsOfEdgeAndMesh=function (edge,mesh,collisions,stopAfterFirst){if(collisions==null){collisions=[];}var meshFaces=mesh.faces();for(var i=0;i<meshFaces.length;i++){var meshFace=meshFaces[i];var collisionOfEdgeAndFace=this.collisionOfEdgeAndFace(edge,meshFace);if(collisionOfEdgeAndFace!=null){collisions.push(collisionOfEdgeAndFace);if(stopAfterFirst==true){break;}}}return collisions;};CollisionHelper.prototype.collisionOfEdgeAndPlane=function (edge,plane,collision){if(collision==null){collision=Collision.new ();}var returnValue=null;var edgeDirection=edge.direction();var planeNormal=plane.normal;var distanceToCollision=(plane.distanceFromOrigin-planeNormal.dotProduct(edge.vertices[0]))/planeNormal.dotProduct(edgeDirection);if(distanceToCollision>=0 &&distanceToCollision<=edge.length()){collision.pos.overwriteWith(edgeDirection).multiplyScalar(distanceToCollision).add(edge.vertices[0]);collision.distanceToCollision=distanceToCollision;returnValue.colliders.length=0;returnValue.colliders.push(plane);}return returnValue;};CollisionHelper.prototype.doBoundsAndBoundsCollide=function (bounds0,bounds1){var returnValue=bounds0.overlapsWith(bounds1);return returnValue;};CollisionHelper.prototype.doBoundsAndCylinderCollide=function (bounds,cylinder){var returnValue=false;var displacementBetweenCenters=this._displacement.overwriteWith(bounds.center).subtract(cylinder.center);if(displacementBetweenCenters.z<bounds.sizeHalf.z+cylinder.lengthHalf);{displacementBetweenCenters.clearZ();var direction=displacementBetweenCenters.normalize();var pointOnCylinderClosestToBoundsCenter=direction.multiplyScalar(cylinder.radius).add(cylinder.center);pointOnCylinderClosestToBoundsCenter.z=bounds.center.z;var isPointOnCylinderWithinBounds=bounds.containsPoint(pointOnCylinderClosestToBoundsCenter);returnValue=isPointOnCylinderWithinBounds;}return returnValue;};CollisionHelper.prototype.doBoundsAndHemispaceCollide=function (bounds,hemispace){var returnValue=false;var vertices=Mesh.fromBounds(bounds).vertices();for(var i=0;i<vertices.length;i++){var vertex=vertices[v];if(hemispace.containsPoint(vertex)==true){returnValue=true;break;}}return returnValue;};CollisionHelper.prototype.doBoundsAndSphereCollide=function (bounds,sphere){return this.collisionOfBoundsAndSphere(bounds,sphere,this._collision.clear()).isActive;};CollisionHelper.prototype.doCylinderAndCylinderCollide=function (cylinder0,cylinder1){var returnValue=false;var displacement=this._displacement.overwriteWith(cylinder1.center).subtract(cylinder0.center).clearZ();var distance=displacement.magnitude();var sumOfRadii=sphere0.radius+sphere1.radius;var doRadiiOverlap=(distance<sumOfRadii);if(doRadiiOverlap==true){var doLengthsOverlap=((cylinder0.zMin>cylinder1.zMin&&cylinder0.zMin<cylinder1.zMax)||(cylinder0.zMax>cylinder1.zMin&&cylinder0.zMax<cylinder1.zMax)||(cylinder1.zMin>cylinder0.zMin&&cylinder1.zMin<cylinder0.zMax)||(cylinder1.zMax>cylinder0.zMin&&cylinder1.zMax<cylinder0.zMax));if(doLengthsOverlap==true){returnValue=true;}}return returnValue;};CollisionHelper.prototype.doEdgeAndFaceCollide=function (edge,face){return (this.collisionOfEdgeAndFace(edge,face)!=null);};CollisionHelper.prototype.doEdgeAndHemispaceCollide=function (edge,hemispace){var vertices=edge.vertices;var returnValue=(hemispace.containsPoint(vertices[0])||hemispace.containsPoint(vertices[1]));return returnValue;};CollisionHelper.prototype.doEdgeAndMeshCollide=function (edge,mesh){var returnValue=false;var edgeDirection=edge.direction();var meshFaces=mesh.faces();for(var f=0;f<meshFaces.length;f++){var face=meshFaces[f];var facePlane=face.plane();var faceNormal=facePlane.normal;var faceDotEdge=faceNormal.dotProduct(edgeDirection);if(faceDotEdge<0){returnValue=this.doEdgeAndFaceCollide(edge,face);if(returnValue==true){break;}}}return returnValue;};CollisionHelper.prototype.doEdgeAndPlaneCollide=function (edge,plane){return (this.collisionOfEdgeAndPlane(edge,plane,this._collision.clear())!=null);};CollisionHelper.prototype.doHemispaceAndSphereCollide=function (hemispace,sphere){var collision=this.collisionOfHemispaceAndSphere(hemispace,sphere,this._collision.clear());return collision.isActive;};CollisionHelper.prototype.doMeshAndMeshCollide=function (mesh0,mesh1){var returnValue=true;var meshVertices=[mesh0.vertices(),mesh1.vertices()];var meshFaces=[mesh0.faces(),mesh1.faces()];for(var m=0;m<2;m++){var meshThisFaces=meshFaces[m];var meshThisVertices=meshVertices[m];var meshOtherVertices=meshOtherVertices[m];for(var f=0;f<meshThisFaces.length;f++){var face=meshThisFaces[f];var faceNormal=face.plane().normal;var vertexThis=meshThisVertices[0];var vertexThisProjectedMin=vertexThis.dotProduct(faceNormal);var vertexThisProjectedMax=vertexThisProjectedMin;for(var v=1;v<meshThisVertices.length;v++){vertexThis=meshThisVertices[v];var vertexThisProjected=vertexThis.dotProduct(faceNormal);if(vertexThisProjected<vertexThisProjectedMin){vertexThisProjectedMin=vertexThisProjected;}if(vertexThisProjected>vertexThisProjectedMax){vertexThisProjectedMax=vertexThisProjected;}}var vertexOther=meshOtherVertices[0];var vertexOtherProjectedMin=vertexOther.dotProduct(faceNormal);var vertexOtherProjectedMax=vertexOtherProjectedMin;for(var v=1;v<meshOtherVertices.length;v++){vertexOther=meshOtherVertices[v];var vertexOtherProjected=vertexOther.dotProduct(faceNormal);if(vertexOtherProjected<vertexOtherProjectedMin){vertexOtherProjectedMin=vertexOtherProjected;}if(vertexOtherProjected>vertexOtherProjectedMax){vertexOtherProjectedMax=vertexOtherProjected;}}var doProjectionsOverlap=(vertexThisProjectedMax>vertexOtherProjectedMin&&vertexOtherProjectedMax>vertexThisProjectedMin);if(doProjectionsOverlap==false){returnValue=false;break;}}}return returnValue;};CollisionHelper.prototype.doMapLocatedAndMapLocatedCollide=function (mapLocated0,mapLocated1){var returnValue=false;var doBoundsCollide=this.doBoundsAndBoundsCollide(mapLocated0.bounds,mapLocated1.bounds);if(doBoundsCollide==false){return false;}var map0=mapLocated0.map;var map1=mapLocated1.map;var cell0=map0.cellPrototype.clone();var cell1=map1.cellPrototype.clone();var cell0PosAbsolute=new Coords();var cell0PosInCells=new Coords();var cell1PosInCells=new Coords();var cell1PosInCellsMin=new Coords();var cell1PosInCellsMax=new Coords();var map0SizeInCells=map0.sizeInCells;var map1SizeInCells=map1.sizeInCells;var map1SizeInCellsMinusOnes=map1.sizeInCellsMinusOnes;var map0CellSize=map0.cellSize;var map1CellSize=map1.cellSize;var map0Pos=mapLocated0.loc.pos;var map1Pos=mapLocated1.loc.pos;for(var y0=0;y0<map0SizeInCells.y;y0++){cell0PosInCells.y=y0;cell0PosAbsolute.y=map0Pos.y+(y0*map0CellSize.y);for(var x0=0;x0<map0SizeInCells.x;x0++){cell0PosInCells.x=x0;cell0PosAbsolute.x=map0Pos.x+(x0*map0CellSize.x);cell0=map0.cellAtPosInCells(map0,cell0PosInCells,cell0);if(cell0.isBlocking==true){cell1PosInCellsMin.overwriteWith(cell0PosAbsolute).subtract(map1Pos).divide(map1CellSize).floor();cell1PosInCellsMax.overwriteWith(cell0PosAbsolute).subtract(map1Pos).add(map0CellSize).divide(map1CellSize).floor();for(var y1=cell1PosInCellsMin.y;y1<=cell1PosInCellsMax.y;y1++){cell1PosInCells.y=y1;for(var x1=cell1PosInCellsMin.x;x1<cell1PosInCellsMax.x;x1++){cell1PosInCells.x=x1;var isCell1PosInBounds=cell1PosInCells.isInRangeMinMax(Coords.Instances().Zeroes,map1SizeInCellsMinusOnes);if(isCell1PosInBounds==true){cell1=map1.cellAtPosInCells(map1,cell1PosInCells,cell1);if(cell1.isBlocking==true){returnValue=true;y1=cell1PosInCellsMax.y;x0=map0SizeInCells.x;y0=map0SizeInCells.y;break;}}}}}}}return returnValue;};CollisionHelper.prototype.doMapLocatedAndSphereCollide=function (mapLocated,sphere){var returnValue=false;var doBoundsCollide=this.doBoundsAndSphereCollide(mapLocated.bounds,sphere);if(doBoundsCollide==false){return false;}var map=mapLocated.map;var cell=map.cellPrototype.clone();var cellPosAbsolute=new Coords();var cellPosInCells=new Coords();var mapSizeInCells=map.sizeInCells;var mapCellSize=map.cellSize;var mapSizeHalf=map.sizeHalf;var mapPos=mapLocated.loc.pos;var cellAsBounds=new Bounds(new Coords(),map.cellSize);for(var y=0;y<mapSizeInCells.y;y++){cellPosInCells.y=y;cellPosAbsolute.y=(y*mapCellSize.y)+mapPos.y-mapSizeHalf.y;for(var x=0;x<mapSizeInCells.x;x++){cellPosInCells.x=x;cellPosAbsolute.x=(x*mapCellSize.x)+mapPos.x-mapSizeHalf.x;cell=map.cellAtPosInCells(map,cellPosInCells,cell);if(cell.isBlocking==true){cellAsBounds.center.overwriteWith(cellPosAbsolute);var doCellAndSphereCollide=this.doBoundsAndSphereCollide(cellAsBounds,sphere);if(doCellAndSphereCollide==true){returnValue=true;break;}}}}return returnValue;};CollisionHelper.prototype.doMeshAndSphereCollide=function (mesh,sphere){var returnValue=true;var meshFaces=mesh.faces();var hemispace=new Hemispace();for(var f=0;f<meshFaces.length;f++){var face=meshFaces[f];hemispace.plane=face.plane();var doHemispaceAndSphereCollide=this.doHemispaceAndSphereCollide(hemispace,sphere);if(doHemispaceAndSphereCollide==false){returnValue=false;break;}}return returnValue;};CollisionHelper.prototype.doSphereAndBoundsCollide=function (sphere,bounds){return this.doBoundsAndSphereCollide(bounds,sphere);};CollisionHelper.prototype.doSphereAndMapLocatedCollide=function (sphere,mapLocated){return this.doMapLocatedAndSphereCollide(mapLocated,sphere);};CollisionHelper.prototype.doSphereAndMeshCollide=function (sphere,mesh){return this.doMeshAndSphereCollide(mesh,sphere);};CollisionHelper.prototype.doSphereAndShapeContainerCollide=function (sphere,shapeContainer){return this.doShapeContainerAndShapeCollide(shapeContainer,sphere);};CollisionHelper.prototype.doSphereAndShapeGroupAllCollide=function (sphere,shapeGroupAll){return this.doShapeGroupAllAndShapeCollide(shapeGroupAll,sphere);};CollisionHelper.prototype.doSphereAndShapeGroupAnyCollide=function (sphere,shapeGroupAny){return this.doShapeGroupAnyAndShapeCollide(shapeGroupAny,sphere);};CollisionHelper.prototype.doSphereAndShapeInverseCollide=function (sphere,shapeInverse){return this.doShapeInverseAndShapeCollide(shapeInverse,sphere);};CollisionHelper.prototype.doSphereAndSphereCollide=function (sphere0,sphere1){var displacement=this._displacement.overwriteWith(sphere1.center).subtract(sphere0.center);var distance=displacement.magnitude();var sumOfRadii=sphere0.radius+sphere1.radius;var returnValue=(distance<sumOfRadii);return returnValue;};CollisionHelper.prototype.doShapeGroupAllAndShapeCollide=function (groupAll,shapeOther){var returnValue=true;var shapesThis=groupAll.shapes;for(var i=0;i<shapesThis.length;i++){var shapeThis=shapesThis[i];var doShapesCollide=this.doCollidersCollide(shapeThis,shapeOther);if(doShapesCollide==false){returnValue=false;break;}}return returnValue;};CollisionHelper.prototype.doShapeGroupAnyAndShapeCollide=function (groupAny,shapeOther){var returnValue=false;var shapesThis=groupAny.shapes;for(var i=0;i<shapesThis.length;i++){var shapeThis=shapesThis[i];var doShapesCollide=this.doCollidersCollide(shapeThis,shapeOther);if(doShapesCollide==true){returnValue=true;break;}}return returnValue;};CollisionHelper.prototype.doShapeContainerAndShapeCollide=function (container,shapeOther){return this.doesColliderContainOther(container.shape,shapeOther);};CollisionHelper.prototype.doShapeInverseAndShapeCollide=function (inverse,shapeOther){return (this.doCollidersCollide(inverse.shape,shapeOther)==false);};CollisionHelper.prototype.doBoundsAndShapeGroupAllCollide=function (shape,group){return this.doShapeGroupAllAndShapeCollide(group,shape);};CollisionHelper.prototype.doShapeGroupAllAndSphereCollide=function (group,shape){return this.doShapeGroupAllAndShapeCollide(group,shape);};CollisionHelper.prototype.doBoundsAndShapeGroupAnyCollide=function (shape,group){return this.doShapeGroupAnyAndShapeCollide(group,shape);};CollisionHelper.prototype.doShapeContainerAndSphereCollide=function (container,sphere){return this.doShapeContainerAndShapeCollide(container,sphere);};CollisionHelper.prototype.doShapeGroupAnyAndSphereCollide=function (group,shape){return this.doShapeGroupAnyAndShapeCollide(group,shape);};CollisionHelper.prototype.doShapeInverseAndSphereCollide=function (inverse,shape){return this.doShapeInverseAndShapeCollide(inverse,shape);};CollisionHelper.prototype.doesBoundsContainBounds=function (bounds0,bounds1){return bounds0.containsOther(bounds1);};CollisionHelper.prototype.doesBoundsContainHemispace=function (bounds,hemispace){return false;};CollisionHelper.prototype.doesBoundsContainSphere=function (bounds,sphere){var boundsForSphere=new Bounds(sphere.center,new Coords(1,1,1).multiplyScalar(sphere.radius*2));var returnValue=bounds.containsOther(boundsForSphere);return returnValue;};CollisionHelper.prototype.doesHemispaceContainBounds=function (hemispace,bounds){var returnValue=true;var vertices=Mesh.fromBounds(bounds).vertices;for(var i=0;i<vertices.length;i++){var vertex=vertices[v];if(hemispace.containsPoint(vertex)==false){returnValue=false;break;}}return returnValue;};CollisionHelper.prototype.doesHemispaceContainSphere=function (hemispace,sphere){var plane=hemispace.plane;var distanceOfSphereCenterAbovePlane=sphere.center.dotProduct(plane.normal)-plane.distanceFromOrigin;var returnValue=(distanceOfSphereCenterAbovePlane>=sphere.radius);return returnValue;};CollisionHelper.prototype.doesSphereContainBounds=function (sphere,bounds){var sphereCircumscribingBounds=new Sphere(bounds.center,bounds.max().magnitude());var returnValue=sphere.containsOther(sphereCircumscribingBounds);return returnValue;};CollisionHelper.prototype.doesSphereContainHemispace=function (sphere,hemispace){return false;};CollisionHelper.prototype.doesSphereContainSphere=function (sphere0,sphere1){return sphere0.containsOther(sphere1);};}function Constraint(defnName,target){this.defnName=defnName;this.target=target;}{Constraint.prototype.constrain=function (universe,world,place,entity){var constraintDefn=this.defn(world);constraintDefn.constrain(universe,world,place,entity,this);};Constraint.prototype.defn=function (world){return world.defns.constraintDefns[this.defnName];};}function ConstraintDefn(name,constrain){this.name=name;this.constrain=constrain;}{ConstraintDefn.Instances=function (){if(ConstraintDefn._Instances==null){ConstraintDefn._Instances=new ConstraintDefn_Instances();}return ConstraintDefn._Instances;};function ConstraintDefn_Instances(){this._None=new ConstraintDefn("None",function constrain(universe,world,place,entity,constraint){});this.Attach=new ConstraintDefn("Attach",function constrain(universe,world,place,entity,constraint){var targetBodyName=constraint.target;var target=context.bodies[targetBodyName];entity.loc.pos.overwriteWith(target.loc.pos);});this.ContainInBounds=new ConstraintDefn("ContainInBounds",function constrain(universe,world,place,entity,constraint){var targetBodyName=constraint.target;var target=context.bodies[targetBodyName];var targetBounds=target.collider().bounds(world);targetBounds.trimCoords(entity.loc.pos);});this.Friction=new ConstraintDefn("Friction",function constrain(universe,world,place,entity,constraint){var targetFrictionCoefficient=constraint.target;var entityLoc=entity.Locatable.loc;var entityVel=entityLoc.vel;var speed=entityVel.magnitude();var frictionMagnitude=speed*targetFrictionCoefficient;entityVel.add(entityVel.clone().multiplyScalar(-frictionMagnitude));});this.FrictionDry=new ConstraintDefn("FrictionDry",function constrain(universe,world,place,entity,constraint){var targetFrictionCoefficient=constraint.target;var frictionMagnitude=targetFrictionCoefficient;var entityLoc=entity.Locatable.loc;var entityVel=entityLoc.vel;var entitySpeed=entityVel.magnitude();if(entitySpeed<=frictionMagnitude){entityVel.clear();}else {var entityDirection=entityVel.clone().normalize();entityVel.add(entityDirection.multiplyScalar(-frictionMagnitude));}});this.Offset=new ConstraintDefn("Offset",function constrain(universe,world,place,entity,constraint){var targetOffset=constraint.target;entity.loc.pos.add(targetOffset);});this.OrientToward=new ConstraintDefn("OrientToward",function constrain(universe,world,place,entity,constraint){var targetBodyName=constraint.target;var constrainableLoc=entity.loc;var constrainablePos=constrainableLoc.pos;var constrainableOrientation=constrainableLoc.orientation;var constrainableForward=constrainableOrientation.forward;var target=context.bodies[targetBodyName];var targetPos=target.loc.pos;constrainableForward.overwriteWith(targetPos).subtract(constrainablePos).normalize();constrainableOrientation.forwardSet(constrainableForward);});this.SpeedMax=new ConstraintDefn("SpeedMax",function constrain(universe,world,place,entity,constraint){var targetSpeedMax=constraint.target;var entityLoc=entity.Locatable.loc;var entityVel=entityLoc.vel;var speed=entityVel.magnitude();if(speed>targetSpeedMax){entityVel.normalize().multiplyScalar(targetSpeedMax);}});this.StopBelowSpeedMin=new ConstraintDefn("StopBelowSpeedMin",function constrain(universe,world,place,entity,constraint){var targetSpeedMin=constraint.target;var entityLoc=entity.Locatable.loc;var entityVel=entityLoc.vel;var speed=entityVel.magnitude();if(speed<targetSpeedMin){entityVel.clear();}});this.TrimToRange=new ConstraintDefn("TrimToRange",function constrain(universe,world,place,entity,constraint){var targetSize=constraint.target;var entityLoc=entity.Locatable.loc;entityLoc.pos.trimToRangeMax(targetSize);});this.WrapToRange=new ConstraintDefn("WrapToRange",function constrain(universe,world,place,entity,constraint){var targetRange=constraint.target;var entityLoc=entity.Locatable.loc;entityLoc.pos.wrapToRangeMax(targetRange);});this.WrapXTrimY=new ConstraintDefn("WrapXTrimY",function constrain(universe,world,place,entity,constraint){var entityLoc=entity.Locatable.loc;var entityPos=entityLoc.pos;var max=constraint.target;while(entityPos.x<0){entityPos.x+=max.x;}while(entityPos.x>=max.x){entityPos.x-=max.x;}if(entityPos.y<0){entityPos.y=0;}else if(entityPos.y>max.y){entityPos.y=max.y;}});}}function Coords(x,y,z){this.x=x;this.y=y;this.z=z;if(this.z==null){this.z=0;}}{Coords.NumberOfDimensions=3;Coords.Instances=function (){if(Coords._Instances==null){Coords._Instances=new Coords_Instances();}return Coords._Instances;};function Coords_Instances(){this.MinusOneZeroZero=new Coords(-1,0,0);this.Ones=new Coords(1,1,1);this.OneOneZero=new Coords(1,1,0);this.OneZeroZero=new Coords(1,0,0);this.TwoTwoZero=new Coords(2,2,0);this.ZeroZeroOne=new Coords(0,0,1);this.ZeroMinusOneZero=new Coords(0,-1,0);this.ZeroOneZero=new Coords(0,1,0);this.Zeroes=new Coords(0,0,0);}Coords.prototype.absolute=function (){this.x=Math.abs(this.x);this.y=Math.abs(this.y);this.z=Math.abs(this.z);return this;};Coords.prototype.add=function (other){this.x+=other.x;this.y+=other.y;this.z+=other.z;return this;};Coords.prototype.addDimensions=function (x,y,z){this.x+=x;this.y+=y;this.z+=z;return this;};Coords.prototype.ceiling=function (){this.x=Math.ceil(this.x);this.y=Math.ceil(this.y);this.z=Math.ceil(this.z);return this;};Coords.prototype.clear=function (){this.x=0;this.y=0;this.z=0;return this;};Coords.prototype.clearZ=function (){this.z=0;return this;};Coords.prototype.clone=function (){return new Coords(this.x,this.y,this.z);};Coords.prototype.crossProduct=function (other){return this.overwriteWithDimensions(this.y*other.z-this.z*other.y,this.z*other.x-this.x*other.z,this.x*other.y-this.y*other.x);};Coords.prototype.dimension=function (dimensionIndex,valueToSet){var returnValue;if(dimensionIndex==0){if(valueToSet!=null){this.x=valueToSet;}returnValue=this.x;}else if(dimensionIndex==1){if(valueToSet!=null){this.y=valueToSet;}returnValue=this.y;}else if(dimensionIndex==2){if(valueToSet!=null){this.z=valueToSet;}returnValue=this.z;}return returnValue;};Coords.prototype.dimensions=function (){return [this.x,this.y,this.z];};Coords.prototype.directions=function (){if(this.x<0){this.x=-1;}else if(this.x>0){this.x=1;}if(this.y<0){this.y=-1;}else if(this.y>0){this.y=1;}if(this.z<0){this.z=-1;}else if(this.z>0){this.z=1;}return this;};Coords.prototype.divide=function (other){this.x/=other.x;this.y/=other.y;this.z/=other.z;return this;};Coords.prototype.divideScalar=function (scalar){this.x/=scalar;this.y/=scalar;this.z/=scalar;return this;};Coords.prototype.dotProduct=function (other){return this.x*other.x+this.y*other.y+this.z*other.z;};Coords.prototype.double=function (){return this.multiplyScalar(2);};Coords.prototype.equals=function (other){return (this.x==other.x&&this.y==other.y&&this.z==other.z);};Coords.prototype.floor=function (){this.x=Math.floor(this.x);this.y=Math.floor(this.y);this.z=Math.floor(this.z);return this;};Coords.prototype.half=function (){return this.divideScalar(2);};Coords.prototype.invert=function (){this.x=0 -this.x;this.y=0 -this.y;this.z=0 -this.z;return this;};Coords.prototype.isInRangeMax=function (max){return this.isInRangeMinMax(Coords.Instances().Zeroes,max);};Coords.prototype.isInRangeMinMax=function (min,max){var returnValue=(this.x>=min.x&&this.x<=max.x&&this.y>=min.y&&this.y<=max.y&&this.z>=min.z&&this.z<=max.z);return returnValue;};Coords.prototype.magnitude=function (){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);};Coords.prototype.multiply=function (other){this.x*=other.x;this.y*=other.y;this.z*=other.z;return this;};Coords.prototype.multiplyDimensions=function (x,y,z){this.x*=x;this.y*=y;this.z*=z;return this;};Coords.prototype.multiplyScalar=function (scalar){this.x*=scalar;this.y*=scalar;this.z*=scalar;return this;};Coords.prototype.normalize=function (){var magnitude=this.magnitude();if(magnitude>0){this.divideScalar(magnitude);}return this;};Coords.prototype.overwriteWith=function (other){this.x=other.x;this.y=other.y;this.z=other.z;return this;};Coords.prototype.overwriteWithDimensions=function (x,y,z){this.x=x;this.y=y;this.z=z;return this;};Coords.prototype.productOfDimensions=function (){return this.x*this.y*this.z;};Coords.prototype.randomize=function (){this.x=Math.random();this.y=Math.random();this.z=Math.random();return this;};Coords.prototype.right=function (){var temp=this.y;this.y=this.x;this.x=0 -temp;return this;};Coords.prototype.round=function (){this.x=Math.round(this.x);this.y=Math.round(this.y);this.z=Math.round(this.z);return this;};Coords.prototype.subtract=function (other){this.x-=other.x;this.y-=other.y;this.z-=other.z;return this;};Coords.prototype.subtractWrappedToRangeMax=function (other,max){this.x=this.x.subtractWrappedToRangeMax(other.x,max);this.y=this.y.subtractWrappedToRangeMax(other.y,max);this.z=this.z.subtractWrappedToRangeMax(other.z,max);return this;};Coords.prototype.sumOfDimensions=function (){return this.x+this.y+this.z;};Coords.prototype.trimToMagnitudeMax=function (magnitudeMax){var magnitude=this.magnitude();if(magnitude>magnitudeMax){this.divideScalar(magnitude).multiplyScalar(magnitudeMax);}return this;};Coords.prototype.trimToRangeMax=function (max){if(this.x<0){this.x=0;}else if(this.x>max.x){this.x=max.x;}if(this.y<0){this.y=0;}else if(this.y>max.y){this.y=max.y;}if(this.z<0){this.z=0;}else if(this.z>max.z){this.z=max.z;}return this;};Coords.prototype.trimToRangeMinMax=function (min,max){if(this.x<min.x){this.x=min.x;}else if(this.x>=max.x){this.x=max.x;}if(this.y<min.y){this.y=min.y;}else if(this.y>=max.y){this.y=max.y;}if(this.z<min.z){this.z=min.z;}else if(this.z>=max.z){this.z=max.z;}return this;};Coords.prototype.wrapToRangeMax=function (max){while(this.x<0){this.x+=max.x;}while(this.x>=max.x){this.x-=max.x;}while(this.y<0){this.y+=max.y;}while(this.y>=max.y){this.y-=max.y;}if(max.z>0){while(this.z<0){this.z+=max.z;}while(this.z>=max.z){this.z-=max.z;}}return this;};Coords.prototype.toString=function (){return this.x+"x"+this.y+"x"+this.z;};Coords.prototype.toStringXY=function (){return this.x+"x"+this.y;};}function Location(pos,orientation,venue){this.pos=pos;if(orientation==null){orientation=Orientation.Instances().ForwardXDownZ.clone();}this.orientation=orientation;this.venue=venue;this.vel=new Coords(0,0,0);this.accel=new Coords(0,0,0);this.force=new Coords(0,0,0);this.spin=new Rotation(this.orientation.down,new Reference(0));this.timeOffsetInTicks=0;}{Location.prototype.clone=function (){var returnValue=new Location(this.pos.clone(),this.orientation.clone(),this.venue);returnValue.vel=this.vel.clone();returnValue.accel=this.accel.clone();returnValue.force=this.force.clone();returnValue.timeOffsetInTicks=this.timeOffsetInTicks;return returnValue;};Location.prototype.overwriteWith=function (other){this.venue=other.venue;this.pos.overwriteWith(other.pos);this.orientation.overwriteWith(other.orientation);this.vel.overwriteWith(other.vel);this.accel.overwriteWith(other.accel);this.force.overwriteWith(other.force);return this;};Location.prototype.toString=function (){return this.pos.clone().round().toString();};}function Orientation(forward,down){this.forward=forward.clone().normalize();this.right=down.clone().crossProduct(this.forward).normalize();this.down=this.forward.clone().crossProduct(this.right).normalize();this.axes=[this.forward,this.right,this.down];this.axesRDF=[this.right,this.down,this.forward];}{Orientation.Instances=function (){if(Orientation._Instances==null){Orientation._Instances=new Orientation_Instances();}return Orientation._Instances;};function Orientation_Instances(){this.ForwardXDownZ=new Orientation(new Coords(1,0,0),new Coords(0,0,1));this.ForwardZDownY=new Orientation(new Coords(0,0,1),new Coords(0,1,0));}Orientation.prototype.clone=function (){return new Orientation(this.forward.clone(),this.down.clone());};Orientation.prototype.forwardSet=function (value){this.forward.overwriteWith(value);return this.orthogonalize();};Orientation.prototype.forwardDownSet=function (forward,down){this.forward.overwriteWith(forward);this.down.overwriteWith(down);return this.orthogonalize();};Orientation.prototype.orthogonalize=function (value){this.forward.normalize();this.right.overwriteWith(this.down).crossProduct(this.forward).normalize();this.down.overwriteWith(this.forward).crossProduct(this.right).normalize();return this;};Orientation.prototype.overwriteWith=function (other){this.forward.overwriteWith(other.forward);this.right.overwriteWith(other.right);this.down.overwriteWith(other.down);return this;};Orientation.prototype.projectCoords=function (coords){coords.overwriteWithDimensions(coords.dotProduct(this.forward),coords.dotProduct(this.right),coords.dotProduct(this.down));return coords;};Orientation.prototype.unprojectCoords=function (coords){var returnValue=new Coords(0,0,0);var axisScaled=new Coords();for(var i=0;i<this.axes.length;i++){var axis=this.axes[i];axisScaled.overwriteWith(axis).multiplyScalar(coords.dimension(i));returnValue.add(axisScaled);}return coords.overwriteWith(returnValue);};Orientation.prototype.projectCoordsRDF=function (coords){coords.overwriteWithDimensions(coords.dotProduct(this.right),coords.dotProduct(this.down),coords.dotProduct(this.forward));return coords;};Orientation.prototype.unprojectCoordsRDF=function (coords){var returnValue=new Coords(0,0,0);var axisScaled=new Coords();for(var i=0;i<this.axesRDF.length;i++){var axis=this.axesRDF[i];axisScaled.overwriteWith(axis).multiplyScalar(coords.dimension(i));returnValue.add(axisScaled);}return coords.overwriteWith(returnValue);};Orientation.prototype.headingInTurns=function (){var returnValue;var forward=this.forward;if(forward.x==0 &&forward.y==0){returnValue=null;}else {returnValue=Math.atan2(forward.y,forward.x)/(Math.PI*2);if(returnValue<0){returnValue+=1;}returnValue=returnValue.wrapToRangeMinMax(0,1);}return returnValue;};}function Polar(azimuthInTurns,radius,elevationInTurns){this.azimuthInTurns=azimuthInTurns;this.radius=radius;this.elevationInTurns=(elevationInTurns==null?0 :elevationInTurns);}{Polar.RadiansPerTurn=Math.PI*2;Polar.prototype.addToAzimuthInTurns=function (turnsToAdd){this.azimuthInTurns+=turnsToAdd;return this;};Polar.prototype.fromCoords=function (coordsToConvert){this.azimuthInTurns=Math.atan2(coordsToConvert.y,coordsToConvert.x)/Polar.RadiansPerTurn;if(this.azimuthInTurns<0){this.azimuthInTurns+=1;}this.radius=coordsToConvert.magnitude();this.elevationInTurns=Math.asin(coordsToConvert.z/this.radius)/Polar.RadiansPerTurn;return this;};Polar.prototype.overwriteWith=function (other){this.azimuthInTurns=other.azimuthInTurns;this.radius=other.radius;this.elevationInTurns=other.elevationInTurns;return this;};Polar.prototype.overwriteWithAzimuthRadiusElevation=function (azimuthInTurns,radius,elevationInTurns){this.azimuthInTurns=azimuthInTurns;this.radius=radius;if(elevationInTurns!=null){this.elevationInTurns=elevationInTurns;}return this;};Polar.prototype.random=function (){this.azimuthInTurns=Math.random();this.elevationInTurns=Math.random();return this;};Polar.prototype.toCoords=function (coords){var azimuthInRadians=this.azimuthInTurns*Polar.RadiansPerTurn;var elevationInRadians=this.elevationInTurns*Polar.RadiansPerTurn;var cosineOfElevation=Math.cos(elevationInRadians);coords.overwriteWithDimensions(Math.cos(azimuthInRadians)*cosineOfElevation,Math.sin(azimuthInRadians)*cosineOfElevation,Math.sin(elevationInRadians)).multiplyScalar(this.radius);return coords;};Polar.prototype.wrap=function (){while(this.azimuthInTurns<0){this.azimuthInTurns++;}while(this.azimuthInTurns>=1){this.azimuthInTurns--;}return this;};}function Quaternion(w,x,y,z){this.w=w;this.x=x;this.y=y;this.z=z;}{Quaternion.fromAxisAndCyclesToRotate=function (axisToRotateAround,cyclesToRotate){var radiansToRotateHalf=cyclesToRotate*Math.PI;var sineOfRadiansToRotateHalf=Math.sin(radiansToRotateHalf);var w=Math.cos(radiansToRotateHalf);var x=axisToRotateAround.x*sineOfRadiansToRotateHalf;var y=axisToRotateAround.y*sineOfRadiansToRotateHalf;var z=axisToRotateAround.z*sineOfRadiansToRotateHalf;var returnValue=new Quaternion(w,x,y,z).normalize();return returnValue;};Quaternion.prototype.transformCoordsAsRotation=function (coordsToRotate){var coordsToRotateAsQuaternion=new Quaternion(0,coordsToRotate.x,coordsToRotate.y,coordsToRotate.z);var result=this.clone().multiply(coordsToRotateAsQuaternion).multiply(this.clone().invert());coordsToRotate.overwriteWith(result);return coordsToRotate;};Quaternion.prototype.clone=function (){return new Quaternion(this.w,this.x,this.y,this.z);};Quaternion.prototype.divide=function (divisor){this.w/=divisor;this.x/=divisor;this.y/=divisor;this.z/=divisor;return this;};Quaternion.prototype.invert=function (){var magnitude=this.magnitude();this.divide(magnitude*magnitude);this.x*=-1;this.y*=-1;this.z*=-1;return this;};Quaternion.prototype.multiply=function (other){return this.overwriteWithWXYZ(this.w*other.w-this.x*other.x-this.y*other.y-this.z*other.z,this.w*other.x+this.x*other.w+this.y*other.z-this.z*other.y,this.w*other.y-this.x*other.z+this.y*other.w+this.z*other.x,this.w*other.z+this.x*other.y-this.y*other.x+this.z*other.w);};Quaternion.prototype.magnitude=function (){return Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z);};Quaternion.prototype.normalize=function (){return this.divide(this.magnitude());};Quaternion.prototype.overwriteWith=function (other){this.overwriteWithWXYZ(other.w,other.x,other.y,other.z);return this;};Quaternion.prototype.overwriteWithWXYZ=function (w,x,y,z){this.w=w;this.x=x;this.y=y;this.z=z;return this;};}function Range(min,max){this.min=min;this.max=max;}{Range.prototype.clone=function (){return new Range(this.min,this.max);};Range.prototype.intersectWith=function (other){this.min=(this.min>=other.min?this.min:other.min);this.max=(this.max<=other.max?this.max:other.max);return this;};Range.prototype.midpoint=function (){return (this.min+this.max)/2;};Range.prototype.overlapsWith=function (other){var returnValue=((this.min>other.min&&this.min<other.max)||(this.max>other.min&&this.max<other.max)||(other.min>this.min&&other.min<this.max)||(other.max>this.min&&other.max<this.max));return returnValue;};Range.prototype.overwriteWith=function (other){this.min=min;this.max=max;return this;};}function Rotation(axis,angleInTurnsRef){this.axis=axis;this.angleInTurnsRef=angleInTurnsRef;}{Rotation.prototype.angleInTurns=function (){return this.angleInTurnsRef.value;};Rotation.prototype.transformCoords=function (coordsToTransform){var polar=new Polar().fromCoords(coordsToTransform);polar.azimuthInTurns=(polar.azimuthInTurns+this.angleInTurns()).wrapToRangeMinMax(0,1);return polar.toCoords(coordsToTransform);};Rotation.prototype.transformOrientation=function (orientation){orientation.forwardSet(this.transformCoords(orientation.forward));};}function Arc(shell,wedge){this.shell=shell;this.wedge=wedge;this._collider=new ShapeGroupAll([this.shell,this.wedge]);}{Arc.prototype.collider=function (){return this._collider;};}function Bounds(center,size){this.center=center;this.size=size;this.sizeHalf=this.size.clone().half();this._min=new Coords();this._max=new Coords();}{Bounds.prototype.containsOther=function (other){return (this.containsPoint(other.min())&&this.containsPoint(other.max()));};Bounds.prototype.containsPoint=function (pointToCheck){return pointToCheck.isInRangeMinMax(this.min(),this.max());};Bounds.prototype.max=function (){return this._max.overwriteWith(this.center).add(this.sizeHalf);};Bounds.prototype.min=function (){return this._min.overwriteWith(this.center).subtract(this.sizeHalf);};Bounds.prototype.ofPoints=function (points){var point0=points[0];var minSoFar=this._min.overwriteWith(point0);var maxSoFar=this._max.overwriteWith(point0);for(var i=1;i<points.length;i++){var point=points[i];if(point.x<minSoFar.x){minSoFar.x=point.x;}else if(point.x>maxSoFar.x){maxSoFar.x=point.x;}if(point.y<minSoFar.y){minSoFar.y=point.y;}else if(point.y>maxSoFar.y){maxSoFar.y=point.y;}if(point.z<minSoFar.z){minSoFar.z=point.z;}else if(point.z>maxSoFar.z){maxSoFar.z=point.z;}}this.center.overwriteWith(minSoFar).add(maxSoFar).half();this.size.overwriteWith(maxSoFar).subtract(minSoFar);this.sizeHalf.overwriteWith(this.size).half();return this;};Bounds.prototype.overlapsWith=function (other){var returnValue=false;var extremaThisAndOther=[[this.min().dimensions(),this.max().dimensions()],[other.min().dimensions(),other.max().dimensions()]];for(var b=0;b<extremaThisAndOther.length;b++){var extremaThis=extremaThisAndOther[b];var extremaOther=extremaThisAndOther[1 -b];var minThisDimensions=extremaThis[0];var maxThisDimensions=extremaThis[1];var minOtherDimensions=extremaOther[0];var maxOtherDimensions=extremaOther[1];var doAllDimensionsOverlapSoFar=true;for(var d=0;d<minThisDimensions.length;d++){if(maxThisDimensions[d]<=minOtherDimensions[d]||minThisDimensions[d]>=maxOtherDimensions[d]){doAllDimensionsOverlapSoFar=false;break;}}if(doAllDimensionsOverlapSoFar==true){returnValue=true;break;}}return returnValue;};Bounds.prototype.recalculate=function (){this.sizeHalf.overwriteWith(this.size).half();};Bounds.prototype.trimCoords=function (coordsToTrim){return coordsToTrim.trimToRangeMinMax(this.min(),this.max());};Bounds.prototype.toString=function (){return this.min().toString()+":"+this.max().toString();};}function Cylinder(center,radius,length){this.center=center;this.radius=radius;this.length=length;this.lengthHalf=this.length/2;}function Edge(vertices){this.vertices=vertices;this._direction=new Coords();this._displacement=new Coords();this._transverse=new Coords();}{Edge.prototype.bounds=function (){if(this._bounds==null){this._bounds=new Bounds(new Coords(),new Coords());}this._bounds.ofPoints(this.vertices);return this._bounds;};Edge.prototype.direction=function (){return this._direction.overwriteWith(this.displacement()).normalize();};Edge.prototype.displacement=function (){return this._displacement.overwriteWith(this.vertices[1]).subtract(this.vertices[0]);};Edge.prototype.length=function (){return this.displacement().magnitude();};Edge.prototype.transverse=function (faceNormal){return this._transverse.overwriteWith(this.direction()).crossProduct(faceNormal);};Edge.prototype.toString=function (){return this.vertices.toString();};}function Face(vertices){this.vertices=vertices;}{Face.prototype.bounds=function (){if(this._bounds==null){this._bounds=new Bounds(new Coords(0,0,0),new Coords(0,0,0));}this._bounds.ofPoints(this.vertices);return this._bounds;};Face.prototype.containsPoint=function (pointToCheck){var returnValue=true;var edges=this.edges();var normal=this.plane.normal;for(var e=0;e<edges.length;e++){var edge=edges[e];var distanceAlongTransverse=edge.transverse(normal).dotProduct(pointToCheck);var isPointWithinEdge=(distanceAlongTransverse>0);if(isPointWithinEdge==false){returnValue=false;break;}}return returnValue;};Face.prototype.edges=function (){if(this._edges==null){this._edges=[];for(var v=0;v<this.vertices.length;v++){var vNext=(v+1).wrapToRangeMinMax(0,this.vertices.length);var vertex=this.vertices[v];var vertexNext=this.vertices[vNext];var edge=new Edge([vertex,vertexNext]);this._edges.push(edge);}}return this._edges;};Face.prototype.plane=function (){if(this._plane==null){this._plane=new Plane(new Coords(),0);}this._plane.fromPoints(this.vertices[0],this.vertices[1],this.vertices[2]);return this._plane;};}function Hemispace(plane){this.plane=plane;}{Hemispace.prototype.containsPoint=function (pointToCheck){var distanceOfPointAbovePlane=pointToCheck.dotProduct(this.plane.normal)-this.plane.distanceFromOrigin;var returnValue=(distanceOfPointAbovePlane>0);return returnValue;};}function Map(sizeInCells,cellSize,cellPrototype,cellAtPosInCells,cellSource){this.sizeInCells=sizeInCells;this.cellSize=cellSize;this.cellPrototype=cellPrototype;this.cellAtPosInCells=cellAtPosInCells;this.cellSource=cellSource;this.sizeInCellsMinusOnes=this.sizeInCells.clone().subtract(Coords.Instances().Ones);this.size=this.sizeInCells.clone().multiply(this.cellSize);this.sizeHalf=this.size.clone().half();this.cellSizeHalf=this.cellSize.clone().half();this.posInCells=new Coords();}{Map.prototype.cellAtPos=function (cellPos,cellToOverwrite){this.posInCells.overwriteWith(cellPos).divide(this.cellSize).floor();return this.cellAtPosInCells(this.posInCells);};Map.prototype.numberOfCells=function (){return this.sizeInCells.x*this.sizeInCells.y;};}function MapCell(){}{MapCell.prototype.clone=function (){return new MapCell();};}function MapLocated(map,loc){this.map=map;this.loc=loc;this.bounds=new Bounds(this.loc.pos,this.map.size);}function Mesh(center,vertexOffsets,faceBuilders){this.center=center;this.vertexOffsets=vertexOffsets;this.faceBuilders=faceBuilders;}{Mesh.boxOfSize=function (center,size){var bounds=new Bounds(center,size);var returnValue=Mesh.fromBounds(bounds);return returnValue;};Mesh.cubeUnit=function (center){if(center==null){center=new Coords(0,0,0);}var size=new Coords(2,2,2);var returnValue=Mesh.boxOfSize(center,size);return returnValue;};Mesh.fromBounds=function (bounds){var sizeHalf=bounds.sizeHalf;var min=new Coords(-sizeHalf.x,-sizeHalf.y,-sizeHalf.z);var max=new Coords(sizeHalf.x,sizeHalf.y,sizeHalf.z);var vertexOffsets=[new Coords(min.x,min.y,min.z),new Coords(max.x,min.y,min.z),new Coords(max.x,max.y,min.z),new Coords(min.x,max.y,min.z),new Coords(min.x,min.y,max.z),new Coords(max.x,min.y,max.z),new Coords(max.x,max.y,max.z),new Coords(min.x,max.y,max.z),];var faceBuilders=[new Mesh_FaceBuilder([0,1,5,4]),new Mesh_FaceBuilder([1,2,6,5]),new Mesh_FaceBuilder([2,3,7,6]),new Mesh_FaceBuilder([3,0,4,7]),new Mesh_FaceBuilder([0,3,2,1]),new Mesh_FaceBuilder([4,5,6,7]),];var returnValue=new Mesh(bounds.center,vertexOffsets,faceBuilders);return returnValue;};Mesh.fromFace=function (center,faceToExtrude,thickness){var faceVertices=faceToExtrude.vertices;var numberOfFaceVertices=faceVertices.length;var thicknessHalf=thickness/2;var meshVertices=[];var faceBuilders=[];for(var z=0;z<2;z++){var offsetForExtrusion=new Coords(0,0,(z==0 ?-1 :1)).multiplyScalar(thicknessHalf);var vertexIndicesTopOrBottom=[];for(var v=0;v<numberOfFaceVertices;v++){var vertexIndex=meshVertices.length;if(z==0){var vertexIndexNext=(vertexIndex+1
).wrapToRangeMinMax(0,numberOfFaceVertices);var faceBuilderSide=new Mesh_FaceBuilder([vertexIndex,vertexIndexNext,vertexIndexNext+numberOfFaceVertices,vertexIndex+numberOfFaceVertices]);faceBuilders.push(faceBuilderSide);vertexIndicesTopOrBottom.push(vertexIndex);}else {vertexIndicesTopOrBottom.insertElementAt(vertexIndex,0);}var vertex=faceVertices[v].clone().add(offsetForExtrusion);meshVertices.push(vertex);}var faceBuilderTopOrBottom=new Mesh_FaceBuilder(vertexIndicesTopOrBottom);faceBuilders.push(faceBuilderTopOrBottom);}var returnValue=new Mesh(center,meshVertices,faceBuilders);return returnValue;};Mesh.prototype.bounds=function (){if(this._bounds==null){this._bounds=new Bounds(new Coords(),new Coords());}this._bounds.ofPoints(this.vertices());return this._bounds;};Mesh.prototype.faces=function (){var vertices=this.vertices();if(this._faces==null){this._faces=[];for(var f=0;f<this.faceBuilders.length;f++){var faceBuilder=this.faceBuilders[f];var face=faceBuilder.toFace(vertices);this._faces.push(face);}}return this._faces;};Mesh.prototype.vertices=function (){if(this._vertices==null){this._vertices=[];for(var v=0;v<this.vertexOffsets.length;v++){this._vertices.push(new Coords());}}for(var v=0;v<this._vertices.length;v++){var vertex=this._vertices[v];var vertexOffset=this.vertexOffsets[v];vertex.overwriteWith(this.center).add(vertexOffset);}return this._vertices;};Mesh.prototype.transform=function (transformToApply){for(var v=0;v<this.vertexOffsets.length;v++){var vertexOffset=this.vertexOffsets[v];transformToApply.transformCoords(vertexOffset);}this.vertices();return this;};Mesh.prototype.clone=function (){return new Mesh(this.center.clone(),this.vertexOffsets.clone(),this.faceBuilders.clone());};Mesh.prototype.overwriteWith=function (other){this.center.overwriteWith(other.center);this.vertexOffsets.overwriteWith(other.vertexOffsets);this.faceBuilders.overwriteWith(other.faceBuilders);};}function Mesh_FaceBuilder(vertexIndices){this.vertexIndices=vertexIndices;}{Mesh_FaceBuilder.prototype.toFace=function (meshVertices){var faceVertices=[];for(var vi=0;vi<this.vertexIndices.length;vi++){var vertexIndex=this.vertexIndices[vi];var meshVertex=meshVertices[vertexIndex];faceVertices.push(meshVertex);}var returnValue=new Face(faceVertices);return returnValue;};Mesh_FaceBuilder.prototype.vertexIndicesShift=function (offset){for(var i=0;i<this.vertexIndices.length;i++){var vertexIndex=this.vertexIndices[i];vertexIndex+=offset;this.vertexIndices[i]=vertexIndex;}};Mesh_FaceBuilder.prototype.clone=function (){return new Mesh_FaceBuilder(this.vertexIndices.slice());};Mesh_FaceBuilder.prototype.overwriteWith=function (other){this.vertexIndices.overwriteWith(other.vertexIndices);};}function Path(points){this.points=points;}{Path.prototype.clone=function (){return new Path(this.points.clone());};Path.prototype.overwriteWith=function (other){this.points.overwriteWith(other.points);return this;};Path.prototype.transform=function (transformToApply){Transform.applyTransformToCoordsMany(transformToApply,this.points);return this;};}function PathBuilder(){}{PathBuilder.prototype.star=function (numberOfPoints,ratioOfInnerRadiusToOuter){var numberOfVertices=numberOfPoints*2;var turnsPerVertex=1 /numberOfVertices;var polar=new Polar(0,1);var vertices=[];for(var i=0;i<numberOfVertices;i++){polar.radius=(i%2 ==0 ?1 :ratioOfInnerRadiusToOuter);var vertex=polar.toCoords(new Coords());vertices.push(vertex);polar.azimuthInTurns+=turnsPerVertex;}var returnValue=new Path(vertices);return returnValue;};}function Plane(normal,distanceFromOrigin){this.normal=normal;this.distanceFromOrigin=distanceFromOrigin;this.displacementFromPoint0To2=new Coords();}{Plane.prototype.distanceToPointAlongNormal=function (point){return point.dotProduct(this.normal)-this.distanceFromOrigin;};Plane.prototype.equals=function (other){return (this.normal.equals(other.normal)&&this.distanceFromOrigin==other.distanceFromOrigin);};Plane.prototype.fromPoints=function (point0,point1,point2){this.normal.overwriteWith(point1).subtract(point0).crossProduct(this.displacementFromPoint0To2.overwriteWith(point2).subtract(point0)).normalize();this.distanceFromOrigin=point0.dotProduct(this.normal);return this;};Plane.prototype.pointClosestToOrigin=function (point){return point.overwriteWith(this.normal).multiplyScalar(this.distanceFromOrigin);}}function Ray(vertex,direction){this.vertex=vertex;this.direction=direction;}function ShapeContainer(shape){this.shape=shape;}function ShapeGroupAll(shapes){this.shapes=shapes;}function ShapeGroupAny(shapes){this.shapes=shapes;}function ShapeInverse(shape){this.shape=shape;}function Shell(sphereOuter,radiusInner){this.sphereOuter=sphereOuter;this.radiusInner=radiusInner;this.sphereInner=new Sphere(this.sphereOuter.center,this.radiusInner);this._collider=new ShapeGroupAll([this.sphereOuter,new ShapeInverse(new ShapeContainer(this.sphereInner))]);}{Shell.prototype.collider=function (){return this._collider;};}function Sphere(center,radius){this.center=center;this.radius=radius;this._displacement=new Coords();}{Sphere.prototype.containsOther=function (other){var displacementOfOther=this._displacement.overwriteWith(other.center).subtract(this.center);var distanceOfOther=displacementOfOther.magnitude();var returnValue=(distanceOfOther+other.radius<=this.radius);return returnValue;};Sphere.prototype.pointRandom=function (){return new Polar(0,this.radius).random().toCoords(new Coords()).add(this.center);};}function Wedge(vertex,directionMin,angleSpannedInTurns){this.vertex=vertex;this.directionMin=directionMin;this.angleSpannedInTurns=angleSpannedInTurns;this.rayDirectionMinAsPolar=new Polar(0,1);}{Wedge.prototype.angleInTurnsMax=function (){var returnValue=(this.angleInTurnsMin()+this.angleSpannedInTurns).wrapToRangeMinMax(0,1
);return returnValue;};Wedge.prototype.angleInTurnsMin=function (){return this.rayDirectionMinAsPolar.fromCoords(this.directionMin).azimuthInTurns;};Wedge.prototype.collider=function (){if(this._collider==null){this.rayDirectionMinAsPolar=new Polar(0,1);this.rayDirectionMaxAsPolar=new Polar(0,1);this.rayDirectionMin=new Coords();this.rayDirectionMax=new Coords();this.downFromVertex=new Coords();this.directionMinFromVertex=new Coords();this.directionMaxFromVertex=new Coords();this.planeForAngleMin=new Plane(new Coords());this.planeForAngleMax=new Plane(new Coords());this.hemispaces=[new Hemispace(this.planeForAngleMin),new Hemispace(this.planeForAngleMax)];this.shapeGroupAll=new ShapeGroupAll(this.hemispaces);this.shapeGroupAny=new ShapeGroupAny(this.hemispaces);}var angleInTurnsMin=this.angleInTurnsMin();var angleInTurnsMax=this.angleInTurnsMax();this.rayDirectionMinAsPolar.azimuthInTurns=angleInTurnsMin;this.rayDirectionMinAsPolar.toCoords(this.rayDirectionMin);this.rayDirectionMaxAsPolar.azimuthInTurns=angleInTurnsMax;this.rayDirectionMaxAsPolar.toCoords(this.rayDirectionMax);var down=Coords.Instances().ZeroZeroOne;this.downFromVertex.overwriteWith(this.vertex).add(down);this.directionMinFromVertex.overwriteWith(this.vertex).add(this.rayDirectionMin);this.directionMaxFromVertex.overwriteWith(this.vertex).add(this.rayDirectionMax);this.planeForAngleMin.fromPoints(this.vertex,this.directionMinFromVertex,this.downFromVertex);this.planeForAngleMax.fromPoints(this.vertex,this.downFromVertex,this.directionMaxFromVertex);if(this.angleSpannedInTurns<.5){this._collider=this.shapeGroupAll;}else {this._collider=this.shapeGroupAny;}return this._collider;};}function Bone(name,length,orientation,children,isVisible){this.name=name;this.length=length;this.orientation=orientation;this.children=children;this.isVisible=(isVisible==null?true:isVisible);for(var i=0;i<this.children.length;i++){var child=this.children[i];child.parentName=this.name;}}{Bone.prototype.pos=function (bonesAll){var returnValue=new Coords(0,0,0);var bone=bonesAll[this.parentName];while(bone!=null){returnValue.add(bone.orientation.forward.clone().multiplyScalar(bone.length));bone=bonesAll[bone.parentName];}return returnValue;};Bone.prototype.clone=function (){var orientationCloned=this.orientation.clone();var returnValue=new Bone(this.name,this.length,orientationCloned,this.children.clone(),this.isVisible);return returnValue;};Bone.prototype.overwriteWith=function (other){this.orientation.overwriteWith(other.orientation);this.children.overwriteWith(other.children);};Bone.prototype.transform=function (transformToApply){var axes=this.orientation.axes;for(var i=0;i<axes.length;i++){var axis=axes[i];transformToApply.transformCoords(axis);}};}function BoneInfluence(boneName,vertexIndicesControlled){this.boneName=boneName;this.vertexIndicesControlled=vertexIndicesControlled;}{BoneInfluence.buildManyForBonesAndVertexGroups=function (bones,vertexGroups){var boneInfluences=[];for(var i=0;i<vertexGroups.length;i++){var vertexGroup=vertexGroups[i];var boneName=vertexGroup.name;var bone=bones[boneName];if(bone!=null){var boneInfluence=new BoneInfluence(boneName,vertexGroup.vertexIndices.slice());boneInfluences.push(boneInfluence);}}return boneInfluences;}}function Skeleton(name,boneRoot){this.name=name;this.boneRoot=boneRoot;this.bonesAll=[];this.bonesAll=TreeHelper.addNodeAndAllDescendantsToList(this.boneRoot,[]);this.bonesAll.addLookups("name");}{Skeleton.prototype.equals=function (other){var returnValue=true;for(var i=0;i<this.bonesAll.length;i++){var boneFromThis=this.bonesAll[i];var boneFromOther=other.bonesAll[i];if(boneFromThis.orientation.equals(boneFromOther.orientation)==false){returnValue=false;break;}}return returnValue;};Skeleton.prototype.clone=function (other){return new Skeleton(this.name,this.boneRoot.clone());};Skeleton.prototype.overwriteWith=function (other){for(var i=0;i<this.bonesAll.length;i++){this.bonesAll[i].overwriteWith(other.bonesAll[i]);}};Skeleton.prototype.transform=function (transformToApply){for(var i=0;i<this.bonesAll.length;i++){var bone=this.bonesAll[i];bone.transform(transformToApply);}};}function SkeletonHelper(){}{SkeletonHelper.biped=function (heightInPixels){var heightOver2=heightInPixels/2;var heightOfSpine=heightInPixels/2.4;var heightOver3=heightInPixels/3;var heightOver4=heightInPixels/4;var heightOver6=heightInPixels/6;var heightOver8=heightInPixels/8;var heightOver9=heightInPixels/9;var heightOver12=heightInPixels/12;var heightOver18=heightInPixels/18;var legRight=new Bone("Hip.R",heightOver12,new Orientation(new Coords(-1,0,0),new Coords(0,0,1)),[new Bone("Thigh.R",heightOver4,new Orientation(new Coords(0,0,1),new Coords(-1,0,0)),[new Bone("Shin.R",heightOver4,new Orientation(new Coords(0,0,1),new Coords(1,0,0)),[new Bone("Foot.R",heightOver8,new Orientation(new Coords(0,1,0),new Coords(1,0,0)),[])]),])]);var legLeft=new Bone("Hip.L",heightOver12,new Orientation(new Coords(1,0,0),new Coords(0,0,1)),[new Bone("Thigh.L",heightOver4,new Orientation(new Coords(0,0,1),new Coords(-1,0,0)),[new Bone("Shin.L",heightOver4,new Orientation(new Coords(0,0,1),new Coords(1,0,0)),[new Bone("Foot.L",heightOver8,new Orientation(new Coords(0,1,0),new Coords(1,0,0)),[])]),])]);var upperEntity=new Bone("Spine.1",heightOfSpine,new Orientation(new Coords(0,0,-1),new Coords(0,-1,0)),[new Bone("Neck",heightOver12,new Orientation(new Coords(0,0,-1),new Coords(0,1,0)),[new Bone("Head.Back",heightOver18,new Orientation(new Coords(0,0,-1),new Coords(0,1,0)),[new Bone("Head.Front",heightOver9,new Orientation(new Coords(0,1,0),new Coords(0,0,1)),[]),])]),new Bone("Shoulder.L",heightOver6,new Orientation(new Coords(1,0,0),new Coords(0,0,1)),[new Bone("Bicep.L",heightOver6,new Orientation(new Coords(0,-.1,1),new Coords(-1,0,0)),[new Bone("Forearm.L",heightOver6,new Orientation(new Coords(0,.1,1),new Coords(-1,0,0)),[])])]),new Bone("Shoulder.R",heightOver6,new Orientation(new Coords(-1,0,0),new Coords(0,0,1)),[new Bone("Bicep.R",heightOver6,new Orientation(new Coords(0,-.1,1),new Coords(-1,0,0)),[new Bone("Forearm.R",heightOver6,new Orientation(new Coords(0,.1,1),new Coords(-1,0,0)),[])])])]);var skeletonBiped=new Skeleton("Skeleton0",new Bone("Root",heightOver2,new Orientation(new Coords(0,0,-1),new Coords(0,1,0)),[legRight,legLeft,upperEntity,],false));/*skeletonBiped.transform(new Transform_DimensionsSwap([0,1]));skeletonBiped.transform(new Transform_Scale(new Coords(-1,-1,1)));*/skeletonBiped.transform(new Transform_Orient(new Orientation(new Coords(0,1,0),new Coords(0,0,1))));return skeletonBiped;};SkeletonHelper.bipedAnimationDefnGroup=function (){var returnValue=new AnimationDefnGroup("Biped",[SkeletonHelper.bipedAnimationDefnDoSomething(),SkeletonHelper.bipedAnimationDefnJump(),SkeletonHelper.bipedAnimationDefnWalk(),]);return returnValue;};SkeletonHelper.bipedAnimationDefnDoSomething=function (){var returnValue=new AnimationDefn("DoSomething",[new AnimationKeyframe(0,[new Transform_BonePose("Forearm.L",[.25 ]),new Transform_BonePose("Bicep.L",[.25,0,-.25 ]),new Transform_BonePose("Forearm.R",[.25 ]),new Transform_BonePose("Bicep.R",[.25,0,.25 ]),]),new AnimationKeyframe(1,[new Transform_BonePose("Forearm.L",[.25 ]),new Transform_BonePose("Bicep.L",[.25,0,.25 ]),new Transform_BonePose("Forearm.R",[.25 ]),new Transform_BonePose("Bicep.R",[.25,0,-.25 ]),]),]);return returnValue;};SkeletonHelper.bipedAnimationDefnJump=function (){var returnValue=new AnimationDefn("Jump",[new AnimationKeyframe(0,[new Transform_BonePose("Thigh.L",[.25 ]),new Transform_BonePose("Shin.L",[.25 ]),new Transform_BonePose("Thigh.R",[.25 ]),new Transform_BonePose("Shin.R",[.25 ]),]),new AnimationKeyframe(1,[new Transform_BonePose("Thigh.L",[.25 ]),new Transform_BonePose("Shin.L",[.25 ]),new Transform_BonePose("Thigh.R",[.25 ]),new Transform_BonePose("Shin.R",[.25 ]),]),]);return returnValue;};SkeletonHelper.bipedAnimationDefnWalk=function (){var animationDefnBipedWalk=new AnimationDefn("Walk",[new AnimationKeyframe(0,[new Transform_BonePose("Bicep.L",[-.1 ]),new Transform_BonePose("Forearm.L",[0 ]),new Transform_BonePose("Thigh.L",[.1 ]),new Transform_BonePose("Shin.L",[0 ]),new Transform_BonePose("Bicep.R",[.1 ]),new Transform_BonePose("Forearm.R",[.1 ]),new Transform_BonePose("Thigh.R",[-.05 ]),new Transform_BonePose("Shin.R",[0 ]),]),new AnimationKeyframe(5,[new Transform_BonePose("Thigh.L",[.1 ]),new Transform_BonePose("Shin.L",[.1 ]),new Transform_BonePose("Thigh.R",[-.1 ]),new Transform_BonePose("Shin.R",[0 ]),]),new AnimationKeyframe(10,[new Transform_BonePose("Thigh.L",[0 ]),new Transform_BonePose("Shin.L",[0 ]),new Transform_BonePose("Thigh.R",[0 ]),new Transform_BonePose("Shin.R",[.1 ]),]),new AnimationKeyframe(15,[new Transform_BonePose("Bicep.L",[.1 ]),new Transform_BonePose("Forearm.L",[.1 ]),new Transform_BonePose("Thigh.L",[-.05 ]),new Transform_BonePose("Bicep.R",[-.1 ]),new Transform_BonePose("Forearm.R",[0 ]),new Transform_BonePose("Thigh.R",[.1 ]),new Transform_BonePose("Shin.R",[0 ]),]),new AnimationKeyframe(20,[new Transform_BonePose("Thigh.L",[-.1 ]),new Transform_BonePose("Shin.L",[0 ]),new Transform_BonePose("Thigh.R",[.1 ]),new Transform_BonePose("Shin.R",[.1 ]),]),new AnimationKeyframe(25,[new Transform_BonePose("Thigh.L",[0 ]),new Transform_BonePose("Shin.L",[.1 ]),new Transform_BonePose("Thigh.R",[0 ]),new Transform_BonePose("Shin.R",[0 ]),]),new AnimationKeyframe(30,[new Transform_BonePose("Bicep.L",[-.1 ]),new Transform_BonePose("Forearm.L",[0 ]),new Transform_BonePose("Thigh.L",[.1 ]),new Transform_BonePose("Shin.L",[0 ]),new Transform_BonePose("Bicep.R",[.1 ]),new Transform_BonePose("Forearm.R",[.1 ]),new Transform_BonePose("Thigh.R",[-.05 ]),new Transform_BonePose("Shin.R",[0 ]),]),]);return animationDefnBipedWalk;};SkeletonHelper.transformBuildForMeshAndSkeleton_Proximity=function (meshAtRest,skeletonAtRest,skeletonPosed){var vertices=meshAtRest.vertices;var bones=skeletonAtRest.bonesAll;var boneNameToInfluenceLookup=[];for(var v=0;v<vertices.length;v++){var vertex=vertices[v];var distanceLeastSoFar=Number.POSITIVE_INFINITY;var indexOfBoneClosestSoFar=null;for(var b=0;b<bones.length;b++){var bone=bones[b];var displacement=vertex.clone().subtract(bone.pos(bones).add(bone.orientation.forward.clone().multiplyScalar(bone.length)));var distance=displacement.magnitude();if(distance<distanceLeastSoFar){distanceLeastSoFar=distance;indexOfBoneClosestSoFar=b;}}var boneClosest=bones[indexOfBoneClosestSoFar];var boneClosestName=boneClosest.name;var boneInfluence=boneNameToInfluenceLookup[boneClosestName];if(boneInfluence==null){boneInfluence=new BoneInfluence(boneClosestName,[]);boneNameToInfluenceLookup[boneClosestName]=boneInfluence;boneNameToInfluenceLookup.push(boneInfluence);}boneInfluence.vertexIndicesControlled.push(v);}var returnValue=new TransformMeshPoseWithSkeleton(meshAtRest,skeletonAtRest,skeletonPosed,boneNameToInfluenceLookup);return returnValue;};}function Transform_BonePose(boneName,cyclesToRotateAroundAxesDownRightForward){this.boneName=boneName;this.cyclesToRotateAroundAxesDownRightForward=cyclesToRotateAroundAxesDownRightForward;this.propertyName=this.boneName;}{Transform_BonePose.prototype.clone=function (){return new Transform_BonePose(this.boneName,this.cyclesToRotateAroundAxesDownRightForward);};Transform_BonePose.prototype.interpolateWith=function (other,fractionOfProgressTowardOther){var cyclesToRotateAroundAxesDownRightForwardInterpolated=[];for(var i=0;i<this.cyclesToRotateAroundAxesDownRightForward.length;i++){var cyclesToRotateInterpolated=(1 -fractionOfProgressTowardOther)*this.cyclesToRotateAroundAxesDownRightForward[i]+fractionOfProgressTowardOther*other.cyclesToRotateAroundAxesDownRightForward[i];cyclesToRotateAroundAxesDownRightForwardInterpolated[i]=cyclesToRotateInterpolated;}var returnValue=new Transform_BonePose(this.boneName,cyclesToRotateAroundAxesDownRightForwardInterpolated);return returnValue;};Transform_BonePose.prototype.transform=function (transformableToTransform){var skeletonToTransform=transformableToTransform;var boneToTransform=skeletonToTransform.bonesAll[this.boneName];var boneOrientation=boneToTransform.orientation;var axesToRotateAround=[boneOrientation.down,boneOrientation.right,boneOrientation.forward,];var quaternionsForRotation=[];for(var i=0;i<this.cyclesToRotateAroundAxesDownRightForward.length;i++){var axisToRotateAround=axesToRotateAround[i];var cyclesToRotateAroundAxis=this.cyclesToRotateAroundAxesDownRightForward[i];if(cyclesToRotateAroundAxis!=0){var quaternionForRotation=Quaternion.fromAxisAndCyclesToRotate(axisToRotateAround,cyclesToRotateAroundAxis);quaternionsForRotation.push(quaternionForRotation);}}this.transform_Bone(quaternionsForRotation,boneToTransform)};Transform_BonePose.prototype.transform_Bone=function (quaternionsForRotation,boneToTransform){var axesToTransform=boneToTransform.orientation.axes;for(var i=0;i<quaternionsForRotation.length;i++){var quaternionForRotation=quaternionsForRotation[i];for(var a=0;a<axesToTransform.length;a++){var axisToTransform=axesToTransform[a];quaternionForRotation.transformCoordsAsRotation(axisToTransform);}}for(var i=0;i<boneToTransform.children.length;i++){var childBone=boneToTransform.children[i];this.transform_Bone(quaternionsForRotation,childBone);}};}function Transform_MeshPoseWithSkeleton(meshAtRest,skeletonAtRest,skeletonPosed,boneInfluences){this.meshAtRest=meshAtRest;this.skeletonAtRest=skeletonAtRest;this.skeletonPosed=skeletonPosed;this.boneInfluences=boneInfluences;this.boneInfluences.addLookups("boneName");this._orientation=new Orientation(new Coords(),new Coords());this._vertex=new Coords();}{Transform_MeshPoseWithSkeleton.prototype.transformMesh=function (meshToPose){var meshAtRestVertices=this.meshAtRest.geometry.vertexOffsets;var meshToPoseVertices=meshToPose.geometry.vertexOffsets;var bonesAtRest=this.skeletonAtRest.bonesAll;var bonesPosed=this.skeletonPosed.bonesAll;for(var i=0;i<this.boneInfluences.length;i++){var boneInfluence=this.boneInfluences[i];var boneName=boneInfluence.boneName;var boneAtRest=bonesAtRest[boneName];var bonePosed=bonesPosed[boneName];var boneAtRestOrientation=boneAtRest.orientation;var vertexIndicesControlled=boneInfluence.vertexIndicesControlled;for(var vi=0;vi<vertexIndicesControlled.length;vi++){var vertexIndex=vertexIndicesControlled[vi];var vertexAtRest=meshAtRestVertices[vertexIndex];var vertexToPose=meshToPoseVertices[vertexIndex];var boneAtRestPos=boneAtRest.pos(bonesAtRest);var bonePosedPos=bonePosed.pos(bonesPosed);var vertexAtRestProjected=this._vertex.overwriteWith(vertexAtRest).subtract(boneAtRestPos);vertexAtRestProjected.overwriteWithDimensions(vertexAtRestProjected.dotProduct(boneAtRestOrientation.right),vertexAtRestProjected.dotProduct(boneAtRestOrientation.down),vertexAtRestProjected.dotProduct(boneAtRestOrientation.forward));vertexToPose.overwriteWith(bonePosedPos);var bonePosedOrientation=this._orientation.overwriteWith(bonePosed.orientation);vertexToPose.add(bonePosedOrientation.right.multiplyScalar(vertexAtRestProjected.x)).add(bonePosedOrientation.down.multiplyScalar(vertexAtRestProjected.y)).add(bonePosedOrientation.forward.multiplyScalar(vertexAtRestProjected.z));}}};}function Transform(){}{Transform.applyTransformToCoordsArrays=function (transformToApply,coordsArraysToTransform){if(coordsArraysToTransform==null){return ;}for(var i=0;i<coordsArraysToTransform.length;i++){var coordsArray=coordsArraysToTransform[i];Transform.applyTransformToCoordsMany(transformToApply,coordsArray);}};Transform.applyTransformToCoordsMany=function (transformToApply,coordsSetToTransform){for(var i=0;i<coordsSetToTransform.length;i++){transformToApply.transformCoords(coordsSetToTransform[i]);}};}function Transform_Camera(camera){this.camera=camera;this.transformTranslateInvert=new Transform_TranslateInvert(this.camera.loc.pos);this.transformOrientForCamera=new Transform_OrientForCamera(this.camera.loc.orientation);this.transformPerspective=new Transform_Perspective(this.camera.focalLength);this.transformViewCenter=new Transform_Translate(this.camera.viewSizeHalf);}{Transform_Camera.prototype.transformCoords=function (coordsToTransform){this.transformTranslateInvert.transformCoords(coordsToTransform);this.transformOrientForCamera.transformCoords(coordsToTransform);this.transformPerspective.transformCoords(coordsToTransform);this.transformViewCenter.transformCoords(coordsToTransform);return coordsToTransform;};}function Transform_DimensionsSwap(dimensionIndices){this.dimensionIndices=dimensionIndices;}{Transform_DimensionsSwap.prototype.transformCoords=function (coordsToTransform){var dimensionIndex0=this.dimensionIndices[0];var dimensionIndex1=this.dimensionIndices[1];var dimension0=coordsToTransform.dimension(dimensionIndex0);var dimension1=coordsToTransform.dimension(dimensionIndex1);coordsToTransform.dimension(dimensionIndex0,dimension1);coordsToTransform.dimension(dimensionIndex1,dimension0);return coordsToTransform;};}function Transform_Locate(loc){this.loc=loc;this.transformOrient=new Transform_Orient();this.transformTranslate=new Transform_Translate();}{Transform_Locate.prototype.transformCoords=function (coordsToTransform){this.transformOrient.orientation=this.loc.orientation;this.transformOrient.transformCoords(coordsToTransform);this.transformTranslate.displacement=this.loc.pos;this.transformTranslate.transformCoords(coordsToTransform);return coordsToTransform;};}function Transform_Multiple(transforms){this.transforms=transforms;}{Transform_Multiple.prototype.transformCoords=function (coordsToTransform){for(var i=0;i<this.transforms.length;i++){var transform=this.transforms[i];transform.transformCoords(coordsToTransform);}return coordsToTransform;};}function Transform_Orient(orientation){this.orientation=orientation;}{Transform_Orient.prototype.transformCoords=function (coordsToTransform){coordsToTransform.overwriteWithDimensions(this.orientation.forward.dotProduct(coordsToTransform),this.orientation.right.dotProduct(coordsToTransform),this.orientation.down.dotProduct(coordsToTransform));return coordsToTransform;};}function Transform_OrientForCamera(orientation){this.orientation=orientation;}{Transform_OrientForCamera.prototype.transformCoords=function (coordsToTransform){coordsToTransform.overwriteWithDimensions(this.orientation.right.dotProduct(coordsToTransform),this.orientation.down.dotProduct(coordsToTransform),this.orientation.forward.dotProduct(coordsToTransform));return coordsToTransform;};}function TransformOrient(orientation){this.orientation=orientation;}{TransformOrient.prototype.transformCoords=function (coordsToTransform){coordsToTransform.overwriteWithDimensions(coordsToTransform.dotProduct(this.orientation.right),coordsToTransform.dotProduct(this.orientation.down),coordsToTransform.dotProduct(this.orientation.forward));};}function Transform_Perspective(focalLength){this.focalLength=focalLength;}{Transform_Perspective.prototype.transformCoords=function (coordsToTransform){var distanceAlongCameraForward=coordsToTransform.z;coordsToTransform.multiplyScalar(this.focalLength);if(distanceAlongCameraForward!=0){coordsToTransform.divideScalar(distanceAlongCameraForward);}return coordsToTransform;};}function Transform_Rotate2D(turnsToRotate){this.turnsToRotate=turnsToRotate;this._polar=new Polar(0,1);}{Transform_Rotate2D.prototype.transformCoords=function (coordsToTransform){this._polar.fromCoords(coordsToTransform).addToAzimuthInTurns(this.turnsToRotate).wrap().toCoords(coordsToTransform);return coordsToTransform;};}function Transform_RotateRight(quarterTurnsToRotate){this.quarterTurnsToRotate=quarterTurnsToRotate;}{Transform_RotateRight.prototype.transformCoords=function (coordsToTransform){for(var i=0;i<this.quarterTurnsToRotate;i++){var temp=coordsToTransform.x;coordsToTransform.x=0 -coordsToTransform.y;coordsToTransform.y=temp;}return coordsToTransform;};}function Transform_Scale(scaleFactors){this.scaleFactors=scaleFactors;}{Transform_Scale.prototype.transformCoords=function (coordsToTransform){return coordsToTransform.multiply(this.scaleFactors);};}function Transform_Translate(displacement){this.displacement=displacement;}{Transform_Translate.prototype.transformCoords=function (coordsToTransform){return coordsToTransform.add(this.displacement);};}function Transform_TranslateInvert(displacement){this.displacement=displacement;}{Transform_TranslateInvert.prototype.transformCoords=function (coordsToTransform){return coordsToTransform.subtract(this.displacement);};}function Input(name){this.name=name;this.isActive=true;this.ticksActive=0;}function InputHelper(){this.mouseClickPos=new Coords();this.mouseMovePos=new Coords(0,0);this.mouseMovePosPrev=new Coords(0,0);this.mouseMovePosNext=new Coords(0,0);this.keysToPreventDefaultsFor=["ArrowLeft","ArrowRight","Tab"];}{InputHelper.prototype.initialize=function (universe){this.inputsPressed=[];this.gamepadsConnected=[];document.body.onkeydown=this.handleEventKeyDown.bind(this);document.body.onkeyup=this.handleEventKeyUp.bind(this);var divMain=universe.platformHelper.divMain;divMain.onmousedown=this.handleEventMouseDown.bind(this);divMain.onmouseup=this.handleEventMouseUp.bind(this);this.isMouseMovementTracked=true;if(this.isMouseMovementTracked==true){divMain.onmousemove=this.handleEventMouseMove.bind(this);}this.gamepadsCheck();};InputHelper.prototype.inputAdd=function (inputPressedName){if(this.inputsPressed[inputPressedName]==null){var inputPressed=new Input(inputPressedName);this.inputsPressed[inputPressedName]=inputPressed;this.inputsPressed.push(inputPressed);}};InputHelper.prototype.inputRemove=function (inputReleasedName){if(this.inputsPressed[inputReleasedName]!=null){var inputReleased=this.inputsPressed[inputReleasedName];delete this.inputsPressed[inputReleasedName];this.inputsPressed.remove(inputReleased);}};InputHelper.prototype.inputsRemoveAll=function (){for(var i=0;i<this.inputsPressed.length;i++){var input=this.inputsPressed[i];this.inputRemove(input);}};InputHelper.prototype.isMouseClicked=function (value){if(value==null){var inputPressed=this.inputsPressed["MouseClick"];return (inputPressed!=null&&inputPressed.isActive==true);}else {if(value==true){this.inputAdd("MouseClick");}else {this.inputRemove("MouseClick");}}};InputHelper.prototype.updateForTimerTick=function (universe){this.updateForTimerTick_Gamepads(universe);};InputHelper.prototype.updateForTimerTick_Gamepads=function (universe){var systemGamepads=this.systemGamepads();for(var i=0;i<this.gamepadsConnected.length;i++){var gamepad=this.gamepadsConnected[i];var systemGamepad=systemGamepads[gamepad.index];gamepad.updateFromSystemGamepad(systemGamepad);var gamepadID="Gamepad"+i;var axisDisplacements=gamepad.axisDisplacements;for(var a=0;a<axisDisplacements.length;a++){var gamepadIDMove=gamepadID+"Move";var axisDisplacement=axisDisplacements[a];if(axisDisplacement==0){if(a==0){this.inputRemove(gamepadIDMove+"Left");this.inputRemove(gamepadIDMove+"Right");}else {this.inputRemove(gamepadIDMove+"Up");this.inputRemove(gamepadIDMove+"Down");}}else {var directionName;if(a==0){directionName=(axisDisplacement<0 ?"Left":"Right");}else {directionName=(axisDisplacement<0 ?"Up":"Down");}this.inputAdd(gamepadIDMove+directionName);}}var gamepadIDButton=gamepadID+"Button";var buttonsPressed=gamepad.buttonsPressed;for(var b=0;b<buttonsPressed.length;b++){var buttonPressed=buttonsPressed[b];if(buttonPressed==true){this.inputAdd(gamepadIDButton+b);}else {this.inputRemove(gamepadIDButton+b);}}}};InputHelper.prototype.handleEventKeyDown=function (event){var inputPressed=event.key;if(this.keysToPreventDefaultsFor.contains(inputPressed)==true){event.preventDefault();}if(inputPressed==" "){inputPressed="_";}else if(inputPressed=="_"){inputPressed="__";}else if(isNaN(inputPressed)==false){inputPressed="_"+inputPressed;}this.inputAdd(inputPressed);};InputHelper.prototype.handleEventKeyUp=function (event){var inputReleased=event.key;if(inputReleased==" "){inputReleased="_";}else if(inputReleased=="_"){inputReleased="__";}else if(isNaN(inputReleased)==false){inputReleased="_"+inputReleased;}this.inputRemove(inputReleased);};InputHelper.prototype.handleEventMouseDown=function (event){var canvas=event.target;var canvasBounds=canvas.getBoundingClientRect();this.mouseClickPos.overwriteWithDimensions(event.clientX-canvasBounds.left,event.clientY-canvasBounds.top,0
);this.inputAdd("MouseClick");};InputHelper.prototype.handleEventMouseMove=function (event){var canvas=event.target;var canvasBounds=canvas.getBoundingClientRect();this.mouseMovePosNext.overwriteWithDimensions(event.clientX-canvasBounds.left,event.clientY-canvasBounds.top,0
);if(this.mouseMovePosNext.equals(this.mouseMovePos)==false){this.mouseMovePosPrev.overwriteWith(this.mouseMovePos);this.mouseMovePos.overwriteWith(this.mouseMovePosNext);this.inputAdd("MouseMove");}};InputHelper.prototype.handleEventMouseUp=function (event){this.inputRemove("MouseClick");};InputHelper.prototype.gamepadsCheck=function (){var systemGamepads=this.systemGamepads();for(var i=0;i<systemGamepads.length;i++){var systemGamepad=systemGamepads[i];if(systemGamepad!=null){var gamepad=new Gamepad(i);this.gamepadsConnected.push(gamepad);}}};InputHelper.prototype.systemGamepads=function (){return navigator.getGamepads();};}function InputToActionMapping(inputName,actionName,inactivateInputWhenActionPerformed){this.inputName=inputName;this.actionName=actionName;this.inactivateInputWhenActionPerformed=inactivateInputWhenActionPerformed;}{InputToActionMapping.prototype.action=function (universe){return universe.world.defns.actions[this.actionName];};}function Font(name,sourcePath){this.name=name;this.sourcePath=sourcePath;this.isLoaded=false;this.load();}{Font.prototype.load=function (){var fontAsStyleElement=document.createElement("style");fontAsStyleElement.innerHTML="@font-face { "+"font-family: '"+this.name+"';"+"src: url('"+this.sourcePath+"');";+"}";document.head.appendChild(fontAsStyleElement);this.isLoaded=true;};}function Image(name,sourcePath){this.name=name;this.sourcePath=sourcePath;this.isLoaded=false;this.load();}{Image.fromSystemImage=function (name,systemImage){var returnValue=new Image(name,systemImage.src);returnValue.systemImage=systemImage;returnValue.sizeInPixels=new Coords(systemImage.width,systemImage.height);returnValue.isLoaded=true;return returnValue;};Image.prototype.load=function (){if(this.sourcePath!=null){var image=this;var imgElement=document.createElement("img");imgElement.onload=function (event){var imgLoaded=event.target;image.isLoaded=true;image.systemImage=imgLoaded;image.sizeInPixels=new Coords(imgLoaded.width,imgLoaded.height);};imgElement.src=this.sourcePath;}};}function MediaLibrary(images,sounds,videos,fonts,textStrings){this.images=images.addLookups("name");this.sounds=sounds.addLookups("name");this.videos=videos.addLookups("name");this.fonts=fonts.addLookups("name");this.textStrings=textStrings.addLookups("name");this.collectionsAll=[this.images,this.sounds,this.videos,this.fonts,this.textStrings];this.collectionsAll["Images"]=this.images;this.collectionsAll["Sounds"]=this.sounds;this.collectionsAll["Videos"]=this.videos;this.collectionsAll["Fonts"]=this.fonts;this.collectionsAll["TextStrings"]=this.textStrings;}{MediaLibrary.prototype.areAllItemsLoaded=function (){var areAllItemsLoadedSoFar=true;for(var c=0;c<this.collectionsAll.length;c++){var collection=this.collectionsAll[c];for(var i=0;i<collection.length;i++){var item=collection[i];if(item.isLoaded==false){areAllItemsLoadedSoFar=false;break;}}if(areAllItemsLoadedSoFar==false){break;}}return areAllItemsLoadedSoFar;};MediaLibrary.prototype.waitForItemToLoad=function (collectionName,itemName,callback){var itemToLoad=this.collections[collectionName][itemName];this.timer=setInterval(this.waitForItemToLoad_TimerTick.bind(this,itemToLoad,callback),100 );};MediaLibrary.prototype.waitForItemToLoad_TimerTick=function (itemToLoad,callback){if(itemToLoad.isLoaded==true){clearInterval(this.timer);callback.call();}};MediaLibrary.prototype.waitForItemsAllToLoad=function (callback){this.timer=setInterval(this.waitForItemsAllToLoad_TimerTick.bind(this,callback),100 );};MediaLibrary.prototype.waitForItemsAllToLoad_TimerTick=function (callback){if(this.areAllItemsLoaded()==true){clearInterval(this.timer);callback.call();}};MediaLibrary.prototype.imagesAdd=function (images){for(var i=0;i<images.length;i++){var image=images[i];if(this.images[image.name]==null){this.images.push(image);this.images[image.name]=image;}}};MediaLibrary.prototype.fontGetByName=function (name){return this.fonts[name];};MediaLibrary.prototype.imageGetByName=function (name){return this.images[name];};MediaLibrary.prototype.soundGetByName=function (name){return this.sounds[name];};MediaLibrary.prototype.textStringGetByName=function (name){return this.textStrings[name];};MediaLibrary.prototype.videoGetByName=function (name){return this.videos[name];};}function Sound(name,sourcePath,isRepeating){this.name=name;this.sourcePath=sourcePath;this.isRepeating=isRepeating;this.offsetInSeconds=0;this.isPlaying=false;}{Sound.prototype.domElementBuild=function (universe,volume){this.domElement=document.createElement("audio");this.domElement.sound=this;this.domElement.autoplay=true;this.domElement.onended=this.stopOrRepeat.bind(this,universe);this.domElement.loop=this.isRepeating;this.domElement.volume=volume;var domElementForSoundSource=document.createElement("source");domElementForSoundSource.src=this.sourcePath;this.domElement.appendChild(domElementForSoundSource);return this.domElement;};Sound.prototype.pause=function (universe){var offsetInSeconds=this.domElement.currentTime;this.stop(universe);this.offsetInSeconds=offsetInSeconds;};Sound.prototype.play=function (universe,volume){if(this.isPlaying==false){this.isPlaying=true;this.domElementBuild(universe,volume);this.domElement.currentTime=this.offsetInSeconds;universe.platformHelper.domElementAdd(this.domElement);}};Sound.prototype.reset=function (){this.offsetInSeconds=0;};Sound.prototype.stop=function (universe,event){if(this.isPlaying==true){this.isPlaying=false;var domElement=(event==null?this.domElement:event.srcElement);universe.platformHelper.domElementRemove(domElement);this.offsetInSeconds=0;}};Sound.prototype.stopOrRepeat=function (universe,event){if(this.isRepeating==false){this.stop(universe,event);}};}function SoundHelper(sounds){this.sounds=sounds;this.sounds.addLookups("name");this.musicVolume=1;this.soundVolume=1;this.soundForMusic=null;}{SoundHelper.controlSelectOptionsVolume=function (){var returnValue=[new ControlSelectOption(1,"100%"),new ControlSelectOption(0,"0%"),new ControlSelectOption(.1,"10%"),new ControlSelectOption(.2,"20%"),new ControlSelectOption(.3,"30%"),new ControlSelectOption(.4,"40%"),new ControlSelectOption(.5,"50%"),new ControlSelectOption(.6,"60%"),new ControlSelectOption(.7,"70%"),new ControlSelectOption(.8,"80%"),new ControlSelectOption(.9,"90%"),];return returnValue;};SoundHelper.prototype.reset=function (){for(var i=0;i<this.sounds.length;i++){var sound=this.sounds[i];sound.offsetInSeconds=0;}};SoundHelper.prototype.soundWithNamePlayAsEffect=function (universe,soundName){this.sounds[soundName].play(universe,this.soundVolume);};SoundHelper.prototype.soundWithNamePlayAsMusic=function (universe,soundToPlayName){var soundToPlay=this.sounds[soundToPlayName];var soundAlreadyPlaying=this.soundForMusic;if(soundAlreadyPlaying!=null){if(soundAlreadyPlaying.name!=soundToPlayName){soundAlreadyPlaying.stop(universe);}}soundToPlay.play(universe,this.musicVolume);this.soundForMusic=soundToPlay;};}function TextString(name,sourcePath){this.name=name;this.sourcePath=sourcePath;this.load();}{TextString.fromString=function (name,value){var returnValue=new (name,null);returnValue.value=value;return returnValue;};TextString.prototype.load=function (){var text=this;var xmlHttpRequest=new XMLHttpRequest();xmlHttpRequest.open("GET",this.sourcePath);xmlHttpRequest.onreadystatechange=function (){text.value=xmlHttpRequest.responseText;text.isLoaded=true;};xmlHttpRequest.send();};}function VenueVideo(videoName,venueNext){this.videoName=videoName;this.venueNext=venueNext;this.hasVideoBeenStarted=false;this.inputToActionMappings=[new InputToActionMapping("Escape","VideoSkip",true),new InputToActionMapping("Gamepad0Button0","VideoSkip",true),].addLookups("inputName");}{VenueVideo.prototype.draw=function (){};VenueVideo.prototype.updateForTimerTick=function (universe){if(this.video==null){universe.display.hide(universe);this.video=universe.videoHelper.videos[this.videoName];this.video.play(universe);}if(this.video.isFinished==false){var shouldVideoBeStopped=false;var inputHelper=universe.inputHelper;if(inputHelper.isMouseClicked()==true){inputHelper.isMouseClicked(false);shouldVideoBeStopped=true;}else {var inputsPressed=inputHelper.inputsPressed;for(var i=0;i<inputsPressed.length;i++){var inputPressed=inputsPressed[i];if(inputPressed.isActive==true){var inputToActionMapping=this.inputToActionMappings[inputPressed.name];if(inputToActionMapping!=null){inputPressed.isActive=false;var actionName=inputToActionMapping.actionName;if(actionName=="VideoSkip"){shouldVideoBeStopped=true;}}}}}if(shouldVideoBeStopped==true){this.video.stop(universe);}}if(this.video.isFinished==true){var display=universe.display;display.drawBackground("Black","Black");display.show(universe);universe.venueNext=new VenueFader(this.venueNext,this);}};}function Video(name,sourcePath){this.name=name;this.sourcePath=sourcePath;}{Video.prototype.domElementBuild=function (universe){this.domElement=document.createElement("video");this.domElement.src=this.sourcePath;this.domElement.video=this;this.domElement.autoplay=true;this.domElement.onended=this.stop.bind(this,universe);var displaySize=universe.display.sizeInPixels;this.domElement.width=displaySize.x;this.domElement.height=displaySize.y;return this.domElement;};Video.prototype.play=function (universe){this.isFinished=false;universe.platformHelper.domElementAdd(this.domElementBuild(universe));};Video.prototype.stop=function (universe,event){var domElement=(event==null?this.domElement:event.srcElement);universe.platformHelper.domElementRemove(domElement);this.isFinished=true;};}function VideoHelper(videos){this.videos=videos;this.videos.addLookups("name");}function VisualSound(soundNameToPlay){this.soundNameToPlay=soundNameToPlay;}{VisualSound.prototype.draw=function (universe,world,display,drawable,entity){universe.soundHelper.soundWithNamePlayAsEffect(universe,this.soundNameToPlay);};}function Action(name,perform){this.name=name;this.perform=perform;}{Action.Instances=function (){if(Action._Instances==null){Action._Instances=new Action_Instances();}return Action._Instances;};function Action_Instances(){this.DoNothing=new Action("DoNothing",function (actor){})}}function Actor(activity,target){this.activity=activity;this.target=target;}{Actor.prototype.updateForTimerTick=function (universe,world,place,entity){this.activity(universe,world,place,entity,this.target);}}function Collidable(collider,entityPropertyNamesToCollideWith,collideEntities){this.collider=collider;this.entityPropertyNamesToCollideWith=entityPropertyNamesToCollideWith;this.collideEntities=collideEntities;if(this.entityPropertyNamesToCollideWith==null){this.entityPropertyNamesToCollideWith=[];}this.ticksUntilCanCollide=0;this.entityAlreadyCollidedWith=null;}{Collidable.prototype.updateForTimerTick=function (universe,world,place,entity){if(this.ticksUntilCanCollide>0){this.ticksUntilCanCollide--;}else {for(var p=0;p<this.entityPropertyNamesToCollideWith.length;p++){var entityPropertyName=this.entityPropertyNamesToCollideWith[p];var entitiesWithProperty=place.entitiesByPropertyName(entityPropertyName);if(entitiesWithProperty!=null){for(var e=0;e<entitiesWithProperty.length;e++){var entityOther=entitiesWithProperty[e];if(entityOther!=entity){var collidableOther=entityOther.Collidable;var canCollide=(collidableOther.ticksUntilCanCollide==0);if(canCollide){var colliderThis=entity.Collidable.collider;var colliderOther=collidableOther.collider;var collisionHelper=universe.collisionHelper;var doEntitiesCollide=collisionHelper.doCollidersCollide(colliderThis,colliderOther);if(entityOther==this.entityAlreadyCollidedWith){if(doEntitiesCollide){doEntitiesCollide=false;}else {this.entityAlreadyCollidedWith=null;}}if(doEntitiesCollide){this.collideEntities(universe,world,place,entity,entityOther);}}}}}}}};}function Constrainable(constraints){this.constraints=constraints;}{Constrainable.constrain=function (universe,world,place,entity){var constrainable=entity.Constrainable;var constraints=constrainable.constraints;for(var i=0;i<constraints.length;i++){var constraint=constraints[i];constraint.constrain(universe,world,place,entity);}};Constrainable.prototype.updateForTimerTick=function (universe,world,place,entity){Constrainable.constrain(universe,world,place,entity);};}function Damager(damagePerHit){this.damagePerHit=damagePerHit;}function Defns(constraintDefns){this.constraintDefns=constraintDefns.addLookups("name");}function Device(name,ticksToCharge,use){this.name=name;this.ticksToCharge=ticksToCharge;this.use=use;this.tickLastUsed=0;}{Device.gun=function (){var returnValue=new Device("Gun",10,function use(universe,world,place,actor,device){if(device.ticksSinceUsed(world)<device.ticksToCharge){return ;}device.tickLastUsedUpdate(world);var actorLoc=actor.Locatable.loc;var actorPos=actorLoc.pos;var actorVel=actorLoc.vel;var actorSpeed=actorVel.magnitude();if(actorSpeed==0){return ;}var projectileColor="Cyan";var projectileRadius=3;var projectileVisual=new VisualGroup([new VisualCircle(projectileRadius,projectileColor),new VisualOffset(new VisualText("Projectile",projectileColor),new Coords(0,projectileRadius))]);projectileVisual=new VisualCamera(projectileVisual,place.camera);var actorDirection=actorVel.clone().normalize();var actorRadius=actor.Collidable.collider.radius;var projectilePos=actorPos.clone().add(actorDirection.clone().multiplyScalar(actorRadius).double().double());var projectileLoc=new Location(projectilePos);projectileLoc.vel.overwriteWith(actorVel).double();var projectileCollider=new Sphere(projectilePos,projectileRadius);var projectileCollide=function (universe,world,place,entityPlayer,entityOther){if(entityOther.Killable!=null){place.entitiesToRemove.push(entityOther);}};var projectileEntity=new Entity("Projectile",[new Damager(1),new Ephemeral(32),new Locatable(projectileLoc),new Collidable(projectileCollider,[Killable.name],projectileCollide),new Drawable(projectileVisual)]);place.entitiesToSpawn.push(projectileEntity);});return returnValue;};Device.prototype.tickLastUsedUpdate=function (world){this.tickLastUsed=world.timerTicksSoFar;};Device.prototype.ticksSinceUsed=function (world){return world.timerTicksSoFar-this.tickLastUsed;};Device.prototype.clone=function (){return new Device(this.name,this.ticksToCharge,this.energyToUse,this.use);};}function Drawable(visual){this.visual=visual;}{Drawable.prototype.updateForTimerTick=function (universe,world,place,entity){this.loc=entity.Locatable.loc;this.visual.draw(universe,world,universe.display,this,entity);};}function Entity(name,properties){this.name=name;this.properties=properties;for(var i=0;i<this.properties.length;i++){var property=this.properties[i];var propertyName=property.constructor.name;this[propertyName]=property;}}function Ephemeral(ticksToLive,expire){this.ticksToLive=ticksToLive;this.expire=expire;}{Ephemeral.prototype.updateForTimerTick=function (universe,world,place,entityEphemeral){this.ticksToLive--;if(this.ticksToLive<=0){place.entitiesToRemove.push(entityEphemeral);if(this.expire!=null){this.expire(universe,world,place,entityEphemeral);}}};}function Goal(numberOfKeysToUnlock){this.numberOfKeysToUnlock=numberOfKeysToUnlock;}function Idleable(){}{Idleable.prototype.updateForTimerTick=function (universe,world,place,player){var playerLoc=player.Locatable.loc;playerLoc.orientation.forwardSet(Coords.Instances().Zeroes);};}function Item(defnName,quantity){this.defnName=defnName;this.quantity=quantity;}{Item.prototype.defn=function (world){return world.defns.itemDefns[this.defnName];};Item.prototype.toString=function (){return this.defnName+" ("+this.quantity+")";};}function ItemDefn(name){this.name=name;}function ItemHolder(itemEntities){this.itemEntities=itemEntities||[];for(var i=0;i<this.itemEntities.length;i++){var itemEntity=this.itemEntities[i];this.itemEntityAdd(itemEntity);}}{ItemHolder.prototype.hasItems=function (itemToCheck){var itemEntityExisting=this.itemEntities[itemToCheck.defnName];var itemExistingQuantity=(itemEntityExisting==null?0 :itemEntityExisting.Item.quantity);var returnValue=(itemExistingQuantity>=itemToCheck.quantity);return returnValue;};ItemHolder.prototype.itemEntityAdd=function (itemEntityToAdd){var itemToAdd=itemEntityToAdd.Item;var itemDefnName=itemToAdd.defnName;var itemEntityExisting=this.itemEntities[itemDefnName];if(itemEntityExisting==null){this.itemEntities.push(itemEntityToAdd);this.itemEntities[itemDefnName]=itemEntityToAdd;}else {itemEntityExisting.Item.quantity+=itemToAdd.quantity;}};ItemHolder.prototype.itemRemove=function (itemToRemove){var itemDefnName=itemToRemove.defnName;var itemEntityExisting=this.itemEntities[itemDefnName];if(itemEntityExisting!=null){this.itemEntities.remove(itemEntityExisting);delete this.itemEntities[itemDefnName];}};ItemHolder.prototype.itemSubtract=function (itemToSubtract){var itemDefnName=itemToSubtract.defnName;var itemEntityExisting=this.itemEntities[itemDefnName];if(itemEntityExisting!=null){var itemExisting=itemEntityExisting.Item;itemExisting.quantity-=itemToSubtract.quantity;if(itemExisting.quantity<=0){this.itemEntities.remove(itemEntityExisting);delete this.itemEntities[itemDefnName];}}};ItemHolder.prototype.itemsTransferTo=function (other){for(var i=0;i<this.itemEntities.length;i++){var itemEntity=this.itemEntities[i];other.itemEntityAdd(itemEntity);this.itemRemove(itemEntity.Item);}};}function Killable(integrity,die){this.integrity=integrity;this.die=die;}{Killable.prototype.updateForTimerTick=function (universe,world,place,entityKillable){if(this.integrity<=0){place.entitiesToRemove.push(entityKillable);if(this.die!=null){this.die(universe,world,place,entityKillable);}}};}function Locatable(loc){this.loc=loc;}{Locatable.prototype.updateForTimerTick=function (universe,world,place,entity){var loc=this.loc;loc.vel.add(loc.accel);loc.accel.clear();loc.pos.add(loc.vel);var spin=loc.spin;if(spin.angleInTurns()!=0){loc.spin.transformOrientation(loc.orientation);}};}function Modellable(model){this.model=model;}{Modellable.prototype.updateForTimerTick=function (universe,world,place,entity){};}function Place(entities){this.entities=[];this._entitiesByPropertyName={};this.entitiesToSpawn=entities.slice();this.entitiesToRemove=[];this.propertyNamesToProcess=[Locatable.name,Constrainable.name,Collidable.name,Idleable.name,Actor.name,Playable.name,Ephemeral.name,Killable.name,];}{Place.prototype.draw=function (universe,world){var entitiesDrawable=this.entitiesByPropertyName(Drawable.name);for(var i=0;i<entitiesDrawable.length;i++){var entity=entitiesDrawable[i];var drawable=entity.Drawable;drawable.updateForTimerTick(universe,world,this,entity);}};Place.prototype.entitiesByPropertyName=function (propertyName){var returnValues=this._entitiesByPropertyName[propertyName];if(returnValues==null){returnValues=[];this._entitiesByPropertyName[propertyName]=returnValues;}return returnValues;};Place.prototype.entitiesRemove=function (){for(var i=0;i<this.entitiesToRemove.length;i++){var entity=this.entitiesToRemove[i];this.entityRemove(entity);}this.entitiesToRemove.clear();};Place.prototype.entitiesSpawn=function (universe,world){for(var i=0;i<this.entitiesToSpawn.length;i++){var entity=this.entitiesToSpawn[i];this.entitySpawn(universe,world,entity);}this.entitiesToSpawn.clear();};Place.prototype.entityRemove=function (entity){var entityProperties=entity.properties;for(var p=0;p<entityProperties.length;p++){var property=entityProperties[p];var propertyName=property.constructor.name;var entitiesWithProperty=this.entitiesByPropertyName(propertyName);entitiesWithProperty.remove(entity);}this.entities.remove(entity);delete this.entities[entity.name];};Place.prototype.entitySpawn=function (universe,world,entity){this.entities.push(entity);this.entities[entity.name]=entity;var entityProperties=entity.properties;for(var p=0;p<entityProperties.length;p++){var property=entityProperties[p];var propertyName=property.constructor.name;var entitiesWithProperty=this.entitiesByPropertyName(propertyName);entitiesWithProperty.push(entity);if(property.initialize!=null){property.initialize(universe,world,this,entity);}}};Place.prototype.finalize=function (universe,world){universe.inputHelper.inputsRemoveAll();};Place.prototype.initialize=function (universe,world){};Place.prototype.updateForTimerTick=function (universe,world){this.entitiesRemove();this.entitiesSpawn(universe,world);for(var p=0;p<this.propertyNamesToProcess.length;p++){var propertyName=this.propertyNamesToProcess[p];var entitiesWithProperty=this.entitiesByPropertyName(propertyName);if(entitiesWithProperty!=null){for(var i=0;i<entitiesWithProperty.length;i++){var entity=entitiesWithProperty[i];var entityProperty=entity[propertyName];entityProperty.updateForTimerTick(universe,world,this,entity);}}}};}function PlaceDemo(size,numberOfKeysToUnlockGoal){this.size=size;var cameraViewSize=this.size.clone().half();var cameraFocalLength=cameraViewSize.x;this.camera=new Camera(cameraViewSize,cameraFocalLength,new Location(new Coords(0,0,-cameraFocalLength),Orientation.Instances().ForwardZDownY.clone()));var coordsInstances=Coords.Instances();this.actions=[Action.Instances().DoNothing,new Action("ShowMenu",function perform(universe,world,place,actor){var venueNext=new VenueControls(universe.controlBuilder.configure(universe));venueNext=new VenueFader(venueNext,universe.venueCurrent);universe.venueNext=venueNext;}),new Action("MoveDown",function perform(universe,world,place,actor){place.entityAccelerateInDirection(world,actor,coordsInstances.ZeroOneZero);}),new Action("MoveLeft",function perform(universe,world,place,actor){place.entityAccelerateInDirection(world,actor,coordsInstances.MinusOneZeroZero);}),new Action("MoveRight",function perform(universe,world,place,actor){place.entityAccelerateInDirection(world,actor,coordsInstances.OneZeroZero);}),new Action("MoveUp",function perform(universe,world,place,actor){place.entityAccelerateInDirection(world,actor,coordsInstances.ZeroMinusOneZero);}),new Action("Fire",function perform(universe,world,place,actor){var itemWeapon=new Item("Weapon",1);var itemHolder=actor.ItemHolder;var actorHasWeapon=itemHolder.hasItems(itemWeapon);if(actorHasWeapon){var entityWeapon=itemHolder.itemEntities["Weapon"];var deviceWeapon=entityWeapon.Device;deviceWeapon.use(universe,world,place,actor,deviceWeapon);}}),].addLookups("name");this.inputToActionMappings=[new InputToActionMapping("Escape","ShowMenu"),new InputToActionMapping("ArrowDown","MoveDown"),new InputToActionMapping("ArrowLeft","MoveLeft"),new InputToActionMapping("ArrowRight","MoveRight"),new InputToActionMapping("ArrowUp","MoveUp"),new InputToActionMapping("Enter","Fire"),new InputToActionMapping("Gamepad0Down","MoveDown"),new InputToActionMapping("Gamepad0Left","MoveLeft"),new InputToActionMapping("Gamepad0Right","MoveRight"),new InputToActionMapping("Gamepad0Up","MoveUp"),new InputToActionMapping("Gamepad0Button0","Fire"),].addLookups("inputName");var entityDimension=10;var entityDimensionHalf=entityDimension/2;var entitySize=new Coords(1,1,1).multiplyScalar(entityDimension);var entities=[];var visualBackgroundDimension=100;var visualBackgroundCellSize=new Coords(.5,.5,.01).multiplyScalar(visualBackgroundDimension);var visualBackgroundBottom=new VisualRepeating(visualBackgroundCellSize,this.camera.viewSize.clone(),new VisualRectangle(visualBackgroundCellSize,null,"rgba(255, 255, 255, 0.02)"));var entityBackgroundBottom=new Entity("BackgroundBottom",[new Locatable(new Location(new Coords(0,0,cameraFocalLength))),new Drawable(visualBackgroundBottom)]);entities.push(entityBackgroundBottom);visualBackgroundCellSize=new Coords(1,1,.01).multiplyScalar(visualBackgroundDimension);var visualBackgroundTop=new VisualRepeating(visualBackgroundCellSize,this.camera.viewSize.clone(),new VisualRectangle(visualBackgroundCellSize,null,"rgba(255, 255, 255, 0.06)"));var entityBackgroundTop=new Entity("BackgroundTop",[new Locatable(new Location(new Coords(0,0,0))),new Drawable(visualBackgroundTop)]);entities.push(entityBackgroundTop);var playerPos=new Coords(30,30);var playerLoc=new Location(playerPos);var playerCollider=new Sphere(playerLoc.pos,entityDimensionHalf);var playerColor="Gray";var playerVisualBody=new VisualCircle(entityDimensionHalf,playerColor);var playerVisualDirectionalIndicator=new VisualDirectional(new VisualNone(),[new VisualRay(entityDimension*1.25,playerColor)]);var visualRectangleSmall=new VisualRectangle(entitySize.clone().divideScalar(4),playerColor);var playerVisualMovementIndicator=new VisualDirectional(new VisualNone(),[new VisualAnimation("MoveRight",5,[new VisualOffset(visualRectangleSmall,new Coords(1,0).multiplyScalar(entityDimension)),new VisualOffset(visualRectangleSmall,new Coords(1.5,0).multiplyScalar(entityDimension)),new VisualOffset(visualRectangleSmall,new Coords(2,0).multiplyScalar(entityDimension)),]),new VisualAnimation("MoveDown",5,[new VisualOffset(visualRectangleSmall,new Coords(0,1).multiplyScalar(entityDimension)),new VisualOffset(visualRectangleSmall,new Coords(0,1.5).multiplyScalar(entityDimension)),new VisualOffset(visualRectangleSmall,new Coords(0,2).multiplyScalar(entityDimension)),]),new VisualAnimation("MoveLeft",5,[new VisualOffset(visualRectangleSmall,new Coords(-1,0).multiplyScalar(entityDimension)),new VisualOffset(visualRectangleSmall,new Coords(-1.5,0).multiplyScalar(entityDimension)),new VisualOffset(visualRectangleSmall,new Coords(-2,0).multiplyScalar(entityDimension)),]),new VisualAnimation("MoveUp",5,[new VisualOffset(visualRectangleSmall,new Coords(0,-1).multiplyScalar(entityDimension)),new VisualOffset(visualRectangleSmall,new Coords(0,-1.5).multiplyScalar(entityDimension)),new VisualOffset(visualRectangleSmall,new Coords(0,-2).multiplyScalar(entityDimension)),]),]);var playerVisualName=new VisualOffset(new VisualText("Player",playerColor),new Coords(0,entityDimension));var playerVisual=new VisualGroup([playerVisualDirectionalIndicator,playerVisualBody,playerVisualName,playerVisualMovementIndicator,]);var playerCollide=function (universe,world,place,entityPlayer,entityOther){var messageToDisplay=null;if(entityOther.Damager!=null){universe.collisionHelper.collideCollidables(entityPlayer,entityOther);var playerAsKillable=entityPlayer.Killable;playerAsKillable.integrity-=entityOther.Damager.damagePerHit;}else if(entityOther.Goal!=null){var keysRequired=new Item("Key",entityOther.Goal.numberOfKeysToUnlock);if(entityPlayer.ItemHolder.hasItems(keysRequired)){var venueMessage=new VenueMessage("You win!",new VenueControls(universe.controlBuilder.title(universe)),universe.venueCurrent,universe.display.sizeDefault.clone().half());universe.venueNext=venueMessage;}}else if(entityOther.Item!=null){entityPlayer.ItemHolder.itemEntityAdd(entityOther);place.entitiesToRemove.push(entityOther);}else if(entityOther.Talker!=null){entityOther.Collidable.ticksUntilCanCollide=100;entityOther.Drawable.animationRuns["Friendly"].ticksSinceStarted=0;var conversationDefnAsJSON=universe.mediaLibrary.textStringGetByName("Conversation").value;var conversationDefn=ConversationDefn.deserialize(conversationDefnAsJSON);var venueToReturnTo=universe.venueCurrent;var conversation=new ConversationRun(conversationDefn,function quit(conversationRun){universe.venueNext=venueToReturnTo;});var conversationSize=universe.display.sizeDefault.clone();var conversationAsControl=conversation.toControl(conversationSize,universe);var venueNext=new VenueControls(conversationAsControl);universe.venueNext=venueNext;}};var constraintSpeedMax5=new Constraint("SpeedMax",5);var constraintFriction=new Constraint("Friction",.03);var playerEntity=new Entity("Player",[new Locatable(playerLoc),new Constrainable([constraintFriction,constraintSpeedMax5]),new Collidable(playerCollider,[Collidable.name],playerCollide),new Drawable(playerVisual),new ItemHolder(),new Playable(),new Idleable(),new Killable(5,function die(universe,world,place,entityKillable){var venueMessage=new VenueMessage("You lose!",new VenueControls(universe.controlBuilder.title(universe)),universe.venueCurrent,universe.display.sizeDefault.clone().half());universe.venueNext=venueMessage;})]);entities.push(playerEntity);var friendlyColor="Green";var friendlyPos=new Coords().randomize().multiply(this.size);var friendlyLoc=new Location(friendlyPos);var friendlyCollider=new Sphere(friendlyLoc.pos,entityDimensionHalf);var friendlyVisualNormal=new VisualEllipse(entityDimensionHalf,entityDimensionHalf*.8,.125,friendlyColor,null);var friendlyVisual=new VisualGroup([new VisualAnimation("Friendly",100,[new VisualAnimation("Blinking",3,[new VisualNone(),friendlyVisualNormal]),friendlyVisualNormal],false),new VisualOffset(new VisualText("Talker",friendlyColor),new Coords(0,entityDimension))]);var constraintSpeedMax1=new Constraint("SpeedMax",1);var friendlyEntity=new Entity("Friendly",[new Locatable(friendlyLoc),new Constrainable([constraintSpeedMax1]),new Collidable(friendlyCollider),new Drawable(friendlyVisual),new Talker("AnEveningWithProfessorSurly"),new Actor(function activity(universe,world,place,entityActor,target){var actor=entityActor.Actor;var targetPos=actor.target;if(targetPos==null){targetPos=new Coords().randomize().multiply(place.size);actor.target=targetPos;}var actorLoc=entityActor.Locatable.loc;var actorPos=actorLoc.pos;var distanceToTarget=targetPos.clone().subtract(actorPos).magnitude();if(distanceToTarget>=2){actorLoc.vel.overwriteWith(targetPos).subtract(actorPos).normalize();}else {actorPos.overwriteWith(targetPos);actor.target=null;}}),]);entities.push(friendlyEntity);var damagerColor="Red";var enemyColor=damagerColor;var enemyPos=this.size.clone().subtract(playerLoc.pos);var enemyLoc=new Location(enemyPos);var enemyColliderAsFace=new Face([new Coords(0,-entityDimension).half(),new Coords(entityDimension,entityDimension).half(),new Coords(-entityDimension,entityDimension).half(),]);var enemyCollider=Mesh.fromFace(enemyPos,enemyColliderAsFace,1 );var enemyVisual=new VisualGroup([new VisualPolygon(new Path(enemyColliderAsFace.vertices),enemyColor,null),new VisualOffset(new VisualText("Chaser",enemyColor),new Coords(0,entityDimension))]);var enemyEntity=new Entity("Enemy",[new Locatable(enemyLoc),new Constrainable([constraintSpeedMax1]),new Collidable(enemyCollider),new Damager(1),new Killable(1),new Drawable(enemyVisual),new Actor(function activity(universe,world,place,actor,entityToTargetName){var target=place.entities[entityToTargetName];var actorLoc=actor.Locatable.loc;actorLoc.accel.overwriteWith(target.Locatable.loc.pos).subtract(actorLoc.pos).normalize().multiplyScalar(.1);},"Player"),]);entities.push(enemyEntity);var obstacleColor=damagerColor;var numberOfWalls=4;var wallThickness=5;for(var i=0;i<numberOfWalls;i++){var obstacleWallSize;if(i%2 ==0){obstacleWallSize=new Coords(size.x,wallThickness,1);}else {obstacleWallSize=new Coords(wallThickness,size.y,1);}var obstacleWallPos=obstacleWallSize.clone().half().clearZ();if(i>=2){obstacleWallPos.invert().add(size);}var obstacleWallLoc=new Location(obstacleWallPos);var obstacleCollider=new Bounds(obstacleWallPos,obstacleWallSize);var obstacleWallVisual=new VisualRectangle(obstacleWallSize,obstacleColor);var obstacleWallEntity=new Entity("ObstacleWall"+i,[new Locatable(obstacleWallLoc),new Collidable(obstacleCollider),new Damager(1),new Drawable(obstacleWallVisual)]);entities.push(obstacleWallEntity);}var obstacleMappedCellSource=["....xxxx....",".....xx.....",".....xx....","....xxxx....","x..xx..xx..x","xxxx.xx.xxxx","xxxx.xx.xxxx","x..xx..xx..x","....xxxx....",".....xx.....",".....xx.....","....xxxx....",];var obstacleMappedSizeInCells=new Coords(obstacleMappedCellSource[0].length,obstacleMappedCellSource.length,1
);var obstacleMappedCellSize=new Coords(2,2,1);var obstacleMappedMap=new Map(obstacleMappedSizeInCells,obstacleMappedCellSize,new MapCell(),function cellAtPosInCells(map,cellPosInCells,cellToOverwrite){var cellCode=map.cellSource[cellPosInCells.y][cellPosInCells.x];var cellVisualName=(cellCode=="x"?"Blocking":"Open");var cellIsBlocking=(cellCode=="x");cellToOverwrite.visualName=cellVisualName;cellToOverwrite.isBlocking=cellIsBlocking;return cellToOverwrite;},obstacleMappedCellSource);var obstacleMappedVisualLookup={"Blocking":new VisualRectangle(obstacleMappedCellSize,obstacleColor),"Open":new VisualNone()};var obstacleMappedVisual=new VisualGroup([new VisualMap(obstacleMappedMap,obstacleMappedVisualLookup),new VisualOffset(new VisualText("Mine",obstacleColor),new Coords(0,entityDimension))]);var marginThickness=wallThickness*4;var marginSize=new Coords(1,1,0).multiplyScalar(marginThickness);var sizeMinusMargins=this.size.clone().subtract(marginSize).subtract(marginSize);var numberOfMines=48;var entitiesObstacles=[];for(var i=0;i<numberOfMines;i++){var obstacleMappedPos=new Coords().randomize().multiply(sizeMinusMargins).add(marginSize);var obstacleMappedLoc=new Location(obstacleMappedPos);var obstacleMappedEntity=new Entity("ObstacleMapped",[new Locatable(obstacleMappedLoc),new Collidable(new MapLocated(obstacleMappedMap,obstacleMappedLoc)),new Damager(1),new Drawable(obstacleMappedVisual)]);entitiesObstacles.push(obstacleMappedEntity);entities.push(obstacleMappedEntity);}var obstacleBarSize=new Coords(6,2).multiplyScalar(entityDimension);var obstaclePos=playerPos.clone().add(obstacleBarSize).add(obstacleBarSize);var obstacleLoc=new Location(obstaclePos);var obstacleCollider=new Bounds(obstaclePos,obstacleBarSize);var obstacleBarEntity=new Entity("ObstacleBar",[new Locatable(obstacleLoc),new Collidable(obstacleCollider),new Damager(1),new Drawable(new VisualGroup([new VisualRectangle(obstacleCollider.size,obstacleColor,obstacleColor),new VisualOffset(new VisualText("Bar",obstacleColor),new Coords(0,obstacleCollider.size.y))]))]);entities.push(obstacleBarEntity);var itemKeyColor="Yellow";var itemKeyVisual=new VisualGroup([new VisualCircle(entityDimensionHalf,itemKeyColor),new VisualOffset(new VisualText("Key",itemKeyColor),new Coords(0,entityDimension))]);var obstacleExclusionRadius=32;var displacement=new Coords();for(var i=0;i<numberOfKeysToUnlockGoal;i++){var itemKeyPos=new Coords().randomize().multiply(sizeMinusMargins).add(marginSize);for(var j=0;j<entitiesObstacles.length;j++){var obstaclePos=entitiesObstacles[j].Locatable.loc.pos;var distanceFromObstacle=displacement.overwriteWith(obstaclePos).magnitude();if(distanceFromObstacle<obstacleExclusionRadius){displacement.normalize().multiplyScalar(obstacleExclusionRadius);obstaclePos.add(displacement);}}var itemKeyCollider=new Sphere(itemKeyPos,entityDimensionHalf);var itemKeyEntity=new Entity("Key"+i,[new Item("Key",1),new Locatable(new Location(itemKeyPos)),new Collidable(itemKeyCollider),new Drawable(itemKeyVisual)]);entities.push(itemKeyEntity);}var itemWeaponColor="Cyan";var itemWeaponVisual=new VisualGroup([new VisualCircle(entityDimensionHalf,itemWeaponColor),new VisualOffset(new VisualText("Weapon",itemWeaponColor),new Coords(0,entityDimension))]);var itemWeaponPos=playerPos.clone().double();var itemWeaponCollider=new Sphere(itemWeaponPos,entityDimensionHalf);var itemWeaponDevice=Device.gun();var itemWeaponEntity=new Entity("Weapon",[new Item("Weapon",1),new Locatable(new Location(itemWeaponPos)),new Collidable(itemWeaponCollider),new Drawable(itemWeaponVisual),itemWeaponDevice]);entities.push(itemWeaponEntity);var goalPos=new Coords().randomize().multiplyScalar(.5
).addDimensions(.25,.25,0
).multiply(this.size);var goalLoc=new Location(goalPos);var goalColor="Green";var goalEntity=new Entity("Goal",[new Locatable(goalLoc),new Collidable(new Bounds(goalPos,entitySize)),new Drawable(new VisualGroup([new VisualRectangle(entitySize,goalColor),new VisualText(""+numberOfKeysToUnlockGoal,itemKeyColor),new VisualOffset(new VisualText("Exit",goalColor),new Coords(0,entityDimension))])),new Goal(numberOfKeysToUnlockGoal),]);entities.push(goalEntity);var obstaclePos=goalEntity.Locatable.loc.pos;var obstacleLoc=new Location(obstaclePos);obstacleLoc.spin.angleInTurnsRef.value=0.002;var obstacleCollider=new Arc(new Shell(new Sphere(obstaclePos,entityDimension*3),entityDimension*2 ),new Wedge(obstaclePos,obstacleLoc.orientation.forward,.85 ));var obstacleRingEntity=new Entity("ObstacleRing",[new Locatable(obstacleLoc),new Collidable(obstacleCollider),new Damager(1),new Drawable(new VisualArc(obstacleCollider,obstacleColor,obstacleColor))]);entities.push(obstacleRingEntity);for(var i=0;i<entities.length;i++){var entity=entities[i];var entityDrawable=entity.Drawable;if(entityDrawable!=null){var entityVisual=entityDrawable.visual;entityDrawable.visual=new VisualCamera(entityVisual,this.camera);}}var controlStatus=new ControlLabel("labelHealth",new Coords(8,5),new Coords(100,0),false,new DataBinding(playerEntity.Killable,"integrity"),10,);this.venueControls=new VenueControls(controlStatus);Place.call(this,entities);this.drawPos=new Coords();this.drawLoc=new Location(this.drawPos);}{PlaceDemo.prototype=Object.create(Place.prototype);PlaceDemo.prototype.constructor=PlaceDemo;PlaceDemo.prototype.draw_FromSuperclass=Place.prototype.draw;PlaceDemo.prototype.draw=function (universe,world){var display=universe.display;display.drawBackground("Gray","Black");var drawLoc=this.drawLoc;var drawPos=drawLoc.pos;var player=this.entities["Player"];var playerLoc=player.Locatable.loc;var camera=this.camera;camera.loc.pos.overwriteWith(playerLoc.pos).trimToRangeMinMax(camera.viewSizeHalf,this.size.clone().subtract(camera.viewSizeHalf)).subtract(new Coords(0,0,camera.focalLength));this.draw_FromSuperclass(universe,world);this.venueControls.draw(universe);};PlaceDemo.prototype.entityAccelerateInDirection=function (world,entity,directionToMove){var entityLoc=entity.Locatable.loc;entityLoc.orientation.forwardSet(directionToMove);var vel=entityLoc.vel;if(vel.equals(directionToMove)==false){entityLoc.timeOffsetInTicks=world.timerTicksSoFar;}entityLoc.accel.overwriteWith(directionToMove).multiplyScalar(.5 );};}function Playable(player){this.player=player;}{Playable.prototype.updateForTimerTick=function (universe,world,place,entityPlayer){var size=place.size;var inputToActionMappings=place.inputToActionMappings;var actions=place.actions;var camera=place.camera;var playerLoc=entityPlayer.Locatable.loc;var inputHelper=universe.inputHelper;if(inputHelper.isMouseClicked()==true){inputHelper.isMouseClicked(false);playerLoc.pos.overwriteWith(inputHelper.mouseClickPos).divide(universe.display.scaleFactor).add(camera.loc.pos).subtract(camera.viewSizeHalf).trimToRangeMax(size);universe.soundHelper.soundWithNamePlayAsEffect(universe,"Sound");}var inputsPressed=inputHelper.inputsPressed;for(var i=0;i<inputsPressed.length;i++){var inputPressed=inputsPressed[i];if(inputPressed.isActive==true){var mapping=inputToActionMappings[inputPressed.name];if(mapping!=null){var actionName=mapping.actionName;var action=actions[actionName];action.perform(universe,world,place,entityPlayer);if(mapping.inactivateInputWhenActionPerformed==true){inputPressed.isActive=false;}}}}};}function Talker(conversationDefnName){this.conversationDefnName=conversationDefnName;}function Universe(name,timerHelper,display,mediaLibrary,world){this.name=name;this.timerHelper=timerHelper;this.display=display;this.mediaLibrary=mediaLibrary;this.world=world;this.venueNext=null;}{Universe.new =function (name,timerHelper,display,mediaLibrary,world){var returnValue=new Universe(name,timerHelper,display,mediaLibrary,world,[]);var debuggingMode=URLParser.fromWindow().queryStringParameters["debug"];returnValue.debuggingMode=debuggingMode;return returnValue;};Universe.prototype.initialize=function (){this.collisionHelper=new CollisionHelper();this.platformHelper=new PlatformHelper();this.platformHelper.initialize(this);this.serializer=new Serializer();this.storageHelper=new StorageHelper(this.name+"_",this.serializer);this.profileHelper=new ProfileHelper(this.storageHelper);this.display.initialize(this);this.soundHelper=new SoundHelper(this.mediaLibrary.sounds);this.videoHelper=new VideoHelper(this.mediaLibrary.videos);this.controlBuilder=new ControlBuilder([ControlStyle.Instances().Default]);var venueControlsTitle=new VenueControls(this.controlBuilder.title(this,this.display.sizeInPixels));venueControlsTitle=new VenueFader(venueControlsTitle,venueControlsTitle);this.venueNext=venueControlsTitle;this.inputHelper=new InputHelper();this.inputHelper.initialize(this);this.timerHelper.initialize(this.updateForTimerTick.bind(this));};Universe.prototype.reset=function (){this.soundHelper.reset();};Universe.prototype.updateForTimerTick=function (){this.inputHelper.updateForTimerTick(this);if(this.venueNext!=null){if(this.venueCurrent!=null&&this.venueCurrent.finalize!=null){this.venueCurrent.finalize(this);}this.venueCurrent=this.venueNext;this.venueNext=null;if(this.venueCurrent.initialize!=null){this.venueCurrent.initialize(this);}}this.venueCurrent.updateForTimerTick(this);};}function VenueWorld(world){this.name="World";this.world=world;}{VenueWorld.prototype.draw=function (universe){this.world.draw(universe);};VenueWorld.prototype.finalize=function (universe){universe.soundHelper.soundForMusic.pause(universe);};VenueWorld.prototype.initialize=function (universe){universe.world=this.world;this.world.initialize(universe);var soundHelper=universe.soundHelper;soundHelper.soundWithNamePlayAsMusic(universe,"Music");};VenueWorld.prototype.updateForTimerTick=function (universe){this.world.updateForTimerTick(universe);this.draw(universe);};}function World(name,dateCreated,defns,place){this.name=name;this.dateCreated=dateCreated;this.timerTicksSoFar=0;this.defns=defns;this.place=place;}{World.new =function (universe){var now=DateTime.now();var nowAsString=now.toStringMMDD_HHMM_SS();var place=new PlaceDemo(universe.display.sizeInPixels.clone().double(),5 );place.entitiesSpawn(universe,null);var constraintDefns=[ConstraintDefn.Instances().Friction,ConstraintDefn.Instances().SpeedMax,];var defns=new Defns(constraintDefns);var returnValue=new World("World-"+nowAsString,now,defns,place);return returnValue;};World.prototype.draw=function (universe){this.place.draw(universe,this);};World.prototype.initialize=function (universe){this.place.initialize(universe,this);};World.prototype.updateForTimerTick=function (universe){this.place.updateForTimerTick(universe,this);this.timerTicksSoFar++;};}function Profile(name,worlds){this.name=name;this.worlds=worlds;}function ProfileHelper(storageHelper){this.storageHelper=storageHelper;this.propertyName="Profiles";}{ProfileHelper.prototype.profileAdd=function (profile){var profiles=this.profiles();profiles.push(profile);this.storageHelper.save(this.propertyName,profiles);};ProfileHelper.prototype.profileDelete=function (profileToDelete){var profiles=this.profiles();var profileIndex=this.profileIndexFindByName(profiles,profileToDelete.name);profiles.removeAt(profileIndex);this.storageHelper.save(this.propertyName,profiles);};ProfileHelper.prototype.profileIndexFindByName=function (profiles,profileNameToFind){var returnValue=null;for(var i=0;i<profiles.length;i++){var profile=profiles[i];if(profile.name==profileNameToFind){returnValue=i;break;}}return returnValue;};ProfileHelper.prototype.profileSave=function (profileToSave){var profiles=this.profiles();var profileIndex=this.profileIndexFindByName(profiles,profileToSave.name);if(profileIndex==null){profiles.push(profileToSave);}else {profiles.removeAt(profileIndex).insertElementAt(profileToSave,profileIndex);}try{this.storageHelper.save(this.propertyName,profiles);}catch (err){var errorMessage="Error attempting to save: "+err;alert(errorMessage);}};ProfileHelper.prototype.profiles=function (){var profiles=this.storageHelper.load(this.propertyName);if(profiles==null){profiles=[];this.storageHelper.save(this.propertyName,profiles);}return profiles;};ProfileHelper.prototype.profilesAllDelete=function (profileToDelete){this.storageHelper.save(this.propertyName,"");};}function FileHelper(){}{FileHelper.prototype.loadFileAsBinaryString=function (systemFileToLoad,callback,contextForCallback){var fileReader=new FileReader();fileReader.systemFile=systemFileToLoad;fileReader.callback=callback;fileReader.contextForCallback=contextForCallback;fileReader.onload=this.loadFile_FileLoaded.bind(this);fileReader.readAsBinaryString(systemFileToLoad);};FileHelper.prototype.loadFileAsText=function (systemFileToLoad,callback,contextForCallback){var fileReader=new FileReader();fileReader.systemFile=systemFileToLoad;fileReader.callback=callback;fileReader.contextForCallback=contextForCallback;fileReader.onload=this.loadFile_FileLoaded.bind(this);fileReader.readAsText(systemFileToLoad);};FileHelper.prototype.loadFile_FileLoaded=function (fileLoadedEvent){var fileReader=fileLoadedEvent.target;var contentsOfFileLoaded=fileReader.result;var fileName=fileReader.systemFile.name;var callback=fileReader.callback;var contextForCallback=fileReader.contextForCallback;callback.call(contextForCallback,contentsOfFileLoaded);};FileHelper.prototype.saveBinaryStringToFileWithName=function (fileAsBinaryString,fileName){var fileAsArrayBuffer=new ArrayBuffer(fileAsBinaryString.length);var fileAsArrayUnsigned=new Uint8Array(fileAsArrayBuffer);for(var i=0;i<fileAsBinaryString.length;i++){fileAsArrayUnsigned[i]=fileAsBinaryString.charCodeAt(i);}var fileAsBlob=new Blob([fileAsArrayBuffer],{type:'unknown/unknown'});var link=document.createElement("a");link.href=window.URL.createObjectURL(fileAsBlob);link.download=fileName;link.click();};FileHelper.prototype.saveTextStringToFileWithName=function (textToSave,fileNameToSaveAs){var textToSaveAsBlob=new Blob([textToSave],{type:"text/plain"});var link=document.createElement("a");link.href=window.URL.createObjectURL(textToSaveAsBlob);link.download=fileNameToSaveAs;link.click();};}function Serializer(){}{Serializer.prototype.deserialize=function (stringToDeserialize){var nodeRoot=JSON.parse(stringToDeserialize);nodeRoot.__proto__=SerializerNode.prototype;nodeRoot.prototypesAssign();var returnValue=nodeRoot.unwrap([]);return returnValue;};Serializer.prototype.serialize=function (objectToSerialize,prettyPrint){var nodeRoot=new SerializerNode(objectToSerialize);nodeRoot.wrap([],[]);var nodeRootSerialized=JSON.stringify(nodeRoot,null,(prettyPrint==true?4 :null));return nodeRootSerialized;};}function SerializerNode(objectWrapped){this.t=null;this.id=null;this.r=null;this.o=objectWrapped;}{SerializerNode.prototype.wrap=function (objectsAlreadyWrapped,objectIndexToNodeLookup){var objectWrapped=this.o;if(objectWrapped!=null){var typeName=objectWrapped.constructor.name;var objectIndexExisting=objectsAlreadyWrapped.indexOf (objectWrapped);if(objectIndexExisting>=0){var nodeForObjectExisting=objectIndexToNodeLookup[objectIndexExisting];this.id=nodeForObjectExisting.id;this.r=true;this.o=null;}else {this.r=false;var objectIndex=objectsAlreadyWrapped.length;this.id=objectIndex;objectsAlreadyWrapped.push(objectWrapped);objectIndexToNodeLookup[objectIndex]=this;this.t=typeName;if(typeName=="Function"){this.o=objectWrapped.toString();}else {var children={};this.c=children;for(var propertyName in objectWrapped){if(objectWrapped.__proto__[propertyName]==null){var propertyValue=objectWrapped[propertyName];if(propertyValue==null){child=null;}else {var propertyValueTypeName=propertyValue.constructor.name;if(propertyValueTypeName=="Boolean"||propertyValueTypeName=="Number"||propertyValueTypeName=="String"){child=propertyValue;}else {child=new SerializerNode(propertyValue);}}children[propertyName]=child;}}delete this.o;for(var childName in children){var child=children[childName];if(child!=null){var childTypeName=child.constructor.name;if(childTypeName=="SerializerNode"){child.wrap(objectsAlreadyWrapped,objectIndexToNodeLookup);}}}}}}return this;};SerializerNode.prototype.prototypesAssign=function (){var children=this.c;if(children!=null){for(var childName in children){var child=children[childName];if(child!=null){var childTypeName=child.constructor.name;if(childTypeName=="Object"){child.__proto__=SerializerNode.prototype;child.prototypesAssign();}}}}};SerializerNode.prototype.unwrap=function (nodesAlreadyProcessed){var isReference=this.r;if(isReference==true){var nodeExisting=nodesAlreadyProcessed[this.id];this.o=nodeExisting.o;}else {nodesAlreadyProcessed[this.id]=this;var typeName=this.t;if(typeName==null){}else if(typeName=="Array"){this.o=[];}else if(typeName=="Function"){this.o=eval("("+this.o+")");}else if(typeName=="Boolean"||typeName=="Number"||typeName=="String"){}else {this.o={};var objectWrappedType=eval("("+typeName+")");this.o.__proto__=objectWrappedType.prototype;}var children=this.c;if(children!=null){for(var childName in children){var child=children[childName];if(child!=null){if(child.constructor.name=="SerializerNode"){child=child.unwrap(nodesAlreadyProcessed);}}this.o[childName]=child;}}}return this.o;};}function StorageHelper(propertyNamePrefix,serializer){this.propertyNamePrefix=propertyNamePrefix;if(this.propertyNamePrefix==null){this.propertyNamePrefix="";}this.serializer=serializer;}{StorageHelper.prototype.load=function (propertyName){var returnValue;var propertyNamePrefixed=this.propertyNamePrefix+propertyName;var returnValueAsString=localStorage.getItem(propertyNamePrefixed);if(returnValueAsString==null){returnValue=null;}else {returnValue=this.serializer.deserialize(returnValueAsString);}return returnValue;};StorageHelper.prototype.save=function (propertyName,valueToSave){var valueToSaveSerialized=this.serializer.serialize(valueToSave);var propertyNamePrefixed=this.propertyNamePrefix+propertyName;localStorage.setItem(propertyNamePrefixed,valueToSaveSerialized);};}function VenueFileUpload(venueNextIfFileSpecified,venueNextIfCancelled){this.venueNextIfFileSpecified=venueNextIfFileSpecified;this.venueNextIfCancelled=venueNextIfCancelled;this.inputToActionMappings=[new InputToActionMapping("Escape","ControlCancel",true),new InputToActionMapping("Gamepad0Button0","ControlCancel",true),].addLookups("inputName");}{VenueFileUpload.prototype.finalize=function (universe){universe.platformHelper.domElementRemove(this.domElement);var display=universe.display;display.drawBackground("Black","Black");display.show(universe);};VenueFileUpload.prototype.initialize=function (universe){var display=universe.display;display.hide(universe);var divFileUpload=document.createElement("div");divFileUpload.style="border:1px solid;width:"+display.sizeInPixels.x+";height:"+display.sizeInPixels.y;var labelInstructions=document.createElement("label");labelInstructions.innerHTML="Choose a file and click Load."+"  Due to web browser security features,"+" a mouse or keyboard will likely be necessary.";divFileUpload.appendChild(labelInstructions);var inputFileUpload=document.createElement("input");inputFileUpload.type="file";var divInputFileUpload=document.createElement("div");divInputFileUpload.appendChild(inputFileUpload);divFileUpload.appendChild(divInputFileUpload);var buttonLoad=document.createElement("button");buttonLoad.innerHTML="Load";buttonLoad.onclick=this.buttonLoad_Clicked.bind(this,universe);var buttonCancel=document.createElement("button");buttonCancel.innerHTML="Cancel";buttonCancel.onclick=this.buttonCancel_Clicked.bind(this,universe);var divButtons=document.createElement("div");divButtons.appendChild(buttonLoad);divButtons.appendChild(buttonCancel);divFileUpload.appendChild(divButtons);universe.platformHelper.domElementAdd(divFileUpload);inputFileUpload.focus();this.domElement=divFileUpload;};VenueFileUpload.prototype.updateForTimerTick=function (universe){var inputHelper=universe.inputHelper;var inputsPressed=inputHelper.inputsPressed;for(var i=0;i<inputsPressed.length;i++){var inputPressed=inputsPressed[i];if(inputPressed.isActive==true){var inputToActionMapping=this.inputToActionMappings[inputPressed.name];if(inputToActionMapping!=null){inputPressed.isActive=false;var actionName=inputToActionMapping.actionName;if(actionName=="ControlCancel"){universe.venueNext=this.venueNextIfCancelled;}}}}};VenueFileUpload.prototype.buttonCancel_Clicked=function (universe,event){universe.venueNext=this.venueNextIfCancelled;};VenueFileUpload.prototype.buttonLoad_Clicked=function (universe,event){var inputFileUpload=this.domElement.getElementsByTagName("input")[0];var fileToLoad=inputFileUpload.files[0];if(fileToLoad!=null){universe.venueNext=this.venueNextIfFileSpecified;}};}function CameraTests(){}{CameraTests.prototype.projection=function (){var camera=new Camera(new Coords(100,100,1),100,new Location(new Coords(0,0,-100),new Orientation(new Coords(0,0,1),new Coords(0,1,0))));var worldCoordsGroupToTransform=[new Coords(0,0,0),new Coords(1,0,0),new Coords(0,1,0),new Coords(0,0,1),new Coords(-1,0,0),new Coords(0,-1,0),new Coords(0,0,-1),new Coords(1,2,3),];for(var i=0;i<worldCoordsGroupToTransform.length;i++){var worldCoordsBefore=worldCoordsGroupToTransform[i];var viewCoords=camera.coordsTransformWorldToView(worldCoordsBefore.clone());var worldCoordsAfter=camera.coordsTransformViewToWorld(viewCoords);worldCoordsAfter.round();var areBeforeAndAfterEqual=worldCoordsAfter.equals(worldCoordsBefore);var beforeAndAfterAsStrings="Before:"+worldCoordsBefore.toString()+", After:"+worldCoordsAfter.toString();Test.assertExpectedEqualToActual(true,areBeforeAndAfterEqual,beforeAndAfterAsStrings);}};}function CollisionHelperTests(){this.collisionHelper=new CollisionHelper();}{CollisionHelperTests.prototype.cubesAndSpheres=function (){var collisionHelper=this.collisionHelper;var meshCubeUnitCenteredAtOrigin=Mesh.cubeUnit();var meshCubeUnitInPositiveOctant=Mesh.cubeUnit().transform(new Transform_Translate(new Coords(1,1,1)));var meshCubeUnitInNegativeOctant=Mesh.cubeUnit().transform(new Transform_Translate(new Coords(-1,-1,-1)));var meshCubeUnitRotatedAtOrigin=Mesh.cubeUnit().transform(new Transform_Orient(new Orientation(new Coords(1,1,1).normalize(),new Coords(0,0,1))));var sphereUnitAtOrigin=new Sphere(new Coords(0,0,0),1);var sphereUnitInPositiveOctant=new Sphere(new Coords(1,1,1),1);var collider0=meshCubeUnitCenteredAtOrigin;var collider1=sphereUnitAtOrigin;var doCollide=collisionHelper.doCollidersCollide(collider0,collider1);Test.assertExpectedEqualToActual(true,doCollide);var collider0=meshCubeUnitInPositiveOctant;var collider1=sphereUnitAtOrigin;var doCollide=collisionHelper.doCollidersCollide(collider0,collider1);Test.assertExpectedEqualToActual(true,doCollide);var collider0=meshCubeUnitInNegativeOctant;var collider1=sphereUnitInPositiveOctant;var doCollide=collisionHelper.doCollidersCollide(collider0,collider1);Test.assertExpectedEqualToActual(false,doCollide);};CollisionHelperTests.prototype.edgesAndFaces=function (){var collisionHelper=this.collisionHelper;var edgeZAxisUnit=new Edge([new Coords(0,0,-1),new Coords(0,0,1)]);var edgeZAxisUnitReversed=new Edge([new Coords(0,0,1),new Coords(0,0,-1)]);var edgeZAxis0To1=new Edge([new Coords(0,0,0),new Coords(0,0,1)]);var edgeZAxis0To2=new Edge([new Coords(0,0,0),new Coords(0,0,2)]);var edgeZAxis1To2=new Edge([new Coords(0,0,1),new Coords(0,0,2)]);var edgeZwardUnitAtX2=new Edge([new Coords(2,0,-1),new Coords(2,0,1)]);var faceSquareUnitZwardAtOrigin=new Face([new Coords(-1,-1,0),new Coords(1,-1,0),new Coords(1,1,0),new Coords(-1,1,0)]);var faceSquareUnitZwardAtZ1=new Face([new Coords(-1,-1,1),new Coords(1,-1,1),new Coords(1,1,1),new Coords(-1,1,1)]);var doCollide=collisionHelper.doEdgeAndFaceCollide(edgeZAxisUnit,faceSquareUnitZwardAtOrigin);Test.assertExpectedEqualToActual(true,doCollide);var doCollide=collisionHelper.doEdgeAndFaceCollide(edgeZAxisUnitReversed,faceSquareUnitZwardAtOrigin);Test.assertExpectedEqualToActual(true,doCollide);var doCollide=collisionHelper.doEdgeAndFaceCollide(edgeZAxis0To1,faceSquareUnitZwardAtOrigin);Test.assertExpectedEqualToActual(true,doCollide);var doCollide=collisionHelper.doEdgeAndFaceCollide(edgeZAxis0To2,faceSquareUnitZwardAtOrigin);Test.assertExpectedEqualToActual(true,doCollide);var doCollide=collisionHelper.doEdgeAndFaceCollide(edgeZAxis0To2,faceSquareUnitZwardAtZ1);Test.assertExpectedEqualToActual(true,doCollide);var doCollide=collisionHelper.doEdgeAndFaceCollide(edgeZAxis1To2,faceSquareUnitZwardAtOrigin);Test.assertExpectedEqualToActual(false,doCollide);var doCollide=collisionHelper.doEdgeAndFaceCollide(edgeZwardUnitAtX2,faceSquareUnitZwardAtOrigin);Test.assertExpectedEqualToActual(false,doCollide);var edgeFromWild=new Edge([new Coords(17,164,-1),new Coords(18,169,-1),]);var faceFromWild=new Face([new Coords(10,165,-10),new Coords(70,165,-10),new Coords(70,165,0),new Coords(10,165,0),]);var doCollide=collisionHelper.doEdgeAndFaceCollide(edgeFromWild,faceFromWild);Test.assertExpectedEqualToActual(true,doCollide);var edgeFromWild=new Edge([new Coords(0,231,-1),new Coords(0,225.6,-1),]);var faceFromWild=new Face([new Coords(10,230,-10),new Coords(-10,230,-10),new Coords(-10,230,0),new Coords(10,230,0),]);var doCollide=collisionHelper.doEdgeAndFaceCollide(edgeFromWild,faceFromWild);Test.assertExpectedEqualToActual(true,doCollide);};CollisionHelperTests.prototype.spheresAndShells=function (){var collisionHelper=this.collisionHelper;var sphereUnitAtOrigin=new Sphere(new Coords(0,0,0),1,);var sphereUnitAtX2=new Sphere(new Coords(2,0,0),1,);var shell2To3AtOrigin=new Shell(new Sphere(new Coords(0,0,0),3 ),2 );var doCollide=collisionHelper.doCollidersCollide(sphereUnitAtOrigin,shell2To3AtOrigin);Test.assertExpectedEqualToActual(false,doCollide);doCollide=collisionHelper.doCollidersCollide(sphereUnitAtX2,shell2To3AtOrigin);Test.assertExpectedEqualToActual(true,doCollide);var wedgeHalfTurnFirst=new Wedge(shell2To3AtOrigin.sphereOuter.center,new Coords(1,0,0),.5);doCollide=collisionHelper.doCollidersCollide(sphereUnitAtOrigin,wedgeHalfTurnFirst);Test.assertExpectedEqualToActual(true,doCollide);doCollide=collisionHelper.doCollidersCollide(sphereUnitAtX2,wedgeHalfTurnFirst);Test.assertExpectedEqualToActual(true,doCollide);var arc2To3HalfTurnFirstAtOrigin=new Arc(shell2To3AtOrigin,wedgeHalfTurnFirst);doCollide=collisionHelper.doCollidersCollide(sphereUnitAtOrigin,arc2To3HalfTurnFirstAtOrigin);Test.assertExpectedEqualToActual(false,doCollide);doCollide=collisionHelper.doCollidersCollide(sphereUnitAtX2,arc2To3HalfTurnFirstAtOrigin);Test.assertExpectedEqualToActual(true,doCollide);var wedgeHalfTurnSecond=new Wedge(shell2To3AtOrigin.sphereOuter.center,new Coords(0,1,0),.5);doCollide=collisionHelper.doCollidersCollide(sphereUnitAtOrigin,wedgeHalfTurnSecond);Test.assertExpectedEqualToActual(true,doCollide);doCollide=collisionHelper.doCollidersCollide(sphereUnitAtX2,wedgeHalfTurnSecond);Test.assertExpectedEqualToActual(false,doCollide);var arc2To3HalfTurnSecondAtOrigin=new Arc(shell2To3AtOrigin,wedgeHalfTurnSecond);doCollide=collisionHelper.doCollidersCollide(sphereUnitAtOrigin,arc2To3HalfTurnSecondAtOrigin);Test.assertExpectedEqualToActual(false,doCollide);doCollide=collisionHelper.doCollidersCollide(sphereUnitAtX2,arc2To3HalfTurnSecondAtOrigin);Test.assertExpectedEqualToActual(false,doCollide);};}function Test(){}{Test.assertExpectedEqualToActual=function (expected,actual,message){if(expected!=actual){if(message==null){message="Expected: '"+expected+"', Actual: '"+actual+"'.";}console.log("Error running test: "+message);console.trace();throw message;}};Test.runTestsInFixture=function (testFixture){var testFixtureName=testFixture.constructor.name;for(var testName in testFixture){var testToRun=testFixture[testName];if(testToRun.constructor.name=="Function"){try{testToRun.call(testFixture);}catch (ex){console.log("Test failed: "+testFixtureName+"."+testName+".");throw ex;}}}console.log("All tests in test fixture "+testFixtureName+" passed.");};Test.runTestsInFixtures=function (testFixtures){for(var i=0;i<testFixtures.length;i++){var testFixture=testFixtures[i];Test.runTestsInFixture(testFixture);}};}function DateTime(year,month,day,hours,minutes,seconds){this.year=year;this.month=month;this.day=day;this.hours=hours;this.minutes=minutes;this.seconds=seconds;}{DateTime.fromSystemDate=function (systemDate){var returnValue=new DateTime(systemDate.getFullYear(),systemDate.getMonth()+1,systemDate.getDate(),systemDate.getHours(),systemDate.getMinutes(),systemDate.getSeconds());return returnValue;};DateTime.now=function (){return DateTime.fromSystemDate(new Date());};DateTime.prototype.equals=function (other){var returnValue=(this.year==other.year&&this.month==other.month&&this.day==other.day&&this.hours==other.hours&&this.minutes==other.minutes&&this.seconds==other.seconds);return returnValue;};DateTime.prototype.toStringMMDD_HHMM_SS=function (){var returnValue=""+(""+this.month).padLeft(2,"0")+(""+this.day).padLeft(2,"0")+"-"+(""+this.hours).padLeft(2,"0")+(""+this.minutes).padLeft(2,"0")+"-"+(""+this.seconds).padLeft(2,"0");return returnValue;};DateTime.prototype.toStringTimestamp=function (){var returnValue=""+this.year+"/"+(""+this.month).padLeft(2,"0")+"/"+(""+this.day).padLeft(2,"0")+"-"+(""+this.hours).padLeft(2,"0")+":"+(""+this.minutes).padLeft(2,"0")+":"+(""+this.seconds).padLeft(2,"0");return returnValue;};}function PlatformHelper(){}{PlatformHelper.prototype.domElementAdd=function (domElement){this.divMain.appendChild(domElement);};PlatformHelper.prototype.domElementRemove=function (domElement){this.divMain.removeChild(domElement);};PlatformHelper.prototype.initialize=function (universe){var divMain=this.divMain;if(divMain==null){var divMain=document.createElement("div");divMain.id="divMain";divMain.style.position="absolute";divMain.style.left="50%";divMain.style.top="50%";document.body.appendChild(divMain);this.divMain=divMain;}var display=universe.display;divMain.style.marginLeft=0 -display.sizeInPixels.x/2;divMain.style.marginTop=0 -display.sizeInPixels.y/2;};}function Reference(value){this.value=value;}{Reference.prototype.get=function (){return this.value;};Reference.prototype.set=function (valueToSet){this.value=valueToSet;return this.value;};}function TimerHelper(ticksPerSecond){this.ticksPerSecond=ticksPerSecond;var millisecondsPerSecond=1000;this.millisecondsPerTick=Math.floor(millisecondsPerSecond/this.ticksPerSecond);}{TimerHelper.prototype.initialize=function (handleEventTimerTick){this.timer=setInterval(handleEventTimerTick,this.millisecondsPerTick);};}function URLParser(urlAsString){this.urlAsString=urlAsString;this.queryStringParameters=[];var parametersAsString=this.urlAsString.search.substring(1);var parametersAsStrings=parametersAsString.split("&");for(var i=0;i<parametersAsStrings.length;i++){var parameterAsString=parametersAsStrings[i];var parameterNameAndValue=parameterAsString.split("=");var parameterName=parameterNameAndValue[0];var parameterValue=parameterNameAndValue[1];this.queryStringParameters.push(parameterNameAndValue);this.queryStringParameters[parameterName]=parameterValue;}}{URLParser.fromWindow=function (){return new URLParser(window.location);}}function main(){localStorage.clear();var mediaLibrary=new MediaLibrary([new Image("Title","../Content/Images/Title.png"),],[new Sound("Sound","../Content/Audio/Effects/Sound.wav",false),new Sound("Music","../Content/Audio/Music/Music.mp3",true),],[new Video("Movie","../Content/Video/Movie.webm"),],[new Font("Font","../Content/Fonts/Font.ttf"),],[new TextString("Conversation","../Content/Text/Conversation.json"),new TextString("Instructions","../Content/Text/Instructions.txt"),]);var displaySizeInPixelsDefault=new Coords(400,300,1);var display=new Display([displaySizeInPixelsDefault,displaySizeInPixelsDefault.clone().half(),displaySizeInPixelsDefault.clone().multiplyScalar(2),],"Font",10,"Gray","White");var timerHelper=new TimerHelper(20);var universe=Universe.new ("Cursor_Quest",timerHelper,display,mediaLibrary,null);universe.initialize();}main();</script ></body></html>
